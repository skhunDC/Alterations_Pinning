<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      :root {
        --border-dark: #333333;
        --border-light: #999999;
        --accent: #0d8571;
        --text: #0f172a;
        --muted: #555555;
      }

      @page {
        size: A4 landscape;
        margin: 0;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e5e5e5;
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        color: var(--text);
      }

      .certificate-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
      }

      .certificate {
        width: 90%;
        max-width: 1100px;
        background: #ffffff;
        padding: 2.5rem 3.5rem;
        box-sizing: border-box;
        text-align: center;
        position: relative;
        border: 8px double var(--border-dark);
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
      }

      .certificate::before {
        content: '';
        position: absolute;
        top: 18px;
        left: 18px;
        right: 18px;
        bottom: 18px;
        border: 2px solid var(--border-light);
        pointer-events: none;
      }

      .certificate-logo {
        max-height: 80px;
        margin-bottom: 1rem;
      }

      .certificate-title {
        font-size: 2.2rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 0.5rem;
        color: var(--accent);
      }

      .certificate-subtitle {
        font-size: 1.1rem;
        margin-bottom: 1.8rem;
        color: var(--muted);
      }

      .certificate-label {
        font-size: 1rem;
        margin-bottom: 0.2rem;
        color: #666666;
        letter-spacing: 0.08em;
      }

      .certificate-name {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 1rem;
      }

      .certificate-body-text {
        font-size: 1rem;
        max-width: 800px;
        margin: 0 auto 2rem auto;
        line-height: 1.6;
        color: #333333;
      }

      .certificate-status-row {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }

      .badge {
        display: inline-block;
        padding: 0.55rem 1.2rem;
        border-radius: 999px;
        font-weight: 700;
        border: 1px solid #d1d5db;
        background: #f8fafc;
        color: #0f172a;
      }

      .badge--success {
        background: #e8f8f2;
        color: #0f5132;
        border-color: #b7e4cf;
      }

      .badge--warning {
        background: #fff4e5;
        color: #8a6b00;
        border-color: #facc15;
      }

      .certificate-meta-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .certificate-meta-card {
        border: 1px solid #dcdcdc;
        padding: 0.9rem 1rem;
        border-radius: 8px;
        background: #fafafa;
      }

      .meta-label {
        display: block;
        font-size: 0.9rem;
        color: var(--muted);
        margin-bottom: 0.35rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .meta-value {
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--text);
      }

      .module-list {
        margin: 0 auto 1.2rem auto;
        max-width: 900px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.8rem;
      }

      .module-row {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.85rem 1rem;
        background: #ffffff;
        text-align: left;
      }

      .module-row__title {
        margin: 0 0 0.35rem 0;
        font-weight: 700;
        color: var(--text);
      }

      .module-row__status {
        margin: 0;
        font-weight: 700;
        color: #991b1b;
        font-size: 0.95rem;
      }

      .module-row--pass {
        border-color: #c1f0d4;
        background: #f0fdf4;
      }

      .module-row--pass .module-row__status {
        color: #0f5132;
      }

      .certificate-footer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        font-size: 0.95rem;
        gap: 1.5rem;
      }

      .certificate-footer-block {
        text-align: center;
        flex: 1;
      }

      .certificate-footer-block span.signature-line {
        display: inline-block;
        margin-top: 1.2rem;
        border-top: 1px solid #444444;
        padding-top: 0.2rem;
        min-width: 180px;
      }

      .certificate-date {
        font-size: 0.95rem;
        margin-top: 1rem;
        color: #555555;
      }

      @media print {
        body {
          background: #ffffff;
        }

        .certificate {
          box-shadow: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="certificate-wrapper">
      <div class="certificate">
        <img
          class="certificate-logo"
          src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png"
          alt="Dublin Cleaners logo"
        />
        <div class="certificate-title">Certification of Completion</div>
        <div class="certificate-subtitle">Official Dublin Cleaners Certification</div>
        <div class="certificate-label">This certifies that</div>
        <div id="certificate-employee-name" class="certificate-name">Employee Name</div>
        <p class="certificate-body-text" id="certificate-statement">
          has successfully completed the Dublin Cleaners
          <strong>Alterations Pinning Certification Program</strong>
          and is hereby certified and authorized to pin garments for our customers in-store in accordance with our quality and safety standards.
        </p>
        <div class="certificate-status-row">
          <span class="badge badge--warning" id="certStatus">Certification Pending</span>
          <span class="badge" id="statusText">In Progress</span>
        </div>
        <div class="certificate-meta-row">
          <div class="certificate-meta-card">
            <span class="meta-label">Date</span>
            <span class="meta-value" id="certificate-date"></span>
          </div>
          <div class="certificate-meta-card">
            <span class="meta-label">Location / ID</span>
            <span class="meta-value" id="locationField">—</span>
          </div>
        </div>
        <div class="module-list" id="moduleList"></div>
        <div class="certificate-footer-row">
          <div class="certificate-footer-block">
            <span class="signature-line">Authorized Trainer</span>
          </div>
          <div class="certificate-footer-block">
            Dublin Cleaners<br />
            Official Training &amp; Certification
          </div>
          <div class="certificate-footer-block">
            <span class="signature-line">Store / Location</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const employeeName = (params.get('name') || '').trim() || 'Employee';
      const location = (params.get('location') || '').trim();
      const moduleTitles = {
        M1: 'Customer Instruction & Measurement Philosophy',
        M2: 'Pinning Tools & Safety',
        M3: 'Pinning by Garment Type',
        M4: 'SPOT POS Notes & Communication',
        M5: 'Exceptions & Escalation'
      };
      const moduleOrder = ['M1', 'M2', 'M3', 'M4', 'M5'];
      const statusBadge = document.getElementById('certStatus');
      const statusText = document.getElementById('statusText');
      const moduleList = document.getElementById('moduleList');

      document.getElementById('certificate-employee-name').textContent = employeeName;
      document.getElementById('certificate-statement').innerHTML = `${employeeName} has successfully completed the Dublin Cleaners <strong>Alterations Pinning Certification Program</strong> and is hereby certified and authorized to pin garments for our customers in-store in accordance with our quality and safety standards.`;
      document.getElementById('certificate-date').textContent = `Date: ${new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric', year: 'numeric' }).format(new Date())}`;
      document.getElementById('locationField').textContent = location || '—';

      function moduleRow(id, passed) {
        const className = `module-row ${passed ? 'module-row--pass' : ''}`;
        const status = passed ? 'Passed' : 'Pending';
        return `<div class="${className}">
          <p class="module-row__title">${id} — ${moduleTitles[id] || ''}</p>
          <p class="module-row__status">${status}</p>
        </div>`;
      }

      function renderModules(status) {
        const completed = status?.completedModules || [];
        moduleList.innerHTML = moduleOrder.map(id => moduleRow(id, completed.includes(id))).join('');
      }

      function renderStatus(status) {
        const certified = !!status?.isCertified;
        statusBadge.textContent = certified ? 'Certified Alteration Pinner' : 'Certification Pending';
        statusBadge.classList.toggle('badge--success', certified);
        statusBadge.classList.toggle('badge--warning', !certified);
        statusText.textContent = certified ? 'Certified' : 'In Progress';
        renderModules(status);
      }

      function triggerPrint() {
        if (triggerPrint.hasRun) return;
        triggerPrint.hasRun = true;
        setTimeout(() => window.print(), 200);
      }

      const fallbackTimer = setTimeout(triggerPrint, 1400);

      if (google.script && google.script.run && employeeName.trim()) {
        google.script.run
          .withSuccessHandler(status => {
            clearTimeout(fallbackTimer);
            if (status) {
              renderStatus(status);
            } else {
              renderModules();
            }
            triggerPrint();
          })
          .withFailureHandler(() => {
            renderModules();
            triggerPrint();
          })
          .getEmployeeCertificationStatus(employeeName);
      } else {
        renderModules();
        triggerPrint();
      }
    </script>
  </body>
</html>
