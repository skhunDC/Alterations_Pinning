<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      :root {
        --border-dark: #333333;
        --border-light: #999999;
        --accent: #0d8571;
        --text: #0f172a;
        --muted: #555555;
      }

      @page {
        size: A4 portrait;
        margin: 0;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e5e5e5;
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        color: var(--text);
        min-height: 100vh;
      }

      .certificate-wrapper {
        width: 100%;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        page-break-inside: avoid;
        break-inside: avoid;
      }

      .certificate {
        width: 210mm;
        height: 297mm;
        background: #ffffff;
        padding: 2.25rem 2.75rem;
        box-sizing: border-box;
        text-align: center;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        page-break-inside: avoid;
        break-inside: avoid;
        page-break-after: avoid;
        page-break-before: avoid;
      }

      .certificate-decor {
        position: relative;
        width: calc(100% + 5.5rem);
        margin-left: -2.75rem;
        height: 120px;
        background-image: url('https://www.dublincleaners.com/wp-content/uploads/2025/12/1Border.png');
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        flex-shrink: 0;
      }

      .certificate-decor--bottom {
        transform: scaleY(-1);
        margin-top: auto;
      }

      .certificate-content {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.55rem;
        flex: 1;
        max-width: 850px;
        margin: 0 auto;
        text-align: center;
      }

      .certificate-logo {
        width: 170px;
        max-width: 75%;
        height: auto;
        max-height: 90px;
        margin-top: 0.4rem;
        opacity: 0.92;
      }

      .certificate-title {
        font-size: 2.2rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 0.35rem;
        color: var(--accent);
      }

      .certificate-subtitle {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0.4rem;
        color: var(--text);
      }

      .certificate-label {
        font-size: 1rem;
        margin-bottom: 0.2rem;
        color: #666666;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .certificate-name {
        font-size: 1.9rem;
        font-weight: 700;
        margin-bottom: 1rem;
      }

      .certificate-body-text {
        font-size: 1rem;
        max-width: 680px;
        margin: 0 auto 0.75rem auto;
        line-height: 1.6;
        color: #333333;
      }

      .certificate-status-row {
        display: flex;
        gap: 0.6rem;
        justify-content: center;
        margin: 0 0 1rem 0;
        flex-wrap: wrap;
      }

      .badge {
        display: inline-block;
        padding: 0.55rem 1.2rem;
        border-radius: 999px;
        font-weight: 700;
        border: 1px solid #d1d5db;
        background: #f8fafc;
        color: #0f172a;
      }

      .badge--success {
        background: #e8f8f2;
        color: #0f5132;
        border-color: #b7e4cf;
      }

      .badge--warning {
        background: #fff4e5;
        color: #8a6b00;
        border-color: #facc15;
      }

      .certificate-meta-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
        margin: 0 auto 1.1rem auto;
        max-width: 900px;
      }

      .certificate-meta-card {
        border: 1px solid #dcdcdc;
        padding: 0.9rem 1rem;
        border-radius: 8px;
        background: #fafafa;
      }

      .meta-label {
        display: block;
        font-size: 0.9rem;
        color: var(--muted);
        margin-bottom: 0.35rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .meta-value {
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--text);
      }

      .module-list {
        margin: 0 auto 1.2rem auto;
        max-width: 900px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.8rem;
      }

      .module-row {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.85rem 1rem;
        background: #ffffff;
        text-align: left;
      }

      .module-row__title {
        margin: 0;
        font-weight: 700;
        color: var(--text);
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
        align-items: baseline;
      }

      .module-row__status {
        margin: 0;
        font-weight: 700;
        font-size: 0.95rem;
        color: #0f5132;
      }

      .module-row__status--pending {
        color: #8a6b00;
      }

      .module-row--pass {
        border-color: #c1f0d4;
        background: #f0fdf4;
      }

      .module-row--pass .module-row__status {
        color: #0f5132;
      }

      .certificate-footer-row {
        margin-top: 1rem;
        padding-top: 1.25rem;
        font-size: 0.95rem;
        page-break-inside: avoid;
        break-inside: avoid;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
        align-items: start;
      }

      .certificate-footer-block {
        text-align: center;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.9rem 1rem 1.1rem;
      }

      .certificate-footer-block .signature-line {
        display: block;
        margin-top: 0.6rem;
        border-top: 1px solid #444444;
        padding-top: 0.35rem;
        min-width: 280px;
        width: 100%;
      }

      .certificate-footer-block .signature-text-area {
        margin-top: 0.6rem;
        border: 1px dashed #9ca3af;
        border-radius: 8px;
        padding: 0.5rem 0.65rem;
        min-height: 64px;
        background: #ffffff;
        color: #374151;
        text-align: left;
        line-height: 1.4;
      }

      .certificate-footer-block .footer-label {
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #1f2937;
      }

      @media print {
        body {
          background: #ffffff;
        }

        .certificate {
          box-shadow: none;
          height: 100vh;
          width: 100%;
        }

        .certificate-wrapper {
          height: auto;
          min-height: 100vh;
          padding: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="certificate-wrapper">
      <div class="certificate">
        <div class="certificate-decor"></div>
        <div class="certificate-content">
          <div class="certificate-title">Alterations Pinning Certification</div>
          <div class="certificate-subtitle">Certification of Completion</div>
          <div class="certificate-label">Awarded to</div>
          <div id="certificate-employee-name" class="certificate-name">Employee Name</div>
          <p class="certificate-body-text" id="certificate-statement">
            has completed the Official Dublin Cleaners <strong>Alterations Pinning Certification Program</strong> and is certified
            to pin garments.
          </p>
          <img
            class="certificate-logo"
            src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png"
            alt="Dublin Cleaners logo"
          />
          <div class="certificate-status-row">
            <span class="badge badge--warning" id="certStatus">Certification Pending</span>
            <span class="badge" id="statusText">In Progress</span>
          </div>
          <div class="certificate-meta-row">
            <div class="certificate-meta-card">
              <span class="meta-label">Issued On</span>
              <span class="meta-value" id="certificate-date"></span>
            </div>
            <div class="certificate-meta-card">
              <span class="meta-label">Location / ID</span>
              <span class="meta-value" id="locationField">—</span>
            </div>
            <div class="certificate-meta-card">
              <span class="meta-label">Status</span>
              <span class="meta-value" id="statusValue">—</span>
            </div>
          </div>
          <div class="module-list" id="moduleList"></div>
        </div>
        <div class="certificate-footer-row">
          <div class="certificate-footer-block">
            <div class="footer-label">Supervisor sign-off (required)</div>
            <span class="signature-line" aria-label="Supervisor signature line">&nbsp;</span>
          </div>
          <div class="certificate-footer-block">
            <div class="footer-label">Manager signature</div>
            <span class="signature-line" aria-label="Manager signature line">&nbsp;</span>
            <div class="signature-text-area" aria-label="Manager notes area">
              Manager name, title, and comments
            </div>
          </div>
        </div>
        <div class="certificate-decor certificate-decor--bottom"></div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const employeeName = (params.get('name') || '').trim() || 'Employee';
      const location = (params.get('location') || '').trim();
      const moduleTitles = {
        M1: 'Customer Instruction & Measurement Philosophy',
        M2: 'Pinning Tools & Safety',
        M3: 'Pinning by Garment Type',
        M4: 'SPOT POS Notes & Communication',
        M5: 'Exceptions & Escalation'
      };
      const moduleOrder = ['M1', 'M2', 'M3', 'M4', 'M5'];
      const statusBadge = document.getElementById('certStatus');
      const statusText = document.getElementById('statusText');
      const moduleList = document.getElementById('moduleList');
      const statusValue = document.getElementById('statusValue');

      document.getElementById('certificate-employee-name').textContent = employeeName;
      document.getElementById('certificate-statement').innerHTML = `${employeeName} has completed the Official Dublin Cleaners <strong>Alterations Pinning Certification Program</strong> and is certified to pin garments.`;
      document.getElementById('certificate-date').textContent = `${new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric', year: 'numeric' }).format(new Date())}`;
      document.getElementById('locationField').textContent = location || '—';

      function moduleRow(id, passed) {
        const className = `module-row ${passed ? 'module-row--pass' : ''}`;
        const status = passed ? 'Passed' : 'Pending';
        const statusClass = passed ? 'module-row__status' : 'module-row__status module-row__status--pending';
        return `<div class="${className}">
          <p class="module-row__title">${id} — ${moduleTitles[id] || ''} <span class="${statusClass}">(${status})</span></p>
        </div>`;
      }

      function renderModules(status) {
        const completed = status?.completedModules || [];
        moduleList.innerHTML = moduleOrder.map(id => moduleRow(id, completed.includes(id))).join('');
      }

      function renderStatus(status) {
        const certified = !!status?.isCertified;
        statusBadge.textContent = certified ? 'Certified' : 'Certification Pending';
        statusBadge.classList.toggle('badge--success', certified);
        statusBadge.classList.toggle('badge--warning', !certified);
        statusText.textContent = certified ? 'Certified' : 'In Progress';
        statusValue.textContent = certified ? 'Certified' : 'In Progress';
        renderModules(status);
      }

      function triggerPrint() {
        if (triggerPrint.hasRun) return;
        triggerPrint.hasRun = true;
        setTimeout(() => window.print(), 200);
      }

      const fallbackTimer = setTimeout(triggerPrint, 1400);

      if (google.script && google.script.run && employeeName.trim()) {
        google.script.run
          .withSuccessHandler(status => {
            clearTimeout(fallbackTimer);
            if (status) {
              renderStatus(status);
            } else {
              renderModules();
            }
            triggerPrint();
          })
          .withFailureHandler(() => {
            renderModules();
            triggerPrint();
          })
          .getEmployeeCertificationStatus(employeeName);
      } else {
        renderModules();
        triggerPrint();
      }
    </script>
  </body>
</html>
