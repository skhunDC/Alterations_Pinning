<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      :root {
        --green: #0d8571;
        --gold: #c79d2f;
        --ink: #0f172a;
        --muted: #475569;
        --border: #e2e8f0;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        background: #eef2f7;
        color: var(--ink);
        padding: 32px 12px;
      }

      .print-page {
        max-width: 960px;
        margin: 0 auto;
      }

      .certificate {
        background: #fff;
        border-radius: 18px;
        padding: 32px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border);
      }

      .certificate__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        padding-bottom: 18px;
        border-bottom: 2px solid var(--border);
      }

      .brand-block { display: flex; align-items: center; gap: 12px; }
      .brand-block img { height: 90px; width: auto; }

      .program-meta { text-align: right; }
      .program-label {
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 0.9rem;
        color: var(--muted);
      }

      h1 { margin: 6px 0 0 0; color: var(--green); }
      .badge {
        display: inline-block;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 800;
        border: 1px solid var(--border);
        color: var(--ink);
        background: #f8fafc;
      }
      .badge--success { background: #e8f8f2; color: #0f5132; border-color: #b7e4cf; }
      .badge--warning { background: #fff4e5; color: #8a6b00; border-color: #facc15; }

      .certificate__body { padding: 18px 0 12px 0; text-align: center; }
      .recipient { font-size: 1.8rem; margin: 10px 0 6px 0; font-weight: 800; color: #0f172a; }
      .cert-statement { font-size: 1.05rem; margin: 10px auto; max-width: 760px; color: #1f2933; }

      .meta-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin: 18px 0;
        text-align: left;
      }
      .meta-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #f8fafc;
      }
      .meta-label { display: block; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
      .meta-value { font-weight: 800; font-size: 1.05rem; color: var(--ink); }

      .module-list { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px; }
      .module-row {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fdfdfd;
        text-align: left;
      }
      .module-row__title { margin: 2px 0 6px 0; font-weight: 800; color: #0f172a; }
      .module-row__status { margin: 0; font-weight: 700; color: #991b1b; }
      .module-row--pass { border-color: #c1f0d4; background: #f0fdf4; }
      .module-row--pass .module-row__status { color: #0f5132; }

      .certificate__footer { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 14px; text-align: center; }
      .footer-note { margin: 8px 0; color: var(--muted); font-weight: 600; }
      .signature-line { margin: 16px auto 0 auto; max-width: 460px; border-top: 1px dashed var(--border); padding-top: 8px; color: var(--muted); }

      @media print {
        body { background: #fff; padding: 0; }
        .certificate { box-shadow: none; border-color: #d9e2ec; }
      }
    </style>
  </head>
  <body>
    <div class="print-page">
      <div class="certificate">
        <header class="certificate__header">
          <div class="brand-block">
            <img src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png" alt="Dublin Cleaners logo" />
            <div>
              <p class="program-label">Alterations Pinning Certification Program</p>
              <p class="badge badge--warning" id="certStatus">Certification Pending</p>
            </div>
          </div>
          <div class="program-meta">
            <h1>Certification of Completion</h1>
          </div>
        </header>

        <main class="certificate__body">
          <p class="recipient" id="certificate-name">Employee Name</p>
          <p class="cert-statement" id="certificate-statement"></p>
          <div class="meta-row">
            <div class="meta-card">
              <span class="meta-label">Date</span>
              <span class="meta-value" id="dateField"></span>
            </div>
            <div class="meta-card">
              <span class="meta-label">Location / ID</span>
              <span class="meta-value" id="locationField">—</span>
            </div>
            <div class="meta-card">
              <span class="meta-label">Status</span>
              <span class="meta-value" id="statusText">Certification Pending</span>
            </div>
          </div>
          <div class="module-list" id="moduleList"></div>
        </main>

        <footer class="certificate__footer">
          <p class="footer-note">Certified to pin garments for customers in-store upon successful completion of all modules.</p>
          <div class="signature-line">Supervisor sign-off (if required): ________________________________</div>
        </footer>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const employeeName = (params.get('name') || '').trim() || 'Employee';
      const location = (params.get('location') || '').trim();
      const moduleTitles = {
        M1: 'Customer Instruction & Measurement Philosophy',
        M2: 'Pinning Tools & Safety',
        M3: 'Pinning by Garment Type',
        M4: 'SPOT POS Notes & Communication',
        M5: 'Exceptions & Escalation'
      };
      const moduleOrder = ['M1', 'M2', 'M3', 'M4', 'M5'];
      const statusBadge = document.getElementById('certStatus');
      const statusText = document.getElementById('statusText');
      const moduleList = document.getElementById('moduleList');

      document.getElementById('certificate-name').textContent = employeeName;
      document.getElementById('certificate-statement').textContent = `${employeeName} has completed the Dublin Cleaners Alterations Pinning Certification Program and is certified to pin garments for customers in-store.`;
      document.getElementById('dateField').textContent = new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric', year: 'numeric' }).format(new Date());
      document.getElementById('locationField').textContent = location || '—';

      function moduleRow(id, passed) {
        const className = `module-row ${passed ? 'module-row--pass' : ''}`;
        const status = passed ? 'Passed' : 'Pending';
        return `<div class="${className}">
          <p class="module-row__title">${id} — ${moduleTitles[id] || ''}</p>
          <p class="module-row__status">${status}</p>
        </div>`;
      }

      function renderModules(status) {
        const completed = status?.completedModules || [];
        moduleList.innerHTML = moduleOrder.map(id => moduleRow(id, completed.includes(id))).join('');
      }

      function renderStatus(status) {
        const certified = !!status?.isCertified;
        statusBadge.textContent = certified ? 'Certified Alteration Pinner' : 'Certification Pending';
        statusBadge.classList.toggle('badge--success', certified);
        statusBadge.classList.toggle('badge--warning', !certified);
        statusText.textContent = certified ? 'Certified' : 'In Progress';
        renderModules(status);
      }

      function triggerPrint() {
        if (triggerPrint.hasRun) return;
        triggerPrint.hasRun = true;
        setTimeout(() => window.print(), 200);
      }

      const fallbackTimer = setTimeout(triggerPrint, 1400);

      if (google.script && google.script.run && employeeName.trim()) {
        google.script.run
          .withSuccessHandler(status => {
            clearTimeout(fallbackTimer);
            if (status) {
              renderStatus(status);
            } else {
              renderModules();
            }
            triggerPrint();
          })
          .withFailureHandler(() => {
            renderModules();
            triggerPrint();
          })
          .getEmployeeCertificationStatus(employeeName);
      } else {
        renderModules();
        triggerPrint();
      }
    </script>
  </body>
</html>
