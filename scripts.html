<script>
  const modules = [
    {
      id: 'M1',
      title: 'Customer Instruction & Measurement Philosophy',
      intro: 'Shift every conversation from ‚Äúa bit‚Äù or ‚Äú2 inches‚Äù to precise, final measurements that tailors can trust.',
      objectives: [
        'Explain subjective vs. objective alteration language.',
        'Avoid +/- shorthand and capture the final measurement instead.',
        'Use phrases like ‚ÄúINSEAM 32‚Äù or ‚ÄúShorten inseam to 30 inches.‚Äù',
        'Describe ‚Äúhem‚Äù correctly as the folded, sewn edge‚Äînot a verb or a measurement.',
        'Spot and rewrite vague notes into clear instructions that prevent complaints.',
        'Model confirmation scripts so customers agree to the recorded measurement.'
      ],
      vocabulary: {
        subjective: [
          'Shorten a bit',
          'Take in a little',
          'Fix the hem',
          'Make it tighter'
        ],
        objective: [
          'Shorten inseam to 30 inches',
          'Take in waist to 34 inches',
          'Shorten sleeves to 23 inches from shoulder seam',
          'Finished hem should measure 30 inches inseam'
        ]
      },
      measurementRules: [
        {
          title: 'No Plus/Minus Shorthand',
          details: '‚Äú-2 inches‚Äù or ‚Äú+1 inch‚Äù only describe the change. Tailors need the final number: ‚ÄúShorten hem to 36 inches from floor.‚Äù'
        },
        {
          title: 'Final Measurement Language',
          details: 'Record what the customer wants to end up with. Example: ‚ÄúTake in waist to 36 inches‚Äù instead of ‚ÄúTake in 2 inches.‚Äù'
        },
        {
          title: 'Standard Format',
          details: 'Use clear formats that travel well: ‚ÄúINSEAM 32,‚Äù ‚ÄúOUTSEAM 40,‚Äù ‚ÄúWAIST 36.‚Äù'
        }
      ],
      hemCallout: {
        heading: '‚ÄúHem‚Äù means the finished edge',
        points: [
          'It is a part of the garment, not a measurement.',
          'Wrong: ‚ÄúHem pants,‚Äù ‚ÄúHem 2 inches.‚Äù',
          'Right: ‚ÄúShorten pants so finished hem is 30 inches inseam.‚Äù'
        ]
      },
      complaintScenarios: [
        {
          bad: '‚ÄúHem pants.‚Äù',
          result: 'Pants end up shorter than the customer expected; tailor guessed the target length.',
          fix: '‚ÄúShorten inseam to 30 inches; customer wearing normal shoes.‚Äù'
        },
        {
          bad: '‚Äú-2 inches from existing hem.‚Äù',
          result: 'Two staff members measure differently; finished length is uneven.',
          fix: '‚ÄúFinished hem 36 inches from the floor; measure with customer standing straight.‚Äù'
        },
        {
          bad: '‚ÄúTake in waist a little.‚Äù',
          result: 'Waist too tight; customer cannot button comfortably.',
          fix: '‚ÄúTake in waist to 34 inches; confirm comfortable when seated.‚Äù'
        }
      ],
      practicePrompts: [
        {
          bad: '‚ÄúShorten a bit.‚Äù',
          placeholder: 'Rewrite with a final inseam measurement‚Ä¶',
          example: '‚ÄúShorten inseam to 29 inches; balanced on both legs.‚Äù'
        },
        {
          bad: '‚ÄúHem 2 inches.‚Äù',
          placeholder: 'State the final length instead of the change‚Ä¶',
          example: '‚ÄúFinished hem 37 inches from floor with dress shoes.‚Äù'
        },
        {
          bad: '‚ÄúTake in 2 inches.‚Äù',
          placeholder: 'Record the target waist size‚Ä¶',
          example: '‚ÄúTake in waist to 36 inches; customer can sit comfortably.‚Äù'
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which is an objective alteration note?', options: [
          { label: 'Hem 2 inches', correct: false },
          { label: 'Shorten inseam to 30 inches', correct: true },
          { label: 'Make it tighter', correct: false }
        ]},
        { type: 'tf', question: '‚ÄúHem 2 inches‚Äù is a clear, objective instruction.', answer: false },
        { type: 'mcq', question: 'Why do we avoid +/- shorthand like ‚Äú-2‚Äù?', options: [
          { label: 'Tailors enjoy guessing the final length', correct: false },
          { label: 'It hides the final measurement the tailor must sew to', correct: true },
          { label: 'It is harder to type', correct: false }
        ]},
        { type: 'mcq', question: 'Correct meaning of ‚Äúhem‚Äù:', options: [
          { label: 'A verb meaning shorten', correct: false },
          { label: 'The folded and sewn edge of the garment', correct: true },
          { label: 'Any measurement on pants', correct: false }
        ]},
        { type: 'short', question: 'Rewrite ‚ÄúTake in 2 inches‚Äù as a final measurement.', answers: ['take in waist to', 'waist to', 'take waist to'] }
      ]
    },
    {
      id: 'M2',
      title: 'Pinning Tools & Safety',
      intro: 'Choose the right pins, lock them safely, and orient them horizontally so garments arrive at the plant without risk.',
      objectives: [
        'Identify and describe straight pins vs. safety pins.',
        'State why safety pins are required for garments traveling to the plant.',
        'Demonstrate correct horizontal pin orientation for hems and seams.',
        'Explain why vertical pinning is not acceptable for alteration pinning.',
        'Apply the pin safety checklist to protect customers, staff, and equipment.',
        'Complete a pre-plant checklist to confirm safe, accurate pinning.'
      ],
      pinTypes: [
        {
          name: 'Straight pins',
          description: 'Simple needle with a colored head at one end; open and sharp at the other.',
          useCases: [
            'On-the-spot fitting while the customer is present.',
            'Quick, temporary holds when you are watching and can remove immediately.',
            'Not safe for garments traveling through bags, racks, and plant equipment.'
          ],
          caution: 'Never send straight pins to the plant. Replace them with closed safety pins before the garment leaves the store.'
        },
        {
          name: 'Safety pins',
          description: 'Pin with a clasp that closes and covers the sharp point when locked.',
          useCases: [
            'Required for any garment leaving the store and going to the plant.',
            'Locks closed so pins cannot fall out or snag machinery.',
            'Best for secure travel in garment bags and racks.'
          ],
          caution: 'Always lock the clasp and place pins horizontally at the measurement line.'
        }
      ],
      policy: {
        headline: 'Non-Negotiable: Safety Pins for Plant-Bound Garments',
        rules: [
          'Any garment traveling to the plant must be secured with closed safety pins.',
          'Prevents loose pins from injuring staff, customers, or tailors.',
          'Protects plant equipment and other garments from snags or jams.',
          'Confirms a stable, readable reference line for the tailor.'
        ],
        note: 'Always warn the customer where pins are placed before they leave, even when using safety pins.'
      },
      orientation: {
        correct: {
          title: 'Horizontal Pinning (Correct)',
          bullets: [
            'Pins run parallel to the floor/hem line and create a clear reference for tailors.',
            'Holds fabric securely during handling and transport.',
            'Maintains the requested length if the garment shifts in the bag.'
          ],
          description: 'Imagine the hem as a line. The pin should lie along that line, like a rail on the hem.'
        },
        incorrect: {
          title: 'Vertical Pinning (Incorrect)',
          bullets: [
            'Pins sit like a fence post crossing the hem and can distort the line.',
            'More likely to slip or change the marked length.',
            'Harder for tailors to read consistently and unsafe for travel.'
          ],
          description: 'Vertical pins cross the hem like a nail; they bend fabric and do not survive transit.'
        }
      },
      safetyChecklist: [
        'Keep sharp points away from skin; never pin through skin or too close to the body.',
        'Confirm pins are horizontal and, if safety pins, fully closed.',
        'Inform the customer where pins are placed before they leave.',
        'Count pins so none are left loose in bags or garments.',
        'Replace any straight pins with safety pins before the garment goes to the plant.'
      ],
      scenarios: [
        {
          prompt: 'You pinned pants for hemming and the customer is leaving them for cleaning and alterations. What type of pin should be in the garment before it goes to the plant?',
          answer: 'Closed safety pins placed horizontally at the new hem line.'
        },
        {
          prompt: 'You quickly pinned a hem while the customer stood on the platform using straight pins. Before sending to the plant, what must you do?',
          answer: 'Replace straight pins with closed safety pins and double-check horizontal orientation.'
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which pin must be used for any garment traveling to the plant?', options: [
          { label: 'Straight dressmaker pin', correct: false },
          { label: 'Safety pin that is closed', correct: true },
          { label: 'No pins‚Äîjust fold the fabric', correct: false }
        ]},
        { type: 'mcq', question: 'Why is vertical pinning not acceptable?', options: [
          { label: 'It looks nicer in photos', correct: false },
          { label: 'It distorts hems and can slip, changing the length', correct: true },
          { label: 'It uses fewer pins', correct: false }
        ]},
        { type: 'mcq', question: 'What orientation should safety pins have on a hem?', options: [
          { label: 'Horizontal, parallel to the floor', correct: true },
          { label: 'Vertical like a nail', correct: false },
          { label: 'Diagonal to save time', correct: false }
        ]},
        { type: 'mcq', question: 'Before sending a garment to the plant you must‚Ä¶', options: [
          { label: 'Confirm pins are closed, horizontal, and counted', correct: true },
          { label: 'Switch to vertical pins to speed up', correct: false },
          { label: 'Skip telling the customer about the pins', correct: false }
        ]},
        { type: 'short', question: 'Name one step from the pin safety checklist.', answers: ['count pins', 'check pin count', 'avoid sharp ends sticking out', 'do not pin through skin', 'keep sharp points away from skin', 'confirm pins are closed', 'inform the customer where pins are placed', 'replace straight pins with safety pins'] }
      ]
    },
    {
      id: 'M3',
      title: 'Pinning by Garment Type',
      intro: 'Apply garment-specific pinning with smooth fabric, balanced measurements, and verified customer pins.',
      objectives: [
        'Smooth fabric before measuring‚Äînever stretch.',
        'Ask handedness to balance men‚Äôs inseams.',
        'Verify customer-pinned garments with a tape measure and record objective numbers.',
        'Enforce one patch per garment and pin placement clarity.'
      ],
      sections: [
        {
          title: 'Garment Guidance',
          bullets: [
            'Pants: smooth both legs, measure inseam, pin horizontally at hem and knee if needed.',
            'Skirts/Dresses: check hang, pin hem evenly, avoid pulling bias fabrics.',
            'Jackets: pin sleeve length at wrist bone; note lining if present.'
          ]
        },
        {
          title: 'Customer Fit & Patches',
          bullets: [
            'Ask ‚ÄúAre you left- or right-handed? This helps us balance your inseam.‚Äù',
            'If customer pins at home: bring tape measure, verify final length, repin with safety pins.',
            'Patch protocol: pin each patch to its garment; never bulk-send loose patches.'
          ]
        },
        {
          title: 'Visual Description',
          bullets: [
            'Side-by-side: smoothed pant leg with horizontal pins vs. stretched fabric with diagonal pins.',
            'Patch placement card taped to garment with arrow to pinned patch location.'
          ]
        }
      ],
      quiz: [
        { type: 'mcq', question: 'What must you do with a customer-pinned garment?', options: [
          { label: 'Trust the pinning and skip measuring', correct: false },
          { label: 'Verify with a tape measure and note final length', correct: true },
          { label: 'Remove all pins and guess', correct: false }
        ]},
        { type: 'mcq', question: 'How do you balance inseams for men?', options: [
          { label: 'Ask handedness and measure both sides', correct: true },
          { label: 'Pin only the right leg', correct: false },
          { label: 'Use vertical pins on the long leg', correct: false }
        ]},
        { type: 'tf', question: 'Stretching fabric while measuring improves accuracy.', answer: false },
        { type: 'mcq', question: 'Patch handling rule:', options: [
          { label: 'Send patches loose; tailor will sort', correct: false },
          { label: 'Pin each patch to its correct garment', correct: true },
          { label: 'Tape all patches together', correct: false }
        ]},
        { type: 'short', question: 'Where should pins sit on hems?', answers: ['horizontally', 'horizontal', 'parallel to the floor'] }
      ]
    },
    {
      id: 'M4',
      title: 'SPOT POS Notes & Communication',
      intro: 'Document clear alteration notes in SPOT and confirm them with customers.',
      objectives: [
        'Log final measurements, not vague verbs.',
        'Avoid misusing ‚Äúhem‚Äù as a measurement term.',
        'Use confirmation scripts to align expectations.'
      ],
      sections: [
        {
          title: 'SPOT Input Examples',
          bullets: [
            '‚úÖ ‚ÄúShorten inseam to 30 inches.‚Äù',
            '‚úÖ ‚ÄúTake in waist to 34 inches.‚Äù',
            '‚ùå ‚ÄúHem pants.‚Äù  ‚ùå ‚ÄúTake in 2 inches.‚Äù'
          ]
        },
        {
          title: 'Communication Scripts',
          bullets: [
            '‚ÄúTo make sure we get this right, I‚Äôm writing ‚Äòshorten inseam to 30 inches.‚Äô Does that match what you expect?‚Äù',
            '‚ÄúBecause hem is the finished edge, I‚Äôll note the final length instead.‚Äù',
            'Text mockup: SPOT note field showing garment part, final measurement, and safety pin confirmation.'
          ]
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which SPOT note is correct?', options: [
          { label: 'Hem pants', correct: false },
          { label: 'Shorten inseam to 30 inches, safety pinned', correct: true },
          { label: 'Take in 2 inches', correct: false }
        ]},
        { type: 'tf', question: '‚ÄúHem to 36 inches‚Äù is acceptable SPOT language.', answer: false },
        { type: 'mcq', question: 'Best rewrite for ‚Äútake in a bit‚Äù?', options: [
          { label: 'Take in waist to 34 inches', correct: true },
          { label: 'Take in slightly', correct: false },
          { label: 'Adjust if needed', correct: false }
        ]},
        { type: 'short', question: 'What must every note include?', answers: ['final measurement', 'objective measurement', 'final measurement in inches'] },
        { type: 'mcq', question: 'Why avoid using ‚Äúhem‚Äù as a verb?', options: [
          { label: 'It confuses the final measurement', correct: true },
          { label: 'Customers dislike the word', correct: false },
          { label: 'It takes too long to type', correct: false }
        ]}
      ]
    },
    {
      id: 'M5',
      title: 'Exceptions & Escalation',
      intro: 'Recognize tailor-only garments and escalate with respectful, confident language.',
      objectives: [
        'Spot garments CSRs should not pin (delicate, complex, high-risk items).',
        'Use escalation scripts that reassure customers.',
        'Keep patches and special items paired to the correct garment.'
      ],
      sections: [
        {
          title: 'Tailor-Only List',
          bullets: [
            'Extremely delicate fabrics or intricate beading.',
            'Complex gowns or wedding dresses.',
            'Expensive specialty items with high risk.'
          ]
        },
        {
          title: 'Escalation Scripts',
          bullets: [
            '‚ÄúThis type of garment is handled directly by our tailor to ensure the best result. I‚Äôll note your request and have them review it.‚Äù',
            '‚ÄúBecause of the beading/lace, our tailor will determine the safest way to pin and sew this area.‚Äù',
            'Visual description: two-column card showing CSR-safe garments vs. tailor-only garments.'
          ]
        },
        {
          title: 'Customer-Pinned Protocol',
          bullets: [
            'Do not alter customer pinning without consultation when item is high-risk.',
            'If unsure, escalate to tailor and log the request clearly.',
            'One patch per garment; escalate if multiple complex patches are requested.'
          ]
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which garment should you NOT pin as a CSR?', options: [
          { label: 'Standard cotton chinos', correct: false },
          { label: 'Intricate beaded gown', correct: true },
          { label: 'Uniform pants', correct: false }
        ]},
        { type: 'mcq', question: 'Best escalation phrase:', options: [
          { label: 'We can‚Äôt do this.', correct: false },
          { label: 'This needs a tailor fitting; let‚Äôs book a time to get it right.', correct: true },
          { label: 'Maybe we try it anyway.', correct: false }
        ]},
        { type: 'tf', question: 'It is okay to pin an intricate beaded gown if you feel confident.', answer: false },
        { type: 'short', question: 'How should patches be handled?', answers: ['pin each patch to its garment', 'one patch per garment', 'pin patch to garment'] },
        { type: 'mcq', question: 'When in doubt about scope, you should‚Ä¶', options: [
          { label: 'Proceed quickly', correct: false },
          { label: 'Escalate to a tailor and document clearly', correct: true },
          { label: 'Ignore the concern', correct: false }
        ]}
      ]
    }
  ];

  document.addEventListener('DOMContentLoaded', () => {
    renderNavigation();
    renderModules();
    loadCertificationStatus();
  });

  function getEmployeeName() {
    return document.getElementById('employeeName').value.trim();
  }

  function getEmployeeLocation() {
    return document.getElementById('employeeLocation').value.trim();
  }

  function renderNavigation() {
    const navList = document.getElementById('navList');
    navList.innerHTML = modules.map(module => `<li><button onclick="scrollToModule('${module.id}')">${module.id} ‚Äî ${module.title}</button></li>`).join('');
  }

  function renderModules() {
    const container = document.getElementById('moduleContainer');
    container.innerHTML = modules.map(module => moduleTemplate(module)).join('');
  }

  function moduleTemplate(module) {
    if (module.id === 'M1') {
      return moduleOneTemplate(module);
    }
    if (module.id === 'M2') {
      return moduleTwoTemplate(module);
    }
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const sections = module.sections.map(section => `
      <div class="section">
        <h3>${section.title}</h3>
        <ul>${section.bullets.map(b => `<li>${b}</li>`).join('')}</ul>
      </div>`).join('');
    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    return `
      <article class="module" id="${module.id}">
        <span class="pill">Module ${module.id.replace('M','')}</span>
        <h2>${module.title}</h2>
        <p>${module.intro}</p>
        <div class="section">
          <h3>Learning Objectives</h3>
          <ul>${objectives}</ul>
        </div>
        ${sections}
        <div class="section callout">
          <strong>Visual/Diagram Descriptions:</strong>
          <ul>${module.sections.map(s => s.bullets.find(b => b.toLowerCase().includes('diagram') || b.toLowerCase().includes('visual'))).filter(Boolean).map(item => `<li>${item}</li>`).join('') || '<li>See notes above.</li>'}</ul>
        </div>
        <div class="quiz" aria-label="quiz for ${module.title}">
          <h3>Knowledge Check</h3>
          ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
        </div>
      </article>
    `;
  }

  function moduleOneTemplate(module) {
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const subjectiveList = module.vocabulary.subjective.map(item => `<li>‚ùå ${item}</li>`).join('');
    const objectiveList = module.vocabulary.objective.map(item => `<li>‚úÖ ${item}</li>`).join('');
    const rules = module.measurementRules.map(rule => `
      <div class="rule-card">
        <h4>${rule.title}</h4>
        <p>${rule.details}</p>
      </div>
    `).join('');
    const hemPoints = module.hemCallout.points.map(point => `<li>${point}</li>`).join('');
    const scenarios = module.complaintScenarios.map(scenario => `
      <div class="scenario-card">
        <p class="eyebrow">Bad Note</p>
        <p class="bad">${scenario.bad}</p>
        <p class="eyebrow">Complaint</p>
        <p>${scenario.result}</p>
        <p class="eyebrow">Corrected Note</p>
        <p class="good">${scenario.fix}</p>
      </div>
    `).join('');
    const practices = module.practicePrompts.map((prompt, idx) => `
      <div class="practice-card">
        <div class="practice-header">
          <p class="eyebrow">Rewrite Prompt ${idx + 1}</p>
          <span class="tag">Practice</span>
        </div>
        <p class="bad">${prompt.bad}</p>
        <label class="sr-only" for="practice-${idx}">Rewrite prompt ${idx + 1}</label>
        <input id="practice-${idx}" type="text" placeholder="${prompt.placeholder}" />
        <p class="hint">Example: ${prompt.example}</p>
      </div>
    `).join('');
    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    return `
      <article class="module" id="${module.id}">
        <span class="pill">Module ${module.id.replace('M','')}</span>
        <h2>${module.title}</h2>
        <p>${module.intro}</p>

        <div class="section">
          <h3>Learning Objectives</h3>
          <ul>${objectives}</ul>
        </div>

        <div class="section concept-grid">
          <div class="concept-card">
            <h3>Subjective vs Objective</h3>
            <div class="list-row">
              <div>
                <p class="eyebrow">Avoid</p>
                <ul>${subjectiveList}</ul>
              </div>
              <div>
                <p class="eyebrow">Use Instead</p>
                <ul>${objectiveList}</ul>
              </div>
            </div>
            <p class="tip">Ask the customer to stand naturally, measure the preferred fit, and document the final number.</p>
          </div>
          <div class="concept-card highlight">
            <h3>Standard Measurement Language</h3>
            <p>Use formats that travel clearly to the tailor:</p>
            <ul>
              <li>INSEAM 30 / INSEAM 32</li>
              <li>OUTSEAM 40</li>
              <li>WAIST 36</li>
              <li>‚ÄúShorten sleeves to 23 inches from shoulder seam.‚Äù</li>
            </ul>
            <p class="tip">Never record ‚Äúa little‚Äù or ‚Äú+/-‚Äù values‚Äîcapture the final measurement instead.</p>
          </div>
        </div>

        <div class="section rule-grid">
          ${rules}
        </div>

        <div class="section hem-callout">
          <div>
            <p class="eyebrow">Hem Reminder</p>
            <h3>${module.hemCallout.heading}</h3>
            <ul>${hemPoints}</ul>
          </div>
          <div class="hem-visual">
            <p class="badge-lite">Garment Part</p>
            <p>The hem is the folded, sewn edge. It needs a target length to make sense.</p>
          </div>
        </div>

        <div class="section scenario-grid">
          <h3>Complaint Prevention Examples</h3>
          ${scenarios}
        </div>

        <div class="section practice-grid" aria-label="Rewrite practice for clearer notes">
          <h3>Rewrite Practice (not graded)</h3>
          <p class="subtitle">Rewrite each vague note as a final, objective instruction. Use the examples as guidance.</p>
          <div class="practice-list">${practices}</div>
        </div>

        <div class="section script-card">
          <h3>Confirmation Script</h3>
          <p>‚ÄúI‚Äôll note <strong>‚Äòshorten inseam to 30 inches‚Äô</strong>. Is that exactly what you want?‚Äù Repeat back the final measurement before saving it.</p>
        </div>

        <div class="quiz" aria-label="quiz for ${module.title}">
          <h3>Knowledge Check</h3>
          ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
        </div>
      </article>
    `;
  }

  // Module 2 uses custom layout classes (pin-grid, policy-card, orientation-grid) defined in styles.html.
  function moduleTwoTemplate(module) {
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const pinCards = module.pinTypes.map(pin => `
      <div class="pin-card">
        <div class="pin-card__header">
          <span class="pill pill-quiet">Pin Type</span>
          <h3>${pin.name}</h3>
        </div>
        <p class="micro-copy">${pin.description}</p>
        <ul>${pin.useCases.map(use => `<li>${use}</li>`).join('')}</ul>
        <div class="note-line">${pin.caution}</div>
      </div>
    `).join('');

    const checklist = module.safetyChecklist.map(item => `<li>${item}</li>`).join('');
    const scenarios = module.scenarios.map((s, idx) => `
      <div class="scenario-card">
        <p class="eyebrow">Scenario ${idx + 1}</p>
        <p><strong>${s.prompt}</strong></p>
        <p class="answer">Answer: ${s.answer}</p>
      </div>
    `).join('');

    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    return `
      <article class="module" id="${module.id}">
        <span class="pill">Module ${module.id.replace('M','')}</span>
        <h2>${module.title}</h2>
        <p>${module.intro}</p>

        <div class="section">
          <h3>Learning Objectives</h3>
          <ul>${objectives}</ul>
        </div>

        <div class="section pin-grid" aria-label="Pin type comparison">
          ${pinCards}
        </div>

        <div class="section policy-card" aria-label="Safety pin policy">
          <div>
            <p class="eyebrow">Plant Travel Rule</p>
            <h3>${module.policy.headline}</h3>
            <ul>${module.policy.rules.map(rule => `<li>${rule}</li>`).join('')}</ul>
            <p class="note-line">${module.policy.note}</p>
          </div>
          <div class="policy-badge">
            <div class="badge-warning">Safety pins only</div>
            <p class="micro-copy">Closed clasps prevent injuries and protect machinery.</p>
          </div>
        </div>

        <div class="section orientation-grid" aria-label="Pin orientation examples">
          <div class="orientation-card good">
            <p class="pill pill-quiet">Correct</p>
            <h3>${module.orientation.correct.title}</h3>
            <ul>${module.orientation.correct.bullets.map(item => `<li>${item}</li>`).join('')}</ul>
            <p class="micro-copy">${module.orientation.correct.description}</p>
          </div>
          <div class="orientation-card risk">
            <p class="pill pill-quiet">Incorrect</p>
            <h3>${module.orientation.incorrect.title}</h3>
            <ul>${module.orientation.incorrect.bullets.map(item => `<li>${item}</li>`).join('')}</ul>
            <p class="micro-copy">${module.orientation.incorrect.description}</p>
          </div>
        </div>

        <div class="section checklist" aria-label="Pin safety checklist">
          <div>
            <p class="eyebrow">Quick Safety</p>
            <h3>Pin Safety Checklist</h3>
            <ul>${checklist}</ul>
          </div>
          <div class="checklist-note">
            <p class="badge-lite">Checklist Reminder</p>
            <p>Use this before every plant-bound garment leaves the counter.</p>
            <p class="micro-copy">Imagine the hem as a line ‚Äî pins should sit on that line (horizontal), never crossing it like a fence post (vertical).</p>
          </div>
        </div>

        <div class="section scenario-grid" aria-label="Pin safety scenarios">
          <h3>Pin Safety Scenarios</h3>
          ${scenarios}
        </div>

        <div class="quiz" aria-label="quiz for ${module.title}">
          <h3>Knowledge Check</h3>
          ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
        </div>
      </article>
    `;
  }

  function renderQuestion(moduleId, idx, q) {
    const name = `${moduleId}-q${idx}`;
    if (q.type === 'short') {
      return `<div class="quiz-question"><strong>${q.question}</strong><input type="text" name="${name}" placeholder="Type your answer" /></div>`;
    }
    const options = q.options || [{ label: 'True', correct: q.answer === true }, { label: 'False', correct: q.answer === false }];
    const optionHtml = options.map((opt, oi) => `
      <label><input type="radio" name="${name}" value="${oi}"> ${opt.label}</label>
    `).join('');
    return `<div class="quiz-question"><strong>${q.question}</strong><div class="quiz-options">${optionHtml}</div></div>`;
  }

  function submitQuiz(moduleId) {
    const module = modules.find(m => m.id === moduleId);
    const name = getEmployeeName();
    if (!name) {
      alert('Enter your employee name before submitting.');
      return;
    }
    const location = getEmployeeLocation();
    let correct = 0;

    module.quiz.forEach((q, idx) => {
      const fieldName = `${moduleId}-q${idx}`;
      if (q.type === 'short') {
        const value = (document.querySelector(`input[name="${fieldName}"]`)?.value || '').trim().toLowerCase();
        if (q.answers.some(ans => value === ans.toLowerCase())) {
          correct += 1;
        }
      } else {
        const selected = document.querySelector(`input[name="${fieldName}"]:checked`);
        if (selected) {
          const option = (q.options || [{ label: 'True', correct: q.answer === true }, { label: 'False', correct: q.answer === false }])[Number(selected.value)];
          if (option && option.correct) {
            correct += 1;
          }
        }
      }
    });

    const score = Math.round((correct / module.quiz.length) * 100);
    const passed = score >= 80;
    updateModuleResultText(moduleId, passed, score, correct, module.quiz.length);

    if (google.script && google.script.run) {
      google.script.run.withSuccessHandler(() => {
        loadCertificationStatus();
      }).withFailureHandler(err => {
        updateModuleResultText(moduleId, false, score, correct, module.quiz.length, `Error saving: ${err}`);
      }).saveModuleResult(moduleId, name, location, score, passed);
    }
  }

  function updateModuleResultText(moduleId, passed, score, correct, total, errorText) {
    const el = document.getElementById(`${moduleId}-result`);
    if (!el) return;
    if (errorText) {
      el.textContent = errorText;
      el.style.color = '#991b1b';
      return;
    }
    el.textContent = `${passed ? 'PASS' : 'Review content and retry'} ‚Äî ${correct}/${total} correct (${score}%).`;
    el.style.color = passed ? '#0f5132' : '#991b1b';
  }

  function loadCertificationStatus() {
    const name = getEmployeeName();
    if (!name) return;
    if (google.script && google.script.run) {
      google.script.run.withSuccessHandler(renderCertificationStatus).getEmployeeCertificationStatus(name);
    }
  }

  function renderCertificationStatus(status) {
    const badge = document.getElementById('certBadge');
    const title = document.getElementById('certStatus');
    const sub = document.getElementById('certSubstatus');
    const progressFill = document.getElementById('progressFill');
    const moduleProgress = document.getElementById('moduleProgress');
    if (!status) return;

    const completed = status.completedModules || [];
    const missing = status.missingModules || [];
    const percent = Math.round((completed.length / modules.length) * 100);
    progressFill.style.width = `${percent}%`;

    if (status.isCertified) {
      badge.textContent = 'Certified Alteration Pinner';
      badge.style.background = '#e8f8f2';
      badge.style.color = '#0f5132';
      title.textContent = 'üéì Certified Alteration Pinner';
      sub.textContent = 'All five modules passed. Print your certificate for records.';
    } else {
      badge.textContent = `${completed.length}/5 Modules Passed`;
      badge.style.background = '#fff8e1';
      badge.style.color = '#8a6b00';
      title.textContent = 'Modules remaining: ' + (missing.length ? missing.join(', ') : '‚Äî');
      sub.textContent = 'Pass each module quiz to reach certification. Supervisor sign-off required for live pinning clearance.';
    }

    moduleProgress.innerHTML = modules.map(mod => {
      const isDone = completed.includes(mod.id);
      return `<div class="module-chip ${isDone ? 'pass' : ''}">
        <p class="title">${mod.id} ‚Äî ${mod.title}</p>
        <p class="status">${isDone ? 'Passed' : 'Pending'}</p>
      </div>`;
    }).join('');
  }

  function scrollToModule(id) {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: 'smooth' });
  }

  function scrollToStatus() {
    const el = document.getElementById('statusPanel');
    if (el) el.scrollIntoView({ behavior: 'smooth' });
  }

  function openPrintCertificate() {
    const name = getEmployeeName();
    const location = getEmployeeLocation();
    const url = `print.html?name=${encodeURIComponent(name || '')}&location=${encodeURIComponent(location || '')}`;
    window.open(url, '_blank');
  }
</script>
