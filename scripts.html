<script>
  const modules = [
    {
      id: 'M1',
      title: 'Customer Instruction & Measurement Philosophy üìè',
      intro: 'Shift every conversation from ‚Äúa bit‚Äù or ‚Äú2 inches‚Äù to precise, final measurements that tailors can trust.',
      objectives: [
        'Explain subjective vs. objective alteration language.',
        'Avoid +/- shorthand and capture the final measurement instead.',
        'Use phrases like ‚ÄúINSEAM 32‚Äù or ‚ÄúShorten inseam to 30 inches.‚Äù',
        'Describe ‚Äúhem‚Äù correctly as the folded, sewn edge‚Äînot a verb or a measurement.',
        'Spot and rewrite vague notes into clear instructions that prevent complaints.',
        'Model confirmation scripts so customers agree to the recorded measurement.'
      ],
      vocabulary: {
        subjective: [
          'Shorten a bit',
          'Take in a little',
          'Fix the hem',
          'Make it tighter'
        ],
        objective: [
          'Shorten inseam to 30 inches',
          'Take in waist to 34 inches',
          'Shorten sleeves to 23 inches from shoulder seam',
          'Finished hem should measure 30 inches inseam'
        ]
      },
      measurementRules: [
        {
          title: 'No Plus/Minus Shorthand',
          details: '‚Äú-2 inches‚Äù or ‚Äú+1 inch‚Äù only describe the change. Tailors need the final number: ‚ÄúShorten hem to 36 inches from floor.‚Äù'
        },
        {
          title: 'Final Measurement Language',
          details: 'Record what the customer wants to end up with. Example: ‚ÄúTake in waist to 36 inches‚Äù instead of ‚ÄúTake in 2 inches.‚Äù'
        },
        {
          title: 'Standard Format',
          details: 'Use clear formats that travel well: ‚ÄúINSEAM 32,‚Äù ‚ÄúOUTSEAM 40,‚Äù ‚ÄúWAIST 36.‚Äù'
        },
        {
          title: 'Tag sizes are NOT measurements',
          details: 'Never rely on the tag for inseam or waist. BAD: ‚ÄúInseam 32 (tag says 32).‚Äù GOOD: ‚ÄúMeasured and confirmed: inseam to 30.5 (customer approved).‚Äù'
        }
      ],
      hemCallout: {
        heading: '‚ÄúHem‚Äù means the finished edge üìù',
        points: [
          'It is a part of the garment, not a measurement.',
          'Wrong: ‚ÄúHem pants,‚Äù ‚ÄúHem 2 inches.‚Äù',
          'Right: ‚ÄúShorten pants so finished hem is 30 inches inseam.‚Äù'
        ]
      },
      complaintScenarios: [
        {
          bad: '‚ÄúHem pants.‚Äù',
          result: 'Pants end up shorter than the customer expected; tailor guessed the target length.',
          fix: '‚ÄúShorten inseam to 30 inches; customer wearing normal shoes.‚Äù'
        },
        {
          bad: '‚Äú-2 inches from existing hem.‚Äù',
          result: 'Two staff members measure differently; finished length is uneven.',
          fix: '‚ÄúFinished hem 36 inches from the floor; measure with customer standing straight.‚Äù'
        },
        {
          bad: '‚ÄúTake in waist a little.‚Äù',
          result: 'Waist too tight; customer cannot button comfortably.',
          fix: '‚ÄúTake in waist to 34 inches; confirm comfortable when seated.‚Äù'
        },
        {
          bad: '‚ÄúUse tag size 32.‚Äù',
          result: 'Tag was wrong from a previous alteration; hem finishes an inch too long.',
          fix: '‚ÄúMeasured and confirmed: shorten inseam to 30.5; customer approved.‚Äù'
        }
      ],
      practicePrompts: [
        {
          bad: '‚ÄúShorten a bit.‚Äù',
          placeholder: 'Rewrite with a final inseam measurement‚Ä¶',
          example: '‚ÄúShorten inseam to 29 inches; balanced on both legs.‚Äù'
        },
        {
          bad: '‚ÄúHem 2 inches.‚Äù',
          placeholder: 'State the final length instead of the change‚Ä¶',
          example: '‚ÄúFinished hem 37 inches from floor with dress shoes.‚Äù'
        },
        {
          bad: '‚ÄúTake in 2 inches.‚Äù',
          placeholder: 'Record the target waist size‚Ä¶',
          example: '‚ÄúTake in waist to 36 inches; customer can sit comfortably.‚Äù'
        },
        {
          bad: '‚ÄúUse tag inseam 32.‚Äù',
          placeholder: 'Replace the tag reference with the measured final number‚Ä¶',
          example: '‚ÄúMeasure and confirm: shorten inseam to 30.5 (customer approved).‚Äù'
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which is an objective alteration note?', options: [
          { label: 'Hem 2 inches', value: 'a', correct: false },
          { label: 'Shorten inseam to 30 inches', value: 'b', correct: true },
          { label: 'Make it tighter', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which note follows the no plus/minus rule?', options: [
          { label: 'Take in waist 2 inches', value: 'a', correct: false },
          { label: 'Take in waist to 34 inches', value: 'b', correct: true },
          { label: 'Waist -2', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What does ‚Äúhem‚Äù refer to?', options: [
          { label: 'A verb that means shorten', value: 'a', correct: false },
          { label: 'The folded and sewn edge of the garment', value: 'b', correct: true },
          { label: 'Any measurement on pants', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which format best matches the standard measurement language?', options: [
          { label: 'Shorten a bit', value: 'a', correct: false },
          { label: 'INSEAM 32', value: 'b', correct: true },
          { label: 'Hem pants', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Why can‚Äôt you rely on the tag size?', options: [
          { label: 'Tags always match the tailor‚Äôs tools', value: 'a', correct: false },
          { label: 'Tags can be wrong from prior alterations or manufacturing; measure and record the confirmed final number instead', value: 'b', correct: true },
          { label: 'Tags are only for dry cleaning codes', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What should you confirm aloud before recording the note?', options: [
          { label: 'That the customer wants ‚Äúa little shorter‚Äù', value: 'a', correct: false },
          { label: 'The exact final measurement such as inseam 30 inches', value: 'b', correct: true },
          { label: 'Whether the tailor can guess the length later', value: 'c', correct: false }
        ]}
      ]
    },
    {
      id: 'M2',
      title: 'Pinning Tools & Safety üß∑',
      intro: 'Choose the right pins, lock them safely, and select horizontal or vertical orientation based on stability, fabric, and customer preference.',
      objectives: [
        'Identify and describe straight pins vs. safety pins.',
        'State why safety pins are required for garments traveling to the plant.',
        'Demonstrate stable pin orientation: horizontal is preferred for travel; vertical is acceptable when customer preference, garment type, or fitting goals call for it.',
        'Explain how to choose orientation while still delivering objective, measurable results.',
        'Apply the pin safety checklist‚Äîincluding on-body pinning with your hand between garment and customer, consent, and clear boundaries away from private regions‚Äîto protect customers, staff, and equipment.',
        'Complete a pre-plant checklist to confirm safe, accurate pinning and clear communication.'
      ],
      pinTypes: [
        {
          name: 'Straight pins',
          description: 'Simple needle with a colored head at one end; open and sharp at the other.',
          useCases: [
            'On-the-spot fitting while the customer is present.',
            'Quick, temporary holds when you are watching and can remove immediately.',
            'Not safe for garments traveling through bags, racks, and plant equipment.'
          ],
          caution: 'Never send straight pins to the plant. Replace them with closed safety pins before the garment leaves the store.'
        },
        {
          name: 'Safety pins',
          description: 'Pin with a clasp that closes and covers the sharp point when locked.',
          useCases: [
            'Required for any garment leaving the store and going to the plant.',
            'Locks closed so pins cannot fall out or snag machinery.',
            'Best for secure travel in garment bags and racks.'
          ],
          caution: 'Always lock the clasp and place pins horizontally at the measurement line.'
        }
      ],
      policy: {
        headline: 'Non-Negotiable: Safety Pins for Plant-Bound Garments ‚ö†Ô∏è',
        rules: [
          'Any garment traveling to the plant must be secured with closed safety pins.',
          'Prevents loose pins from injuring staff, customers, or tailors.',
          'Protects plant equipment and other garments from snags or jams.',
          'Confirms a stable, readable reference line for the tailor.'
        ],
        note: 'Always warn the customer where pins are placed before they leave, even when using safety pins.'
      },
      orientation: {
        correct: {
          title: 'Horizontal Pinning (Preferred for travel)',
          bullets: [
            'Pins run parallel to the floor/hem line and create a clear reference for tailors.',
            'Holds fabric securely during handling and transport.',
            'Maintains the requested length if the garment shifts in the bag.'
          ],
          description: 'Imagine the hem as a line. The pin should lie along that line, like a rail on the hem.'
        },
        flexible: {
          title: 'Vertical Pinning (Allowed with care)',
          bullets: [
            'Use when the garment or customer prefers it‚Äîfor example, thick seams, pleats, or quick on-body marking.',
            'Place your hand between the garment and customer before inserting any pin.',
            'Re-measure the finished length; if the garment will travel, convert to closed safety pins (horizontal preferred for transport).'
          ],
          description: 'Choose the orientation that keeps the measurement clear and secure. Stability matters more than a single ‚Äúright‚Äù direction.'
        }
      },
      onBodySafety: {
        headline: 'Pinning & Measuring on a Customer Safely ‚Äî Allowed With Boundaries',
        reminders: [
          'Allowed only with consent, clear communication, and a hand barrier between garment and customer before inserting pins.',
          'Narrate each move: ‚ÄúI‚Äôm going to pin here‚Äîare you comfortable?‚Äù Move slowly with controlled pins.',
          'Never pin or measure in private or near-private regions. If a request would require that, escalate to the tailor lead or supervisor.',
          'If the customer is unsure or seems uncomfortable, pause immediately and escalate.'
        ],
        script: '‚ÄúFor comfort and safety, we can pin here with my hand between the fabric and you. If this adjustment requires a tailor fitting, we‚Äôll bring in our tailor lead.‚Äù'
      },
      safetyChecklist: [
        'Keep sharp points away from skin; never pin through skin or too close to the body. Hand between garment and customer before any on-body pin.',
        'Confirm pins are secure and stable‚Äîhorizontal is preferred for transport; vertical is acceptable when noted and measured.',
        'Inform the customer where pins are placed before they leave.',
        'Count pins so none are left loose in bags or garments.',
        'Replace any straight pins with safety pins before the garment goes to the plant.',
        'Never pin or measure in private or near-private regions; escalate to a tailor lead or supervisor if a request would require that area.'
      ],
      scenarios: [
        {
          prompt: 'You pinned pants for hemming and the customer is leaving them for cleaning and alterations. What type of pin should be in the garment before it goes to the plant?',
          answer: 'Closed safety pins placed horizontally at the new hem line.'
        },
        {
          prompt: 'You quickly pinned a hem while the customer stood on the platform using straight pins. Before sending to the plant, what must you do?',
          answer: 'Replace straight pins with closed safety pins and double-check horizontal orientation.'
        },
        {
          prompt: 'You need to mark a hem while the customer is still wearing the garment. How do you protect them?',
          answer: 'Place your hand between the garment and the customer‚Äôs body, move slowly, narrate what you are doing, and confirm comfort before inserting the pin.'
        },
        {
          prompt: 'A customer asks you to pin an area that would require contact near a private region. What is the correct next step?',
          answer: 'Do not pin there‚Äîexplain the boundary, and escalate to the tailor lead or supervisor for a professional fitting option.'
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which pin must be used for any garment traveling to the plant?', options: [
          { label: 'Straight dressmaker pin', value: 'a', correct: false },
          { label: 'Safety pin that is closed', value: 'b', correct: true },
          { label: 'No pins‚Äîjust fold the fabric', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which statement is most accurate about horizontal vs. vertical pinning?', options: [
          { label: 'Horizontal pins are preferred for stability, but vertical pins are acceptable when the garment or customer needs them and you re-measure the final length', value: 'a', correct: true },
          { label: 'Vertical pins are never allowed for alterations', value: 'b', correct: false },
          { label: 'Only vertical pins should be used for hems', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What orientation should safety pins have on a hem for transport?', options: [
          { label: 'Horizontal, parallel to the floor for best stability in transit', value: 'a', correct: true },
          { label: 'Vertical like a nail', value: 'b', correct: false },
          { label: 'Diagonal to save time', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Before sending a garment to the plant you must‚Ä¶', options: [
          { label: 'Confirm pins are closed, stable, and counted‚Äîhorizontal preferred for travel', value: 'a', correct: true },
          { label: 'Switch to vertical pins to speed up without re-measuring', value: 'b', correct: false },
          { label: 'Skip telling the customer about the pins', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'When can straight pins be used?', options: [
          { label: 'Only while the customer is present and you will replace them before the garment travels', value: 'a', correct: true },
          { label: 'Anytime because they are faster', value: 'b', correct: false },
          { label: 'Never replace them with safety pins', value: 'c', correct: false }
        ]}
      ]
    },
    {
      id: 'M3',
      title: 'Pinning by Garment Type üìè',
      intro: 'Apply garment-specific pinning with smooth fabric, balanced measurements, and verified customer pins without on-body inseam measuring.',
      objectives: [
        'Pin pants, skirts, simple dresses, and sleeves in the correct location and orientation without measuring inseams on the body.',
        'Smooth fabric before measuring‚Äînever stretch.',
        'Ask male customers if they are left- or right-handed to balance inseams and confirm any preferred drape.',
        'Pin each pant leg separately; document leg length differences on a flat surface instead of assuming symmetry.',
        'Pair one patch to one garment and avoid loose patches.',
        'Guide customers to pick a specific patch spot‚Äîno ‚Äúwherever it looks best.‚Äù',
        'Verify customer-pinned garments with a tape measure and confirm the final measurement.',
        'Record objective final dimensions for every pinned garment, including pant type when relevant.'
      ],
      garmentTypes: [
        {
          name: 'Pants (hems + simple waist)',
          csrScope: 'CSR approved',
          pinning: 'Mark the desired hem while the customer wears the pants using a gentle fold or shallow pin in loose fabric only‚Äîno tape measures on-body and no pins against skin or near private regions. Place your hand between the garment and the customer before any on-body pin. After the pants are off, place stable safety pins (horizontal preferred for travel; vertical acceptable when needed) at the marked hem and add 1‚Äì2 pins near side seams for waist adjusts on the table. Escalate to a tailor lead if a request would require contact near private areas.',
          pins: '3‚Äì5 secure pins around each hem keep the line straight; safety pins required if the garment will travel.',
          record: '‚ÄúShorten inseam to 30 inches.‚Äù If legs differ: ‚ÄúLeft inseam to 29.5; Right inseam to 30 (confirmed off-body).‚Äù',
          balance: 'Smooth both legs first; ask about handedness and leg length differences, then verify measurements off-body.'
        },
        {
          name: 'Skirts (hems)',
          csrScope: 'CSR approved',
          pinning: 'Pin evenly around the hem; keep bias fabrics flat without pulling. When pinning on-body, follow safety measures, avoid private or near-private regions, and escalate if the request would require that contact. Check for vents or splits‚Äîshortening reduces their length and may change movement; confirm with the customer or escalate.',
          pins: '4‚Äì6 pins spaced evenly at seams and front/back centers.',
          record: '‚ÄúShorten hem to 38 inches from waist to floor with heels.‚Äù Add: ‚ÄúVent will be shorter‚Äîcustomer approved.‚Äù',
          balance: 'Check skirt hangs level on platform; smooth before each pin. Escalate if the customer wants the vent length preserved.'
        },
        {
          name: 'Simple dresses (length only)',
          csrScope: 'CSR approved ‚Äî escalate complex bodice or beading to Module 5.',
          pinning: 'Pin securely at the new length; avoid stretching knit or bias fabric. When pinning on-body, keep a hand barrier, move slowly, and avoid private/near-private regions. Escalate if the request would require close contact near private areas. Check for back vents/splits that will shorten and confirm with the customer or escalate.',
          pins: '3‚Äì5 pins across front/back; mirror left/right heights.',
          record: '‚ÄúFinished length 40 inches shoulder to hem.‚Äù Note vent impact if present.',
          balance: 'Keep dress straight on hanger or platform; smooth along the hang line. Ask if they want a vent preserved before finalizing.'
        },
        {
          name: 'Simple sleeves (length)',
          csrScope: 'CSR approved',
          pinning: 'Pin at wrist bone parallel to cuff; note lining if present.',
          pins: '2‚Äì3 pins around the sleeve circumference.',
          record: '‚ÄúShorten sleeves to 23 inches from shoulder seam.‚Äù',
          balance: 'Check both sleeves match and hang evenly when arms relaxed.'
        }
      ],
      ventsSplits: {
        headline: 'Vents & Splits (Skirts/Dresses)',
        bullets: [
          'Shortening a vented skirt or dress will reduce the vent/split length.',
          'Movement, modesty, and appearance can change when the vent is shorter.',
          'Confirm the customer is okay with the change; note their approval in the record.',
          'If they want the vent preserved or adjusted‚Äîor you are unsure‚Äîescalate to the tailor.'
        ],
        reminder: 'Document ‚Äúvent will be shorter‚Äîcustomer approved‚Äù or escalate for tailor planning.'
      },
      smoothRules: {
        headline: 'Smooth, Don‚Äôt Stretch',
        bullets: [
          'Before measuring, smooth the fabric along the body line or hem so it lies flat.',
          'Never tug to ‚Äúhelp‚Äù the measuring tape‚Äîstretching adds 1/2‚Äù‚Äì1‚Äù and ruins accuracy.',
          'If fabric rebounds when you let go, you stretched it. Reset, smooth, and re-measure.'
        ]
      },
      handedness: {
        prompt: 'Ask male customers: ‚ÄúAre you left- or right-handed? It helps us balance your inseam.‚Äù',
        reason: 'Right-handed customers often load weight on the right leg. Knowing this keeps hems balanced across both legs.',
        action: 'Smooth both legs, pin both hems, and double-check the measured inseam on each side. If customer wants a slightly longer side for balance, leave a small allowance only after measuring and confirming with them.',
        cautions: [
          'Do not invent an adjustment amount. Pin, measure, and confirm with the customer before noting anything extra.',
          'If a customer requests a preferred drape on one side, leave a little extra only on that side and record the measured final length.',
          'Example note: ‚ÄúRight-handed; customer prefers slightly longer right leg. Right inseam = 30.0; Left inseam = 29.75 (confirmed at fitting).‚Äù'
        ]
      },
      pantsPolicy: {
        headline: 'We do not measure inseams on the customer‚Äôs body.',
        points: [
          'Do not place a measuring tape at the inseam while the customer is wearing pants.',
          'Pins must be placed in a way that avoids skin contact‚Äîpin fabric folds, not tight fabric against the leg, and keep your hand between garment and customer when pinning on-body.',
          'Safety pins are preferred when the garment will travel to prevent shifting.'
        ],
        verification: [
          'Measure inseams only after the pants are removed and laid flat.',
          'Use the pinned hem line as your reference point on the table, not on the body.',
          'If an existing measurement is provided, verify it off-body instead of re-measuring against the customer.'
        ],
        note: 'Objective numbers come from flat-surface measurements after safe pinning‚Äînot from on-body tape placement.'
      },
      legLengthCallout: {
        headline: 'Leg Length Differences Are Common',
        bullets: [
          'Customers may already know one leg runs longer or shorter‚Äîlisten for it and ask follow-up questions before pinning.',
          'Mark both legs while worn, then remove the pants and measure each leg independently on the table.',
          'Document differences clearly so the tailor can match the customer‚Äôs balance without guessing.'
        ],
        notes: ['Left inseam to 29.5‚Äù', 'Right inseam to 30‚Äù'],
        scenario: 'Customer says, ‚ÄúMy left leg is shorter, please hem accordingly.‚Äù'
      },
      pantsWorkflow: {
        title: 'Pants Hem Workflow (Mark on Body, Measure Off Body) ‚úÖ',
        steps: [
          'Safe marking while worn: customer stands naturally (shoes on as needed); smooth fabric without stretching; lightly mark the desired hem using a fold or shallow pin in loose fabric only‚Äînever touching skin and never using a tape measure on-body.',
          'Remove and measure off-body: have the customer step out; lay pants flat; align seams and smooth; place horizontal safety pins at the marked hem if needed, measure each leg to the pinned finished point, and record objective numbers.',
          'Confirm differences and notes: if legs differ, confirm aloud and record each inseam with garment type and shoe context‚Äînever rely on tag size.'
        ]
      },
      doDont: {
        do: [
          'Mark hems while the customer wears the pants only to mark the line with a fold or shallow pin away from skin; keep your hand between the garment and the customer. Lock in closed safety pins after the garment is off (horizontal preferred; vertical acceptable when noted and stable).',
          'Measure inseams on a flat surface after the pants are removed, using the pinned line as the reference.',
          'Record final objective measurements for each leg and note garment type when drape matters.',
          'Choose pin orientation based on stability and fabric‚Äîdocument if you use vertical pins for a specific fitting goal.'
        ],
        dont: [
          'Measure a trouser inseam while the customer is wearing the pants.',
          'Place a tape measure near the crotch/inseam area on-body.',
          'Pin through tight fabric that presses against skin or could cause discomfort.'
        ]
      },
      patchProtocol: {
        pairing: [
          'One patch must be pinned to one garment‚Äîno loose patches in a bag.',
          'If three uniforms arrive with three patches, each patch gets pinned to its exact uniform.',
          'Leave a small note or tape arrow showing which pocket/panel the patch belongs to.'
        ],
        placement: [
          'If a customer says ‚Äúwherever it looks best,‚Äù guide them to pick a spot now.',
          'Have the customer pin while wearing or on a flat surface, or assist them and pin that exact location.',
          'Avoid vague notes like ‚Äúpatch on front.‚Äù Choose side/height and secure it with a safety pin.'
        ]
      },
      customerPinned: {
        steps: [
          'After the garment is off the customer, measure the pinned length/spot on a flat surface‚Äînever while the garment is on the body.',
          'Confirm verbally: ‚ÄúYou want the inseam to be 29 inches at this pin, correct?‚Äù',
          'Replace loose straight pins with closed safety pins if the garment is leaving the store.',
          'Record the final measurement in notes: ‚ÄúShorten inseam to 29 inches (customer pinned, verified off-body).‚Äù'
        ],
        reason: 'Verification prevents miscommunication and documents the exact, objective request without on-body measuring.'
      },
      recording: [
        { item: 'Pants', examples: ['Shorten inseam to 30 inches.', 'Take in waist to 34 inches.', 'Left inseam to 29.5; Right inseam to 30 (confirmed).'] },
        { item: 'Pant Type', examples: ['Jeans: shorten inseam to 30.0.', 'Wool trousers: shorten inseam to 30.0 (customer wearing dress shoes).'] },
        { item: 'Skirts/Dresses', examples: ['Shorten hem to 38 inches waist-to-floor in heels.', 'Finished length 40 inches shoulder to hem.'] },
        { item: 'Sleeves', examples: ['Shorten sleeves to 23 inches from shoulder seam.', 'Match both sleeves at the wrist bone.'] },
        { item: 'Patches', examples: ['Patch pinned to right chest above pocket.', 'One patch per garment; location noted.'] }
      ],
      drapeNotes: {
        headline: 'Drape matters: Jeans vs Trousers',
        bullets: [
          'Denim, wool, and dress trousers hang differently. Note the fabric type so tailors account for drape.',
          'Record the shoe type if it affects where the hem rests.'
        ],
        examples: ['Jeans: shorten inseam to 30.0.', 'Wool trousers: shorten inseam to 30.0 (customer wearing dress shoes).']
      },
      practiceScenarios: [
        {
          prompt: 'Customer asks for an adjustment that would require pinning very close to a private region.',
          response: 'Do not pin there. Explain the boundary, escalate to the tailor lead/supervisor for a fitting plan, and document the escalation.'
        },
        {
          prompt: 'Customer says, ‚ÄúMy left leg is shorter, please hem accordingly.‚Äù',
          response: 'Pin and measure each leg separately, confirm both numbers, and note them individually.'
        },
        {
          prompt: 'Customer mentions being right-handed and wanting the right leg to feel slightly heavier.',
          response: 'Pin normally, measure both legs, leave only the slight confirmed allowance on the right, and record the measured values.'
        }
      ],
      quickChecklist: [
        'Smooth fabric, then pin‚Äînever stretch to reach the tape.',
        'When pinning on the customer, keep your hand between garment and body, move slowly, and confirm comfort before inserting any pin.',
        'Never pin or measure in private or near-private regions; escalate to the tailor lead if a request requires that proximity.',
        'Mark hems while the customer wears the pants if needed, then place/verify pins and measure each leg flat; never measure on the body.',
        'Ask handedness, confirm leg differences, and record each inseam with garment/shoe context.',
        'Note pant type (jeans vs trousers) and shoe type if it affects drape.',
        'One patch per garment with a chosen spot, not a guess later.',
        'Customer-pinned? Verify off-body with a tape and write the final dimension.',
        'Select pin orientation to keep the measurement stable‚Äîhorizontal is preferred for travel, vertical is acceptable when the fabric or customer needs it.',
        'For vents/splits on skirts or dresses: confirm the shorter vent is okay or escalate to the tailor.'
      ],
      escalationNote: {
        title: 'Escalate when on-body precision is requested.',
        text: 'If a customer insists on an on-body inseam measurement, requests pinning near private regions, or needs precision that cannot be achieved comfortably at the counter, pause and involve the tailor lead or schedule a private fitting.',
        reminder: 'Keep wording calm and professional while protecting customer comfort and store policy.'
      },
      quiz: [
        { type: 'mcq', question: 'How should hems be pinned for pants or skirts?', options: [
          { label: 'Vertically with one pin', value: 'a', correct: false },
          { label: 'Horizontally at the new hem with multiple pins to keep it straight', value: 'b', correct: true },
          { label: 'No pins‚Äîjust fold the fabric', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Why ask male customers if they are left- or right-handed?', options: [
          { label: 'It changes the fabric type', value: 'a', correct: false },
          { label: 'It helps balance inseams because weight often favors one leg', value: 'b', correct: true },
          { label: 'It is required for payment', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'When legs differ, what is the correct workflow?', options: [
          { label: 'Assume both legs match and average the lengths', value: 'a', correct: false },
          { label: 'Pin and measure each leg separately, then record both numbers', value: 'b', correct: true },
          { label: 'Ignore the difference and note only one inseam', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'How do you handle a handedness request for balance?', options: [
          { label: 'Guess an extra amount on the dominant side', value: 'a', correct: false },
          { label: 'Pin normally, measure, confirm any extra length the customer wants, and record the measured result', value: 'b', correct: true },
          { label: 'Add length to both sides evenly', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Pants hem workflow best practice is to‚Ä¶', options: [
          { label: 'Measure inseam while the customer wears the pants for speed', value: 'a', correct: false },
          { label: 'Mark hems while worn, then remove the pants and measure each leg flat before confirming', value: 'b', correct: true },
          { label: 'Skip measuring if the customer brought a tag', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which note documents drape and garment type clearly?', options: [
          { label: 'Hem pants', value: 'a', correct: false },
          { label: 'Wool trousers: shorten inseam to 30.0 (customer wearing dress shoes).', value: 'b', correct: true },
          { label: 'Take up inseam like usual', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Patch handling rule:', options: [
          { label: 'Send patches loose and sort later', value: 'a', correct: false },
          { label: 'Pin each patch to its specific garment and mark the spot', value: 'b', correct: true },
          { label: 'Stack patches together for speed', value: 'c', correct: false }
        ]}
      ]
    },
    { 
      id: 'M4',
      title: 'SPOT POS Notes & Communication üìù',
      intro: 'Document clear, objective alteration notes in SPOT that mirror the customer‚Äôs expectations and the tailor‚Äôs needs.',
      objectives: [
        'Enter clear, objective alteration notes in SPOT using final measurements.',
        'Avoid using ‚Äúhem‚Äù as a verb or measurement.',
        'Use phrases like ‚Äúshorten to 36 inches‚Äù instead of ‚Äúhem to 36 inches‚Äù or ‚Äúshorten a bit‚Äù.',
        'Mirror the customer‚Äôs expectations back to them verbally and in the written note.',
        'Identify and correct vague, incomplete, or risky POS notes.',
        'Use SPOT fields consistently (item description vs. notes) to convey alterations to the tailor.',
        'Include garment type and measured final inseam (not tag size) when drape or balance matters.'
      ],
      objectiveNotes: {
        correct: [
          '‚úÖ Shorten inseam to 30 inches. Customer tried on and approved.',
          '‚úÖ Take in waist to 34 inches. Measure flat at waistband.',
          '‚úÖ Shorten sleeves to 23 inches from shoulder seam; match both sleeves.',
          '‚úÖ Jeans: shorten inseam to 30.0 (measured, not from tag).',
          '‚úÖ Wool trousers: shorten inseam to 30.0 (customer wearing dress shoes).'
        ],
        incorrect: [
          '‚ùå Hem pants.',
          '‚ùå Hem 2 inches.',
          '‚ùå Take in 2 inches.',
          '‚ùå Shorten a bit.',
          '‚ùå Inseam 32 (per tag).'
        ],
        reminder: 'SPOT notes should read like the final measurement instruction the tailor will sew to ‚Äî not a hint or a guess.'
      },
      hemGuidance: {
        definition: '‚ÄúHem‚Äù refers to the folded and sewn edge of the garment. It is not a measurement or a verb.',
        wrong: ['Hem dress 2 inches.', 'Hem to 36 inches.'],
        better: ['Shorten dress so finished hem is 36 inches from shoulder to hem.', 'Shorten pants so inseam finishes at 30 inches.'],
        reminder: 'Replace ‚Äúhem to‚Äù with ‚Äúshorten to‚Äù plus the final dimension.'
      },
      comparisons: [
        { bad: 'Hem to 36 inches', good: 'Shorten dress so finished hem is 36 inches from shoulder to hem.' },
        { bad: 'Hem pants 2 inches', good: 'Shorten inseam to 30 inches.' },
        { bad: 'Hem sleeves', good: 'Shorten sleeves to 23 inches from shoulder seam.' },
        { bad: 'Use tag length 32', good: 'Measured and confirmed inseam to 30.5 (customer approved).' }
      ],
      standardFormats: [
        { label: 'INSEAM', example: 'INSEAM 30', note: 'Final inseam measurement after hemming. Avoid +/- shorthand.' },
        { label: 'WAIST', example: 'WAIST 34', note: 'State the finished waist size after taking in or letting out.' },
        { label: 'SLEEVE', example: 'SLEEVE 23 from shoulder seam', note: 'Include the reference point so tailors know where to measure.' },
        { label: 'HEM LENGTH', example: 'Finished hem 36 from floor with flats', note: 'Spell out the measurement and shoe type if relevant.' },
        { label: 'PANT TYPE', example: 'Jeans: shorten inseam to 30.0 (measured)', note: 'Include fabric type because denim vs trousers drape differently.' }
      ],
      fieldUsage: [
        'Item/Service lines describe the garment and service (e.g., ‚ÄúMen‚Äôs Pants ‚Äî Dry Clean + Hem‚Äù).',
        'Use the Notes field for the exact alteration and final measurement.',
        'Mirror approvals: ‚ÄúCustomer tried on and approved length with normal shoes.‚Äù',
        'Tag customer-pinned garments: ‚ÄúShorten inseam to 29 inches (customer pinned, verified).‚Äù',
        'Note pant type and measured inseam instead of tag size when recording hems.'
      ],
      posExamples: [
        {
          item: 'Men‚Äôs Pants',
          service: 'Dry Clean + Hem',
          before: 'Hem pants.',
          after: 'Shorten inseam to 30 inches. Customer tried on and approved.',
          why: 'Before is vague and missing the target length. After states the finished inseam and approval.'
        },
        {
          item: 'Mens Jeans',
          service: 'Hem only',
          before: 'Use tag length 32.',
          after: 'Jeans: measured and confirmed inseam to 30.5. Customer approved.',
          why: 'Tag length is unreliable; final measured inseam and garment type are recorded.'
        },
        {
          item: 'Knee-length Dress',
          service: 'Press + Hem',
          before: 'Hem to 36 inches.',
          after: 'Shorten dress so finished hem is 36 inches from shoulder to hem. Customer wearing flats.',
          why: 'Replaces ‚Äúhem to‚Äù with a clear action, final value, and context.'
        },
        {
          item: 'Blazer',
          service: 'Sleeve shorten',
          before: 'Shorten sleeves a bit.',
          after: 'Shorten sleeves to 23 inches from shoulder seam. Match both sleeves.',
          why: 'Vague wording becomes a measurable instruction with a reference point.'
        }
      ],
      scripts: {
        confirm: '‚ÄúTo make sure we get this right, I‚Äôm going to write: ‚ÄòShorten inseam to 30 inches.‚Äô Does that match what you‚Äôre expecting?‚Äù',
        clarify: 'Customer: ‚ÄúJust a bit shorter.‚Äù CSR: ‚ÄúPerfect. Let me pin the length you like and then I‚Äôll write ‚ÄòShorten inseam to __ inches‚Äô so our tailor knows exactly what you want.‚Äù',
        hemFix: '‚ÄúBecause hem is the finished edge, I‚Äôll note the action and final length: ‚ÄòShorten so finished hem is 36 inches from shoulder to hem.‚Äô‚Äù'
      },
      corrections: [
        { bad: 'Shorten a little', good: 'Shorten inseam to 29 inches.' },
        { bad: 'Fix hem', good: 'Re-hem to 30-inch inseam; clean and press.' },
        { bad: 'Take in', good: 'Take in waist to 34 inches.' },
        { bad: 'Shorten sleeves some', good: 'Shorten sleeves to 23 inches from shoulder seam.' },
        { bad: 'Use tag size for hem', good: 'Measured and confirmed inseam to 30.5; do not reference tag size.' }
      ],
      noteChecklist: [
        'Start with the garment area and final measurement: ‚ÄúINSEAM 30,‚Äù ‚ÄúWAIST 34.‚Äù',
        'Avoid ‚Äúhem‚Äù as a verb; use ‚Äúshorten to‚Äù plus the finished length.',
        'Capture approvals: ‚ÄúCustomer tried on and approved.‚Äù',
        'If customer pinned, verify with a tape and note ‚Äúcustomer pinned/verified.‚Äù',
        'Include pant type when relevant (jeans vs trousers) and avoid tag references; record the measured final value.',
        'Keep SPOT Notes factual and objective; no ‚Äúa bit‚Äù or ‚Äúas needed.‚Äù'
      ],
      quiz: [
        { type: 'mcq', question: 'Which SPOT note is correct?', options: [
          { label: 'Hem pants', value: 'a', correct: false },
          { label: 'Shorten inseam to 30 inches. Customer approved.', value: 'b', correct: true },
          { label: 'Take in 2 inches', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which phrasing avoids using ‚Äúhem‚Äù as a verb?', options: [
          { label: 'Hem to 36 inches', value: 'a', correct: false },
          { label: 'Shorten so finished hem is 36 inches from shoulder to hem', value: 'b', correct: true },
          { label: 'Hem a bit', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which note correctly replaces a tag reference?', options: [
          { label: 'Use tag inseam 32', value: 'a', correct: false },
          { label: 'Measured and confirmed inseam to 30.5; customer approved.', value: 'b', correct: true },
          { label: 'Shorten to whatever fits', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What must every note mirror back to the customer?', options: [
          { label: 'A vague sense of the change', value: 'a', correct: false },
          { label: 'The exact final measurement they approved', value: 'b', correct: true },
          { label: 'Whatever the CSR thinks is best', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which format matches SPOT standards and records pant type?', options: [
          { label: 'Jeans: shorten inseam to 30.0 (measured, customer approved)', value: 'a', correct: true },
          { label: 'Hem jeans a bit shorter', value: 'b', correct: false },
          { label: 'Use tag size since it is close', value: 'c', correct: false }
        ]}
      ]
    },
    {
      id: 'M5',
      title: 'Exceptions & Escalation ‚ö†Ô∏è',
      intro: 'Recognize tailor-only garments, protect complex pieces, and escalate with respectful, confident language.',
      objectives: [
        'Recognize garments and alteration types that are CSR-approved versus tailor-only.',
        'Decide quickly when not to pin and instead escalate to a tailor.',
        'Use clear, respectful scripts to explain escalation to customers.',
        'Apply a Customer-Pinned Protocol for complex or risky garments.',
        'Document exceptions and escalations so the tailor understands context.',
        'Prioritize safety and garment integrity over speed when making decisions.'
      ],
      tailorOnlyCategories: [
        {
          title: 'Complex or High-Risk Garments',
          items: [
            'Wedding dresses and formal gowns with multiple layers.',
            'Garments with heavy beading, sequins, or intricate lace.',
            'Custom suits or high-end designer garments with special construction.'
          ]
        },
        {
          title: 'Delicate or Specialty Fabrics',
          items: [
            'Very delicate silk, chiffon, or tulle where pinning could cause holes.',
            'Leather, suede, or coated fabrics that might mark or puncture.'
          ]
        },
        {
          title: 'Complex Alterations',
          items: [
            'Major resizing such as multiple seams, bodice work, or re-cutting.',
            'Complex jacket tailoring like shoulder work or major re-shaping.',
            'Any alteration that changes the basic structure of the garment.'
          ]
        }
      ],
      comparison: {
        csrApproved: [
          'Basic pant hems with clear final inseam.',
          'Simple waist take-ins on casual pants or skirts.',
          'Straightforward sleeve or dress length changes without embellishment.'
        ],
        tailorOnly: [
          'Heavily beaded gowns or lace overlays.',
          'Leather or suede pieces that could mark with pins.',
          'Major re-shaping that changes how a garment is built.'
        ]
      },
      customerPinnedProtocol: {
        steps: [
          'Acknowledge the customer effort and preferences.',
          'Explain the garment is complex or high-risk and needs tailor review.',
          'Do not sew or adjust until the tailor confirms the pinning.',
          'Document: ‚ÄúCustomer-pinned; tailor to review before proceeding. Do not alter until tailor approves.‚Äù'
        ],
        reminder: '‚úÖ CSR role: protect the garment, the customer‚Äôs investment, and the company‚Äôs reputation.'
      },
      escalationTriggers: [
        'Customer is unsure about what they want and the garment is complex.',
        'Fabric appears fragile or easily damaged by pins.',
        'Requested change is major (size, shape, drape).',
        'CSR feels uncomfortable or not confident about where or how to pin.',
        'Customer requests vent/split length stay unchanged while shortening a skirt or dress‚Äîtailor must plan preservation.',
        'Any measuring/pinning request involving private or near-private regions‚Äîdo not proceed; escalate to tailor/supervisor.',
        'Customer discomfort or uncertainty about contact‚Äîescalate immediately.'
      ],
      scripts: [
        {
          title: 'General Tailor-Only',
          line: 'Because of the detail and fabric on this piece, our tailor needs to handle the pinning to make sure it‚Äôs done safely and correctly. I‚Äôll note your request and have them look at it.'
        },
        {
          title: 'High-Risk Fabric',
          line: 'This fabric can mark easily if pinned the wrong way. To protect your garment, I‚Äôm going to have our tailor review and pin it personally.'
        },
        {
          title: 'Customer-Pinned Complex Garment',
          line: 'I see you‚Äôve pinned where you‚Äôd like it, thank you. Because this is a more delicate or complex piece, our tailor will double-check and confirm everything before sewing so we don‚Äôt risk damage.'
        },
        {
          title: 'When CSR Is Unsure',
          line: 'I want to make sure this turns out exactly how you expect. I‚Äôm going to have our tailor review this with your notes instead of me pinning it.'
        },
        {
          title: 'Boundary Request (Private Region)',
          line: 'This adjustment would require pinning near a private area. For your comfort and safety, our tailor lead will handle this in a fitting room.'
        }
      ],
      documentationNotes: [
        'Tailor-only: beaded bodice; customer wants length to floor with heels; tailor to pin and advise.',
        'Customer pinned train on wedding dress; tailor to review pinned length before sewing.',
        'Leather jacket shoulder reshape requested; escalate to tailor for structural plan before any pinning.',
        'Customer requests vent length unchanged while shortening skirt/dress; tailor to plan vent preservation or adjust design.',
        'Customer requested pinning near a private region; CSR escalated to tailor lead and documented boundary.'
      ],
      boundaryStatements: [
        '‚ö†Ô∏è Employees are expected to say ‚ÄúThis needs a tailor‚Äù instead of guessing on risky garments.',
        'Slowing down and escalating is safer than damaging a high-value garment.',
        'When in doubt‚Äîor if the request involves private/near-private areas‚Äîescalate rather than proceed.'
      ],
      quiz: [
        { type: 'mcq', question: 'Which garment must be escalated to the tailor?', options: [
          { label: 'Simple cotton chinos needing a hem', value: 'a', correct: false },
          { label: 'Wedding dress with beading and multiple layers', value: 'b', correct: true },
          { label: 'Casual skirt needing a basic waist take-in', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Customer pinned a delicate, beaded gown. What should you do first?', options: [
          { label: 'Accept the pins and send to the plant', value: 'a', correct: false },
          { label: 'Escalate to tailor review before altering', value: 'b', correct: true },
          { label: 'Remove all pins and start over without notes', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Feeling unsure about a complex garment is‚Ä¶', options: [
          { label: 'A signal to escalate to the tailor', value: 'a', correct: true },
          { label: 'A reason to keep pinning anyway', value: 'b', correct: false },
          { label: 'A chance to ask the customer to guess', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What documentation should you add for customer-pinned complex garments?', options: [
          { label: 'Note that a tailor must review before proceeding', value: 'a', correct: true },
          { label: 'Say nothing because pins explain it', value: 'b', correct: false },
          { label: 'Promise to sew exactly as pinned without review', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which escalation script tone best matches policy?', options: [
          { label: 'Polite, confident explanation that a tailor will review for safety', value: 'a', correct: true },
          { label: 'Telling the customer the garment is too hard to handle', value: 'b', correct: false },
          { label: 'Promising to try pinning quickly anyway', value: 'c', correct: false }
        ]}
      ]
    }
  ];

  const moduleQuestionPools = {
    M1: [
      {
        id: 'M1-Q01',
        prompt: 'Which note is objective and ready for a tailor to act on?',
        options: [
          { id: 'a', label: 'Hem pants a bit' },
          { id: 'b', label: 'Shorten inseam to 30 inches (customer approved)' },
          { id: 'c', label: 'Fix the hem' },
          { id: 'd', label: 'Take in waist some' }
        ],
        correctOptionId: 'b',
        tip: 'Use final measurements instead of vague requests.'
      },
      {
        id: 'M1-Q02',
        prompt: 'Which note should you AVOID because it hides the final measurement?',
        options: [
          { id: 'a', label: 'Shorten sleeves to 23 inches from shoulder seam' },
          { id: 'b', label: 'Shorten hem to 36 inches from floor' },
          { id: 'c', label: 'Hem 2 inches' },
          { id: 'd', label: 'INSEAM 30 (measured)' }
        ],
        correctOptionId: 'c',
        tip: 'Replace ‚Äúhem X inches‚Äù with the final dimension you measured.'
      },
      {
        id: 'M1-Q03',
        prompt: 'When a tag says INSEAM 32 but the customer wants it shorter, what is the safest note?',
        options: [
          { id: 'a', label: 'Use tag inseam 32' },
          { id: 'b', label: 'Shorten inseam to 30.5 inches (measured, customer approved)' },
          { id: 'c', label: 'Hem about 2 inches' },
          { id: 'd', label: 'Match existing hem' }
        ],
        correctOptionId: 'b',
        tip: 'Ignore tag sizes and document the measured final length.'
      },
      {
        id: 'M1-Q04',
        prompt: 'Which statement correctly defines ‚Äúhem‚Äù for this program?',
        options: [
          { id: 'a', label: 'A verb that replaces ‚Äúshorten‚Äù' },
          { id: 'b', label: 'The folded, sewn edge that needs a target length' },
          { id: 'c', label: 'Any change to a garment' },
          { id: 'd', label: 'A temporary pinning term' }
        ],
        correctOptionId: 'b',
        tip: 'State the finished length at the hem instead of using ‚Äúhem‚Äù as a verb.'
      },
      {
        id: 'M1-Q05',
        prompt: 'A customer says, ‚ÄúMake it a little shorter.‚Äù What is the MOST risky next step?',
        options: [
          { id: 'a', label: 'Ask follow-up questions and measure the exact inseam they want' },
          { id: 'b', label: 'Record ‚Äúshorten inseam to 29.5 inches‚Äù after confirming with them' },
          { id: 'c', label: 'Write ‚Äúshorten a bit‚Äù and send to the tailor' },
          { id: 'd', label: 'Show the customer the measuring tape before writing the note' }
        ],
        correctOptionId: 'c',
        tip: 'Vague notes create complaints; capture the final number instead.'
      },
      {
        id: 'M1-Q06',
        prompt: 'Which option is NOT acceptable when documenting a waist take-in?',
        options: [
          { id: 'a', label: 'Take in waist to 34 inches' },
          { id: 'b', label: 'Waist -2' },
          { id: 'c', label: 'Finished waist 36 inches (customer seated test complete)' },
          { id: 'd', label: 'Customer requests waist 33.5 inches, measured flat' }
        ],
        correctOptionId: 'b',
        tip: 'Replace plus/minus shorthand with the final waist size.'
      },
      {
        id: 'M1-Q07',
        prompt: 'For customer-pinned garments, what should you do before saving the note?',
        options: [
          { id: 'a', label: 'Trust the pins and skip measuring' },
          { id: 'b', label: 'Measure at the pins, confirm the final number aloud, and record it' },
          { id: 'c', label: 'Remove the pins and guess the length' },
          { id: 'd', label: 'Write ‚Äúas pinned‚Äù with no measurement' }
        ],
        correctOptionId: 'b',
        tip: 'Verification protects the customer and the tailor from guesswork.'
      },
      {
        id: 'M1-Q08',
        prompt: 'Which phrasing best mirrors the ‚Äúno plus/minus‚Äù rule?',
        options: [
          { id: 'a', label: 'Hem +1 inch' },
          { id: 'b', label: 'Shorten dress so finished hem is 36 inches from shoulder to hem' },
          { id: 'c', label: 'Take up sleeves 1 inch' },
          { id: 'd', label: 'Hem pants 2 inches' }
        ],
        correctOptionId: 'b',
        tip: 'State the final length or size instead of the change amount.'
      },
      {
        id: 'M1-Q09',
        prompt: 'Which instruction should you AVOID because it is most likely to be misread?',
        options: [
          { id: 'a', label: 'Finished hem 37 inches from floor with dress shoes' },
          { id: 'b', label: 'Shorten inseam to 30 inches; customer approved' },
          { id: 'c', label: 'Take in waist a little' },
          { id: 'd', label: 'Left inseam 29.5; Right inseam 30' }
        ],
        correctOptionId: 'c',
        tip: 'Avoid vague language; record the actual measurement.'
      },
      {
        id: 'M1-Q10',
        prompt: 'When confirming a measurement aloud, which script is best?',
        options: [
          { id: 'a', label: '‚ÄúI‚Äôll note shorten inseam to 30 inches. Is that exactly what you want?‚Äù' },
          { id: 'b', label: '‚ÄúHem 2 inches like normal?‚Äù' },
          { id: 'c', label: '‚ÄúWant it shorter or longer?‚Äù' },
          { id: 'd', label: '‚ÄúYou want tag size, right?‚Äù' }
        ],
        correctOptionId: 'a',
        tip: 'Repeat the final measurement, not the change amount.'
      },
      {
        id: 'M1-Q11',
        prompt: 'Which measurement note is MOST risky for the tailor?',
        options: [
          { id: 'a', label: 'Customer wearing flats: finished hem 35 inches from floor' },
          { id: 'b', label: 'Hem pants' },
          { id: 'c', label: 'Shorten sleeves to 23 inches from shoulder seam' },
          { id: 'd', label: 'Take in waist to 33 inches (customer can sit comfortably)' }
        ],
        correctOptionId: 'b',
        tip: 'Avoid using ‚Äúhem‚Äù alone; always share the final dimension.'
      },
      {
        id: 'M1-Q12',
        prompt: 'Which option is NOT acceptable when teaching a new CSR?',
        options: [
          { id: 'a', label: 'Encourage them to rewrite ‚Äúshorten a bit‚Äù into an inseam number' },
          { id: 'b', label: 'Let them save ‚Äú-2 inches‚Äù because the tailor will figure it out' },
          { id: 'c', label: 'Remind them that hems need a final target length' },
          { id: 'd', label: 'Have them confirm the measurement aloud with the customer' }
        ],
        correctOptionId: 'b',
        tip: 'Do not rely on minus/plus shorthand; use final measurements.'
      }
    ],
    M2: [
      {
        id: 'M2-Q01',
        prompt: 'Which pin choice is required for garments traveling to the plant?',
        options: [
          { id: 'a', label: 'Closed safety pins placed horizontally' },
          { id: 'b', label: 'Straight pins left in from fitting' },
          { id: 'c', label: 'No pins‚Äîjust folding the fabric' },
          { id: 'd', label: 'Paper clips for quick holds' }
        ],
        correctOptionId: 'a',
        tip: 'Traveling garments must use locked safety pins.'
      },
      {
        id: 'M2-Q02',
        prompt: 'Which option is NOT acceptable before sending a garment to the plant?',
        options: [
          { id: 'a', label: 'Replacing straight pins with safety pins' },
          { id: 'b', label: 'Leaving vertical straight pins in the hem' },
          { id: 'c', label: 'Counting pins so none are loose' },
          { id: 'd', label: 'Closing each safety pin clasp' }
        ],
        correctOptionId: 'b',
        tip: 'Vertical straight pins can slip, poke, and shift the hem.'
      },
      {
        id: 'M2-Q03',
        prompt: 'Which statement is most accurate about horizontal vs vertical pinning?',
        options: [
          { id: 'a', label: 'Horizontal pins are preferred for stability, but vertical pins are acceptable when the garment or customer needs them and you re-measure the final length' },
          { id: 'b', label: 'Vertical pins are never allowed in alterations' },
          { id: 'c', label: 'Only vertical pins should be used for hems' },
          { id: 'd', label: 'Orientation does not matter and never affects stability' }
        ],
        correctOptionId: 'a',
        tip: 'Choose the orientation that keeps the measurement clear and stable; horizontal is most secure for travel.'
      },
      {
        id: 'M2-Q04',
        prompt: 'Which statement is true about straight pins?',
        options: [
          { id: 'a', label: 'They can travel to the plant if taped' },
          { id: 'b', label: 'Use them only while supervising the garment, then swap to safety pins' },
          { id: 'c', label: 'They are safer than safety pins' },
          { id: 'd', label: 'They remove the need to count pins' }
        ],
        correctOptionId: 'b',
        tip: 'Straight pins are temporary; swap before the garment leaves.'
      },
      {
        id: 'M2-Q05',
        prompt: 'Which step should you AVOID on the pin safety checklist?',
        options: [
          { id: 'a', label: 'Skip telling the customer where pins are placed' },
          { id: 'b', label: 'Confirm pins are horizontal and closed' },
          { id: 'c', label: 'Count pins before bagging' },
          { id: 'd', label: 'Replace straight pins with safety pins' }
        ],
        correctOptionId: 'a',
        tip: 'Always inform customers about pin locations for safety.'
      },
      {
        id: 'M2-Q06',
        prompt: 'Which is the MOST risky next step after a quick fitting with straight pins?',
        options: [
          { id: 'a', label: 'Bagging the garment immediately with straight pins still in' },
          { id: 'b', label: 'Switching to safety pins and locking them' },
          { id: 'c', label: 'Smoothing the hem and verifying placement' },
          { id: 'd', label: 'Counting pins before the customer leaves' }
        ],
        correctOptionId: 'a',
        tip: 'Garments should never travel with open straight pins.'
      },
      {
        id: 'M2-Q07',
        prompt: 'Which note should you AVOID when documenting pin choices?',
        options: [
          { id: 'a', label: 'Pins replaced with closed safety pins at hem line' },
          { id: 'b', label: 'Safety pins locked, horizontal at inseam 30' },
          { id: 'c', label: 'Left straight pins to save time' },
          { id: 'd', label: 'Customer informed about pin placement' }
        ],
        correctOptionId: 'c',
        tip: 'Leaving straight pins is unsafe for transport.'
      },
      {
        id: 'M2-Q08',
        prompt: 'Which question should you ask yourself before a garment leaves the store?',
        options: [
          { id: 'a', label: 'Are the pins secure, locked, and measured for stability (horizontal preferred for travel)?' },
          { id: 'b', label: 'Did I choose orientation based on the garment and customer request?' },
          { id: 'c', label: 'Can I skip counting pins if I am rushed?' },
          { id: 'd', label: 'Should I remove all pins before the plant sees it?' }
        ],
        correctOptionId: 'a',
        tip: 'Stability, closure, and a quick pin count protect the garment during travel.'
      },
      {
        id: 'M2-Q09',
        prompt: 'Which is NOT acceptable for garments headed through racks and machinery?',
        options: [
          { id: 'a', label: 'Closed safety pins placed horizontally' },
          { id: 'b', label: 'Loose straight pins with sharp points exposed' },
          { id: 'c', label: 'Informing the customer where pins are' },
          { id: 'd', label: 'Counting and checking pin security' }
        ],
        correctOptionId: 'b',
        tip: 'Exposed points can injure people and damage garments.'
      },
      {
        id: 'M2-Q10',
        prompt: 'Which orientation helps hems survive transit?',
        options: [
          { id: 'a', label: 'Horizontal pins following the hem line' },
          { id: 'b', label: 'Vertical pins pointing toward the floor' },
          { id: 'c', label: 'Diagonal pins to speed up' },
          { id: 'd', label: 'No pins‚Äîjust hope the fold stays' }
        ],
        correctOptionId: 'a',
        tip: 'Horizontal pins protect the measurement and reduce snags.'
      },
      {
        id: 'M2-Q11',
        prompt: 'Which statement shows good communication with customers about pins?',
        options: [
          { id: 'a', label: '‚ÄúPins are in; be careful.‚Äù' },
          { id: 'b', label: '‚ÄúI placed closed safety pins horizontally at the new hem here.‚Äù' },
          { id: 'c', label: '‚ÄúWe used straight pins; hope they stay.‚Äù' },
          { id: 'd', label: '‚ÄúWe skipped pins to save time.‚Äù' }
        ],
        correctOptionId: 'b',
        tip: 'Tell customers what kind of pins you used and where.'
      },
      {
        id: 'M2-Q12',
        prompt: 'Which option is MOST risky during a rush?',
        options: [
          { id: 'a', label: 'Skipping the pin count and leaving straight pins in' },
          { id: 'b', label: 'Closing safety pins after replacing the straight pins' },
          { id: 'c', label: 'Checking that the hem stays level after pinning' },
          { id: 'd', label: 'Reminding the customer about pin placement' }
        ],
        correctOptionId: 'a',
        tip: 'Never sacrifice safety steps when busy.'
      },
      {
        id: 'M2-Q13',
        prompt: 'When pinning while a customer is still wearing the garment, what safety step is required?',
        options: [
          { id: 'a', label: 'Place your hand between the garment and the customer before inserting any pin' },
          { id: 'b', label: 'Move quickly and skip communication' },
          { id: 'c', label: 'Pin directly against the skin for accuracy' },
          { id: 'd', label: 'Avoid telling the customer what you are doing' }
        ],
        correctOptionId: 'a',
        tip: 'Protect the customer by creating a barrier and moving slowly when pinning on-body.'
      },
      {
        id: 'M2-Q14',
        prompt: 'Which statement best matches Dublin Cleaners policy for on-body pinning?',
        options: [
          { id: 'a', label: 'Pin anywhere on the body as long as you are quick' },
          { id: 'b', label: 'On-body pinning is allowed only with consent, a hand barrier, slow communication, and never in or near private regions‚Äîescalate to the tailor lead if the request requires that area' },
          { id: 'c', label: 'Measuring tapes at the inseam are always fine if the customer agrees' },
          { id: 'd', label: 'Avoid informing the customer so they stay still' }
        ],
        correctOptionId: 'b',
        tip: 'Consent, safety steps, and boundaries away from private regions are required; escalate when needed.'
      }
    ],
    M3: [
      {
        id: 'M3-Q01',
        prompt: 'What is the correct workflow for hemming trouser inseams?',
        options: [
          { id: 'a', label: 'Mark both hems while the customer wears the pants (no on-body measuring), then remove and measure each leg flat to the marked line' },
          { id: 'b', label: 'Measure the left inseam while worn and copy it to the right' },
          { id: 'c', label: 'Use the tag size instead of measuring' },
          { id: 'd', label: 'Guess a 1/4-inch difference without confirming' }
        ],
        correctOptionId: 'a',
        tip: 'Pin on-body safely, then measure off-body for objective numbers.'
      },
      {
        id: 'M3-Q02',
        prompt: 'Which is the MOST risky next step when a customer mentions one leg is shorter?',
        options: [
          { id: 'a', label: 'Pin and measure each leg separately, then record both numbers' },
          { id: 'b', label: 'Assume they match and average the lengths' },
          { id: 'c', label: 'Confirm the customer‚Äôs preferred balance if requested' },
          { id: 'd', label: 'Document left vs. right inseam if different' }
        ],
        correctOptionId: 'b',
        tip: 'Never average or assume symmetry‚Äîmeasure both legs.'
      },
      {
        id: 'M3-Q03',
        prompt: 'Why ask male customers about handedness?',
        options: [
          { id: 'a', label: 'It helps balance inseams because weight often favors one leg' },
          { id: 'b', label: 'It changes the fabric type' },
          { id: 'c', label: 'It determines the pin color' },
          { id: 'd', label: 'It is required for payment' }
        ],
        correctOptionId: 'a',
        tip: 'Handedness influences weight distribution and hem balance.'
      },
      {
        id: 'M3-Q04',
        prompt: 'Which option should you AVOID when customers bring patches?',
        options: [
          { id: 'a', label: 'Pin each patch to its specific garment' },
          { id: 'b', label: 'Leave patches loose in the bag to sort later' },
          { id: 'c', label: 'Mark the pocket or panel the patch belongs to' },
          { id: 'd', label: 'Ask the customer to choose the exact spot' }
        ],
        correctOptionId: 'b',
        tip: 'One patch should be pinned to one garment with a clear location.'
      },
      {
        id: 'M3-Q05',
        prompt: 'What should you do before measuring any garment?',
        options: [
          { id: 'a', label: 'Stretch the fabric to make it tight' },
          { id: 'b', label: 'Smooth the fabric so it lies flat without pulling' },
          { id: 'c', label: 'Skip smoothing if rushed' },
          { id: 'd', label: 'Measure only one side' }
        ],
        correctOptionId: 'b',
        tip: 'Smooth, don‚Äôt stretch‚Äîstretching adds error.'
      },
      {
        id: 'M3-Q06',
        prompt: 'Which note is NOT acceptable for garment recording?',
        options: [
          { id: 'a', label: 'Jeans: shorten inseam to 30.0 (customer wearing dress shoes).' },
          { id: 'b', label: 'Shorten sleeves to 23 inches from shoulder seam.' },
          { id: 'c', label: 'Take up inseam like usual.' },
          { id: 'd', label: 'Left inseam to 29.5; Right inseam to 30 (confirmed).' }
        ],
        correctOptionId: 'c',
        tip: 'Replace vague notes with final, measured dimensions.'
      },
      {
        id: 'M3-Q07',
        prompt: 'Customer asks you to measure his inseam while he is wearing the pants at the counter. What do you do?',
        options: [
          { id: 'a', label: 'Explain the policy, pin safely to mark the hem, have him remove the pants, then measure on a flat surface' },
          { id: 'b', label: 'Measure his inseam while he is wearing the pants for accuracy' },
          { id: 'c', label: 'Use the tag size so no measuring is needed' },
          { id: 'd', label: 'Guess a 1/4-inch difference between legs' }
        ],
        correctOptionId: 'a',
        tip: 'Use the pinned line as a guide, then measure off-body or escalate to a private fitting if needed.'
      },
      {
        id: 'M3-Q08',
        prompt: 'Which option is NOT acceptable when handling bias or knit fabric?',
        options: [
          { id: 'a', label: 'Smooth the hang line before pinning' },
          { id: 'b', label: 'Stretch the fabric to speed up pinning' },
          { id: 'c', label: 'Use multiple pins to keep the hem level' },
          { id: 'd', label: 'Confirm balance on both sides' }
        ],
        correctOptionId: 'b',
        tip: 'Stretching bias or knit fabric ruins accuracy.'
      },
      {
        id: 'M3-Q09',
        prompt: 'Which scenario requires separate measurements?',
        options: [
          { id: 'a', label: 'Customer says right leg feels longer' },
          { id: 'b', label: 'Both legs look even' },
          { id: 'c', label: 'Skirt hem with no balance concerns' },
          { id: 'd', label: 'Sleeves that match in length' }
        ],
        correctOptionId: 'a',
        tip: 'Document individual inseams when customers flag differences.'
      },
      {
        id: 'M3-Q10',
        prompt: 'Which note should you AVOID for sleeve pinning?',
        options: [
          { id: 'a', label: 'Shorten sleeves to 23 inches from shoulder seam' },
          { id: 'b', label: 'Match both sleeves at wrist bone' },
          { id: 'c', label: 'Hem sleeves' },
          { id: 'd', label: 'Check lining before pinning' }
        ],
        correctOptionId: 'c',
        tip: '‚ÄúHem sleeves‚Äù is vague‚Äîinclude the final length.'
      },
      {
        id: 'M3-Q11',
        prompt: 'Which action is NOT allowed when handling trouser inseams?',
        options: [
          { id: 'a', label: 'Measuring the inseam on the customer while they are wearing the pants' },
          { id: 'b', label: 'Marking hems while worn, then measuring each leg on a flat surface' },
          { id: 'c', label: 'Confirming left vs. right inseam differences aloud' },
          { id: 'd', label: 'Recording the final numbers with garment type' }
        ],
        correctOptionId: 'a',
        tip: 'Never take a tape measure to the customer‚Äôs inseam while worn.'
      },
      {
        id: 'M3-Q12',
        prompt: 'Which is NOT acceptable when documenting drape differences?',
        options: [
          { id: 'a', label: 'Note pant type and shoe choice if it affects length' },
          { id: 'b', label: 'Write ‚Äútake up inseam like usual‚Äù' },
          { id: 'c', label: 'Record exact inseam numbers for both legs if different' },
          { id: 'd', label: 'Mention customer‚Äôs preference for a slightly longer side if confirmed' }
        ],
        correctOptionId: 'b',
        tip: 'Avoid casual phrases‚Äîuse specific measurements and context.'
      },
      {
        id: 'M3-Q13',
        prompt: 'You are shortening a dress with a back vent. What must you do before finalizing the pinning?',
        options: [
          { id: 'a', label: 'Confirm the customer is okay with the vent becoming shorter or escalate to a tailor to preserve it' },
          { id: 'b', label: 'Ignore the vent because hems and vents are unrelated' },
          { id: 'c', label: 'Sew the vent closed to avoid work' },
          { id: 'd', label: 'Skip measurement and guess the vent length' }
        ],
        correctOptionId: 'a',
        tip: 'Shortening changes vent length‚Äîconfirm approval or escalate for preservation.'
      }
    ],
    M4: [
      {
        id: 'M4-Q01',
        prompt: 'Which SPOT note format is objective and clear?',
        options: [
          { id: 'a', label: 'Hem pants' },
          { id: 'b', label: 'Shorten inseam to 30 inches. Customer tried on and approved.' },
          { id: 'c', label: 'Take in a little' },
          { id: 'd', label: 'Use tag 32' }
        ],
        correctOptionId: 'b',
        tip: 'Use final measurements and note the approval.'
      },
      {
        id: 'M4-Q02',
        prompt: 'Which note should you AVOID because it uses ‚Äúhem‚Äù as a verb?',
        options: [
          { id: 'a', label: 'Shorten sleeves to 23 inches from shoulder seam.' },
          { id: 'b', label: 'Hem dress 2 inches.' },
          { id: 'c', label: 'Finished hem 36 inches from floor with flats.' },
          { id: 'd', label: 'INSEAM 30 (measured, not tag).' }
        ],
        correctOptionId: 'b',
        tip: 'Replace ‚Äúhem‚Äù with ‚Äúshorten to‚Äù plus the final dimension.'
      },
      {
        id: 'M4-Q03',
        prompt: 'Which is the MOST risky next step after seeing ‚ÄúUse tag length 32‚Äù in notes?',
        options: [
          { id: 'a', label: 'Measure the inseam and rewrite with the real number' },
          { id: 'b', label: 'Leave the tag length because it is fast' },
          { id: 'c', label: 'Confirm the customer‚Äôs preferred final length' },
          { id: 'd', label: 'Note shoe type if it affects drape' }
        ],
        correctOptionId: 'b',
        tip: 'Tag sizes are not reliable; measure and record the final number.'
      },
      {
        id: 'M4-Q04',
        prompt: 'Which option is NOT acceptable in the Notes field?',
        options: [
          { id: 'a', label: 'Shorten inseam to 29 inches (customer pinned, verified).' },
          { id: 'b', label: 'Hem to whatever you think looks best.' },
          { id: 'c', label: 'Jeans: shorten inseam to 30.0 (measured).' },
          { id: 'd', label: 'Take in waist to 34 inches; customer can sit comfortably.' }
        ],
        correctOptionId: 'b',
        tip: 'Avoid vague instructions; state the final measurement and context.'
      },
      {
        id: 'M4-Q05',
        prompt: 'Which note mirrors the customer‚Äôs expectation and the tailor‚Äôs need?',
        options: [
          { id: 'a', label: 'Hem pants a bit' },
          { id: 'b', label: 'Finished hem 36 inches from floor with flats' },
          { id: 'c', label: 'Take in some' },
          { id: 'd', label: 'Shorten like last time' }
        ],
        correctOptionId: 'b',
        tip: 'State the finished measurement and any shoe or drape context.'
      },
      {
        id: 'M4-Q06',
        prompt: 'Which option is NOT acceptable when training a new CSR on SPOT notes?',
        options: [
          { id: 'a', label: 'Approve ‚Äúhem sleeves‚Äù as a final note' },
          { id: 'b', label: 'Show them how to use INSEAM 30 format' },
          { id: 'c', label: 'Model repeating the measurement back to the customer' },
          { id: 'd', label: 'Remind them to include garment type when relevant' }
        ],
        correctOptionId: 'a',
        tip: 'Avoid ‚Äúhem‚Äù as a verb; use objective language.'
      },
      {
        id: 'M4-Q07',
        prompt: 'Which statement should be avoided because it leaves gaps?',
        options: [
          { id: 'a', label: 'Customer tried on and approved length with normal shoes.' },
          { id: 'b', label: 'Shorten inseam to 30 inches.' },
          { id: 'c', label: 'Hem it' },
          { id: 'd', label: 'Measured and confirmed inseam to 30.5.' }
        ],
        correctOptionId: 'c',
        tip: 'Notes should stand alone without guessing.'
      },
      {
        id: 'M4-Q08',
        prompt: 'Which is the MOST risky next step after reading ‚ÄúHem to 36 inches‚Äù?',
        options: [
          { id: 'a', label: 'Rewrite as ‚ÄúFinished hem 36 inches from floor‚Äù and confirm with customer' },
          { id: 'b', label: 'Assume it means shorten to 36 inches without context' },
          { id: 'c', label: 'Check if shoe type affects the length' },
          { id: 'd', label: 'Verify the measurement with the customer' }
        ],
        correctOptionId: 'b',
        tip: 'Clarify wording and context instead of assuming.'
      },
      {
        id: 'M4-Q09',
        prompt: 'Which option is NOT acceptable for customer-pinned garments in SPOT?',
        options: [
          { id: 'a', label: 'Shorten inseam to 29 inches (customer pinned, verified).' },
          { id: 'b', label: 'Note tailor review if garment is complex' },
          { id: 'c', label: 'Record ‚Äúas pinned‚Äù with no measurement' },
          { id: 'd', label: 'Confirm final measurement aloud before saving' }
        ],
        correctOptionId: 'c',
        tip: 'Include the verified measurement even when the customer pinned.'
      },
      {
        id: 'M4-Q10',
        prompt: 'Which note best uses the standard format?',
        options: [
          { id: 'a', label: 'Hem pants 2 inches' },
          { id: 'b', label: 'INSEAM 30; customer wearing dress shoes' },
          { id: 'c', label: 'Shorten some' },
          { id: 'd', label: 'Use tag 34' }
        ],
        correctOptionId: 'b',
        tip: 'Lead with INSEAM/WAIST/SLEEVE + number and context.'
      },
      {
        id: 'M4-Q11',
        prompt: 'Which option is NOT acceptable when correcting vague notes?',
        options: [
          { id: 'a', label: 'Change ‚Äúhem pants‚Äù to ‚ÄúShorten inseam to 30 inches.‚Äù' },
          { id: 'b', label: 'Leave ‚Äútake in 2 inches‚Äù as-is' },
          { id: 'c', label: 'Replace ‚Äúuse tag size‚Äù with the measured inseam' },
          { id: 'd', label: 'Add garment type when drape matters' }
        ],
        correctOptionId: 'b',
        tip: 'Convert change amounts into final measurements.'
      },
      {
        id: 'M4-Q12',
        prompt: 'Which note supports the tailor MOST clearly?',
        options: [
          { id: 'a', label: 'Hem sleeves' },
          { id: 'b', label: 'Shorten sleeves to 23 inches from shoulder seam; match both sleeves.' },
          { id: 'c', label: 'Shorter sleeves please' },
          { id: 'd', label: 'Use previous length' }
        ],
        correctOptionId: 'b',
        tip: 'Specific measurements and match instructions remove guesswork.'
      }
    ],
    M5: [
      {
        id: 'M5-Q01',
        prompt: 'Which garment must be escalated to the tailor?',
        options: [
          { id: 'a', label: 'Simple cotton chinos needing a hem' },
          { id: 'b', label: 'Wedding dress with beading and multiple layers' },
          { id: 'c', label: 'Casual skirt needing a basic waist take-in' },
          { id: 'd', label: 'Jeans with small patch request' }
        ],
        correctOptionId: 'b',
        tip: 'Complex, delicate garments require tailor-only handling.'
      },
      {
        id: 'M5-Q02',
        prompt: 'Which note should you AVOID when unsure about a complex garment?',
        options: [
          { id: 'a', label: '‚ÄúTailor to review before any pinning; delicate beading.‚Äù' },
          { id: 'b', label: '‚ÄúCustomer pinned; tailor to confirm before sewing.‚Äù' },
          { id: 'c', label: '‚ÄúI will guess the pinning to save time.‚Äù' },
          { id: 'd', label: '‚ÄúEscalated to tailor for plan and approval.‚Äù' }
        ],
        correctOptionId: 'c',
        tip: 'Never guess on complex garments‚Äîescalate instead.'
      },
      {
        id: 'M5-Q03',
        prompt: 'Which is the MOST risky next step when a customer pins a delicate gown?',
        options: [
          { id: 'a', label: 'Escalate to tailor review before altering' },
          { id: 'b', label: 'Accept the pins and send to the plant without review' },
          { id: 'c', label: 'Document that tailor must review before sewing' },
          { id: 'd', label: 'Thank the customer and explain the review process' }
        ],
        correctOptionId: 'b',
        tip: 'Customer pins on delicate garments still need tailor approval.'
      },
      {
        id: 'M5-Q04',
        prompt: 'Which statement reflects the escalation mindset?',
        options: [
          { id: 'a', label: 'If you feel unsure, ask the tailor to review and pin' },
          { id: 'b', label: 'Pin it quickly so the line moves' },
          { id: 'c', label: 'Assume the customer‚Äôs pins are enough for any fabric' },
          { id: 'd', label: 'Skip documentation to avoid scaring the customer' }
        ],
        correctOptionId: 'a',
        tip: 'Escalate when uncomfortable instead of guessing.'
      },
      {
        id: 'M5-Q05',
        prompt: 'Which note should you AVOID because it omits a safety check?',
        options: [
          { id: 'a', label: 'Tailor-only: beaded bodice; review before pinning.' },
          { id: 'b', label: 'Customer pinned train; tailor to confirm length before sewing.' },
          { id: 'c', label: 'Proceed without tailor even though fabric is fragile.' },
          { id: 'd', label: 'Escalate leather jacket shoulder reshape to tailor for plan.' }
        ],
        correctOptionId: 'c',
        tip: 'High-risk fabric demands tailor oversight.'
      },
      {
        id: 'M5-Q06',
        prompt: 'Which communication is MOST aligned with policy?',
        options: [
          { id: 'a', label: '‚ÄúBecause of the detail, our tailor will review this to keep it safe.‚Äù' },
          { id: 'b', label: '‚ÄúThis is too hard; I guess we will try.‚Äù' },
          { id: 'c', label: '‚ÄúWe will sew it exactly as pinned without looking.‚Äù' },
          { id: 'd', label: '‚ÄúI am not sure, but I will just pin something.‚Äù' }
        ],
        correctOptionId: 'a',
        tip: 'Be confident and clear about tailor review for safety.'
      },
      {
        id: 'M5-Q07',
        prompt: 'Which is NOT acceptable when documenting boundary statements?',
        options: [
          { id: 'a', label: 'Say ‚ÄúThis needs a tailor‚Äù instead of guessing on risky garments.' },
          { id: 'b', label: 'Promise to pin quickly even if unsure.' },
          { id: 'c', label: 'Note that complex fabrics require tailor review.' },
          { id: 'd', label: 'Explain that slowing down prevents damage.' }
        ],
        correctOptionId: 'b',
        tip: 'Never promise to guess; escalate instead.'
      },
      {
        id: 'M5-Q08',
        prompt: 'Which option is MOST risky when a garment feels fragile?',
        options: [
          { id: 'a', label: 'Escalate to tailor for plan before any pinning' },
          { id: 'b', label: 'Document the risk and ask the tailor to review' },
          { id: 'c', label: 'Proceed with pins even though you feel uncomfortable' },
          { id: 'd', label: 'Thank the customer and explain the review step' }
        ],
        correctOptionId: 'c',
        tip: 'Discomfort is a sign to stop and escalate.'
      },
      {
        id: 'M5-Q09',
        prompt: 'Which note protects both the garment and the team?',
        options: [
          { id: 'a', label: 'Tailor-only: delicate lace; no alterations until tailor confirms plan.' },
          { id: 'b', label: 'Do whatever seems fastest' },
          { id: 'c', label: 'Skip notes; tailor will guess' },
          { id: 'd', label: 'Promise to sew it today without review' }
        ],
        correctOptionId: 'a',
        tip: 'Documentation should direct the tailor and guard against risk.'
      },
      {
        id: 'M5-Q10',
        prompt: 'Which option is NOT acceptable after seeing a customer-pin on a leather jacket?',
        options: [
          { id: 'a', label: 'Escalate to tailor for structural plan before any pinning' },
          { id: 'b', label: 'Document that tailor must review customer pins' },
          { id: 'c', label: 'Tell customer you will guess the pinning to keep things moving' },
          { id: 'd', label: 'Protect the garment and reputation by slowing down' }
        ],
        correctOptionId: 'c',
        tip: 'Guessing on leather risks damage; tailor must lead.'
      },
      {
        id: 'M5-Q11',
        prompt: 'Which is the MOST risky next step when you feel unsure about the fabric?',
        options: [
          { id: 'a', label: 'Stop and ask the tailor to review' },
          { id: 'b', label: 'Document the risk and defer to tailor' },
          { id: 'c', label: 'Keep pinning anyway to avoid delay' },
          { id: 'd', label: 'Explain to the customer that the tailor will advise' }
        ],
        correctOptionId: 'c',
        tip: 'Uncertainty means escalate, not proceed.'
      },
      {
        id: 'M5-Q12',
        prompt: 'Which communication best sets expectations for tailor review?',
        options: [
          { id: 'a', label: '‚ÄúOur tailor will double-check this delicate fabric before we pin anything.‚Äù' },
          { id: 'b', label: '‚ÄúWe will guess the fit now to save time.‚Äù' },
          { id: 'c', label: '‚ÄúWe do not have time to escalate.‚Äù' },
          { id: 'd', label: '‚ÄúPins are already in; no need for review.‚Äù' }
        ],
        correctOptionId: 'a',
        tip: 'Set a confident, safety-focused expectation for tailor review.'
      },
      {
        id: 'M5-Q13',
        prompt: 'A customer wants a skirt vent to stay the same length even though the hem will be shortened. What is the correct next step?',
        options: [
          { id: 'a', label: 'Escalate to the tailor to plan how to preserve or rebuild the vent before pinning' },
          { id: 'b', label: 'Pin and promise the vent will stay the same without checking' },
          { id: 'c', label: 'Ignore the request and shorten normally' },
          { id: 'd', label: 'Remove the vent entirely without asking' }
        ],
        correctOptionId: 'a',
        tip: 'Vent preservation or redesign requires tailor planning‚Äîdo not promise it at the counter.'
      },
      {
        id: 'M5-Q14',
        prompt: 'Customer requests pinning near a private region to get a precise fit. What is the correct next step?',
        options: [
          { id: 'a', label: 'Proceed carefully and hope it is okay' },
          { id: 'b', label: 'Explain the boundary, do not pin there, and escalate to the tailor lead/supervisor for a professional fitting option' },
          { id: 'c', label: 'Take a quick measurement on-body to save time' },
          { id: 'd', label: 'Ignore discomfort and continue pinning' }
        ],
        correctOptionId: 'b',
        tip: 'Any request involving private or near-private regions must be escalated without proceeding.'
      }
    ]
  };

  const moduleTimeEstimates = {
    M1: 20,
    M2: 15,
    M3: 25,
    M4: 20,
    M5: 20
  };

  const QUESTIONS_PER_MODULE = 6;
  const PASSING_CORRECT_REQUIRED = 5;
  const PASSING_SCORE_PERCENT = 83;
  const PASSING_MESSAGE = `Score ${PASSING_CORRECT_REQUIRED} of ${QUESTIONS_PER_MODULE} correct (${PASSING_SCORE_PERCENT}%) to pass.`;
  const totalProgramMinutes = Object.values(moduleTimeEstimates).reduce((sum, minutes) => sum + minutes, 0);
  const autoAdvanceOnPass = false;
  const toastDurationMs = 3800;

  let lastCertificationStatus = null;
  const activeQuizState = {};
  let toastTimeoutRef = null;
  let activeLockoutStatus = null;
  let lockoutTimerId = null;
  let finalOutcomeTimerId = null;
  let finalOutcomePreviousFocus = null;
  let finalOutcomeKeydownHandler = null;

  function showToast(message, type = 'info') {
    const toast = document.getElementById('global-toast');
    if (!toast) return;
    toast.textContent = message;
    toast.setAttribute('aria-live', 'polite');
    toast.className = `toast toast--${type}`;
    toast.style.opacity = '1';
    if (toastTimeoutRef) {
      clearTimeout(toastTimeoutRef);
    }
    toastTimeoutRef = setTimeout(() => {
      toast.style.opacity = '0';
    }, toastDurationMs);
  }

  function formatLockoutCountdown(durationMs) {
    const safeMs = Math.max(0, durationMs || 0);
    const totalSeconds = Math.floor(safeMs / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }

  function shouldShowLockoutUI(status) {
    const hasFailedModules = Array.isArray(status?.failedModules)
      ? status.failedModules.length > 0
      : false;
    return !!(
      status &&
      status.hasCompletedAllModules === true &&
      hasFailedModules &&
      status.isCertified === false &&
      status.isLocked === true &&
      status.msRemaining > 0
    );
  }

  function toggleQuizInputs(moduleId, disabled) {
    const host = document.getElementById(getQuizHostId(moduleId));
    if (!host) return;
    const inputs = host.querySelectorAll('input');
    inputs.forEach(input => {
      if (disabled) {
        input.dataset.lockoutDisabled = 'true';
        input.setAttribute('disabled', 'disabled');
      } else if (input.dataset.lockoutDisabled === 'true') {
        input.removeAttribute('disabled');
        delete input.dataset.lockoutDisabled;
      }
    });
  }

  function toggleButtonLockoutState(button, isLocked) {
    if (!button) return;
    if (isLocked) {
      button.dataset.lockoutDisabled = 'true';
      button.setAttribute('disabled', 'disabled');
      button.setAttribute('aria-disabled', 'true');
    } else if (button.dataset.lockoutDisabled === 'true') {
      if (!button.hasAttribute('aria-busy')) {
        button.removeAttribute('disabled');
        button.setAttribute('aria-disabled', 'false');
      }
      delete button.dataset.lockoutDisabled;
    }
  }

  function setQuizLockoutBanner(moduleId, isLocked) {
    const banner = document.getElementById(`module${getModuleNumber(moduleId)}-lockout-banner`);
    if (!banner) return;
    if (isLocked) {
      banner.removeAttribute('hidden');
    } else {
      banner.setAttribute('hidden', 'hidden');
    }
  }

  function updateLockoutCountdown() {
    if (!shouldShowLockoutUI(activeLockoutStatus) || !activeLockoutStatus.lockoutUntilEpochMs) {
      return;
    }
    const msRemaining = Math.max(activeLockoutStatus.lockoutUntilEpochMs - Date.now(), 0);
    if (msRemaining <= 0) {
      if (lockoutTimerId) {
        clearInterval(lockoutTimerId);
        lockoutTimerId = null;
      }
      refreshLockoutStatus();
      return;
    }
    activeLockoutStatus.msRemaining = msRemaining;

    modules.forEach(module => {
      const timer = document.getElementById(`module${getModuleNumber(module.id)}-lockout-timer`);
      if (timer) {
        timer.textContent = formatLockoutCountdown(msRemaining);
      }
    });
  }

  function applyLockoutStatus(status) {
    activeLockoutStatus = status || {
      isLocked: false,
      isCertified: false,
      hasCompletedAllModules: false,
      msRemaining: 0,
      failedModules: []
    };
    if (!Array.isArray(activeLockoutStatus.failedModules)) {
      activeLockoutStatus.failedModules = [];
    }
    const isLocked = shouldShowLockoutUI(activeLockoutStatus);

    modules.forEach(module => {
      const moduleId = module.id;
      const submitButton = document.getElementById(getQuizButtonId(moduleId));
      const retakeButton = document.getElementById(getQuizRetakeId(moduleId));
      const quizHost = document.getElementById(getQuizHostId(moduleId));
      const quizCard = quizHost ? quizHost.closest('.quiz') : null;

      toggleButtonLockoutState(submitButton, isLocked);
      toggleButtonLockoutState(retakeButton, isLocked);
      toggleQuizInputs(moduleId, isLocked);
      setQuizLockoutBanner(moduleId, isLocked);

      if (quizCard) {
        quizCard.classList.toggle('quiz-locked', isLocked);
      }
    });

    if (lockoutTimerId) {
      clearInterval(lockoutTimerId);
      lockoutTimerId = null;
    }
    if (isLocked) {
      updateLockoutCountdown();
      lockoutTimerId = setInterval(updateLockoutCountdown, 1000);
    }
  }

  function refreshLockoutStatus() {
    const name = getEmployeeName();
    if (!name) {
      applyLockoutStatus({ isLocked: false, isCertified: false, hasCompletedAllModules: false, msRemaining: 0 });
      return;
    }
    const location = getEmployeeLocation();
    if (google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(status => applyLockoutStatus(status))
        .withFailureHandler(err => {
          console.error('Could not load lockout status', err);
        })
        .getEmployeeLockoutStatus(name, location);
    }
  }

  function fetchLockoutStatusByName(name, location) {
    if (!google.script || !google.script.run) {
      return Promise.resolve(activeLockoutStatus);
    }

    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(status => {
          resolve(status);
        })
        .withFailureHandler(err => {
          showToast('Unable to refresh lockout status right now.', 'error');
          reject(err);
        })
        .getEmployeeLockoutStatus(name, location);
    });
  }

  function setLoading(elId, isLoading, loadingLabel = 'Loading‚Ä¶') {
    const el = document.getElementById(elId);
    if (!el) return;
    const originalLabel = el.dataset.originalLabel || el.textContent;
    if (isLoading) {
      el.dataset.originalLabel = originalLabel;
      el.textContent = loadingLabel;
      el.setAttribute('aria-busy', 'true');
      el.setAttribute('disabled', 'disabled');
    } else {
      el.textContent = el.dataset.originalLabel || originalLabel;
      el.removeAttribute('aria-busy');
      el.removeAttribute('disabled');
    }
  }

  function saveEmployeeInputsToLocal() {
    try {
      localStorage.setItem('dublinCertEmployeeName', getEmployeeName());
      localStorage.setItem('dublinCertEmployeeLocation', getEmployeeLocation());
    } catch (err) {
      console.log('Local storage unavailable', err);
    }
  }

  function loadEmployeeInputsFromLocal() {
    try {
      const name = localStorage.getItem('dublinCertEmployeeName');
      const location = localStorage.getItem('dublinCertEmployeeLocation');
      if (name) {
        document.getElementById('employeeName').value = name;
      }
      if (location) {
        document.getElementById('employeeLocation').value = location;
      }
      if (name) {
        loadCertificationStatus();
      }
    } catch (err) {
      console.log('Local storage unavailable', err);
    }
  }

  function validateEmployeeName() {
    const errorEl = document.getElementById('employee-input-error');
    const name = getEmployeeName();
    if (!errorEl) return !!name;
    if (!name) {
      errorEl.textContent = 'Employee name is required before saving or submitting quizzes.';
      return false;
    }
    errorEl.textContent = '';
    return true;
  }

  function escapeHtml(value) {
    return (value || '').toString()
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function getFinalOutcomeElements() {
    return {
      overlay: document.getElementById('final-outcome-modal-overlay'),
      modal: document.getElementById('final-outcome-modal'),
      title: document.getElementById('final-outcome-title'),
      body: document.getElementById('final-outcome-body'),
      primaryButton: document.getElementById('final-outcome-primary-btn'),
      secondaryButton: document.getElementById('final-outcome-secondary-btn'),
      closeButton: document.getElementById('final-outcome-close-btn')
    };
  }

  function getFocusableElements(container) {
    if (!container) return [];
    const focusableSelectors = [
      'button:not([disabled])',
      '[href]',
      'input:not([disabled])',
      'select:not([disabled])',
      'textarea:not([disabled])',
      '[tabindex]:not([tabindex="-1"])'
    ];
    return Array.from(container.querySelectorAll(focusableSelectors.join(','))).filter(el => !el.hasAttribute('disabled'));
  }

  function stopFinalOutcomeCountdown() {
    if (finalOutcomeTimerId) {
      clearInterval(finalOutcomeTimerId);
      finalOutcomeTimerId = null;
    }
  }

  function startFinalOutcomeCountdown(lockoutStatus) {
    stopFinalOutcomeCountdown();
    const timerEl = document.getElementById('final-outcome-lockout-timer');
    if (!timerEl || !lockoutStatus || !lockoutStatus.lockoutUntilEpochMs) {
      return;
    }

    const updateTimer = () => {
      const msRemaining = Math.max(lockoutStatus.lockoutUntilEpochMs - Date.now(), 0);
      timerEl.textContent = formatLockoutCountdown(msRemaining);
      if (msRemaining <= 0) {
        stopFinalOutcomeCountdown();
      }
    };

    updateTimer();
    finalOutcomeTimerId = setInterval(updateTimer, 1000);
  }

  function openFinalOutcomeModal() {
    const { overlay, modal } = getFinalOutcomeElements();
    if (!overlay || !modal) return;
    finalOutcomePreviousFocus = document.activeElement;
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden', 'false');
    document.body.classList.add('modal-open');

    finalOutcomeKeydownHandler = event => {
      if (event.key === 'Escape') {
        event.preventDefault();
        closeFinalOutcomeModal();
        return;
      }

      if (event.key !== 'Tab') {
        return;
      }

      const focusable = getFocusableElements(modal);
      if (focusable.length === 0) {
        event.preventDefault();
        return;
      }
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (event.shiftKey && document.activeElement === first) {
        event.preventDefault();
        last.focus();
      } else if (!event.shiftKey && document.activeElement === last) {
        event.preventDefault();
        first.focus();
      }
    };

    document.addEventListener('keydown', finalOutcomeKeydownHandler);
    const focusable = getFocusableElements(modal);
    (focusable[0] || modal).focus();
  }

  function closeFinalOutcomeModal() {
    const { overlay } = getFinalOutcomeElements();
    if (!overlay) return;
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('modal-open');
    stopFinalOutcomeCountdown();

    if (finalOutcomeKeydownHandler) {
      document.removeEventListener('keydown', finalOutcomeKeydownHandler);
      finalOutcomeKeydownHandler = null;
    }

    if (finalOutcomePreviousFocus && typeof finalOutcomePreviousFocus.focus === 'function') {
      finalOutcomePreviousFocus.focus();
    }
  }

  function setFinalOutcomeButton(button, label, handler) {
    if (!button) return;
    button.textContent = label;
    button.onclick = handler;
  }

  function showFinalOutcomeModalContent({ title, bodyHtml, primaryLabel, primaryAction, secondaryLabel }) {
    const { title: titleEl, body, primaryButton, secondaryButton } = getFinalOutcomeElements();
    if (titleEl) {
      titleEl.textContent = title;
    }
    if (body) {
      body.innerHTML = bodyHtml;
    }
    setFinalOutcomeButton(primaryButton, primaryLabel, primaryAction);
    if (secondaryButton) {
      secondaryButton.textContent = secondaryLabel || 'Close';
      secondaryButton.onclick = closeFinalOutcomeModal;
    }
    openFinalOutcomeModal();
  }

  function showFinalOutcomePassModal(employeeName) {
    const safeName = escapeHtml(employeeName);
    const bodyHtml = `
      <p>Congratulations, <strong>${safeName}</strong>! You have successfully completed the Dublin Cleaners Alterations Pinning Certification Program.</p>
      <p>You are now authorized to pin eligible garments in-store according to Dublin Cleaners standards.</p>
    `;

    showFinalOutcomeModalContent({
      title: '‚úÖ PASS ‚Äî Certified Alteration Pinner',
      bodyHtml: bodyHtml,
      primaryLabel: 'Generate Certificate (PDF)',
      primaryAction: () => {
        closeFinalOutcomeModal();
        handlePrintCertificate();
      },
      secondaryLabel: 'Close'
    });
  }

  function showFinalOutcomeFailModal(employeeName, lockoutStatus) {
    const safeName = escapeHtml(employeeName);
    const hasActiveLockout = !!(lockoutStatus && lockoutStatus.isLocked && lockoutStatus.msRemaining > 0);
    const countdownHtml = hasActiveLockout
      ? `<p class="modal-countdown">You can retake in: <span id="final-outcome-lockout-timer">${formatLockoutCountdown(lockoutStatus.msRemaining)}</span></p>`
      : '<p class="modal-countdown">Retake availability is being updated. Please refresh.</p>';

    const bodyHtml = `
      <p><strong>${safeName}</strong>, you completed all 5 modules, but did not meet the passing requirement (83%+ per module).</p>
      <p>Please review the modules and retake the quizzes after the required waiting period.</p>
      ${countdownHtml}
    `;

    showFinalOutcomeModalContent({
      title: '‚ùå FAIL ‚Äî Not Certified Yet',
      bodyHtml: bodyHtml,
      primaryLabel: 'Review Modules',
      primaryAction: () => {
        closeFinalOutcomeModal();
        navigateToSection('dashboard');
      },
      secondaryLabel: 'Close'
    });

    if (hasActiveLockout) {
      startFinalOutcomeCountdown(lockoutStatus);
    }
  }

  function handleFinalOutcomeAfterModuleFive() {
    const name = getEmployeeName();
    if (!name) return;
    const location = getEmployeeLocation();

    Promise.all([
      fetchCertificationStatusByName(name),
      fetchLockoutStatusByName(name, location)
    ])
      .then(([status, lockoutStatus]) => {
        const hasCompletedAllModules = !!(
          lockoutStatus && lockoutStatus.hasCompletedAllModules === true
        );
        if (!hasCompletedAllModules) {
          return;
        }

        if (status && status.isCertified) {
          showFinalOutcomePassModal(name);
        } else {
          showFinalOutcomeFailModal(name, lockoutStatus);
        }
      })
      .catch(err => {
        console.error('Could not load final outcome status', err);
      });
  }

  function setupFinalOutcomeModal() {
    const { overlay, closeButton, secondaryButton, modal } = getFinalOutcomeElements();
    if (closeButton) {
      closeButton.addEventListener('click', closeFinalOutcomeModal);
    }
    if (secondaryButton) {
      secondaryButton.addEventListener('click', closeFinalOutcomeModal);
    }
    if (overlay) {
      overlay.addEventListener('click', event => {
        if (event.target === overlay) {
          closeFinalOutcomeModal();
        }
      });
    }
    if (modal) {
      modal.setAttribute('tabindex', '-1');
    }
  }

  function debounce(fn, delay = 150) {
    let timeoutId;
    return (...args) => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => fn(...args), delay);
    };
  }

  function updateStickyOffsets() {
    const header = document.querySelector('.app-header');
    if (!header) return;
    const headerHeight = Math.ceil(header.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--header-height', `${headerHeight}px`);
  }

  const debouncedStickyUpdate = debounce(updateStickyOffsets, 150);
  window.addEventListener('load', updateStickyOffsets);

  document.addEventListener('DOMContentLoaded', () => {
    updateStickyOffsets();
    window.addEventListener('resize', debouncedStickyUpdate);
    setTotalEstimateText();
    setRemainingEstimatePlaceholder();
    renderNavigation();
    renderModules();
    initializeModuleQuizzes();
    bindIdentityPersistence();
    loadEmployeeInputsFromLocal();
    updateCertificateButtonState(lastCertificationStatus);
    setupPrintCertificateButton();
    setupFinalOutcomeModal();
    const initialHash = window.location.hash?.replace('#', '');
    if (initialHash) {
      navigateToSection(initialHash.startsWith('module-') ? initialHash : initialHash, null, true);
    } else {
      updateNavShift('dashboard');
    }
  });

  function setTotalEstimateText() {
    const totalEstimateEl = document.getElementById('total-time-estimate');
    if (totalEstimateEl) {
      totalEstimateEl.textContent = `Estimated time for full certification: ${formatMinutes(totalProgramMinutes)}.`;
    }
  }

  function setRemainingEstimatePlaceholder() {
    const remainingEstimateEl = document.getElementById('remaining-time-estimate');
    if (remainingEstimateEl) {
      remainingEstimateEl.textContent = 'Estimated time remaining: enter your name to calculate.';
    }
  }

  function getEmployeeName() {
    return document.getElementById('employeeName').value.trim();
  }

  function getEmployeeLocation() {
    return document.getElementById('employeeLocation').value.trim();
  }

  function updateCertificateButtonState(status) {
    const isCertified = !!(status && status.isCertified);
    const buttons = [
      document.getElementById('print-certificate-button'),
      document.getElementById('header-certificate-button')
    ];

    buttons.forEach(btn => {
      if (!btn) return;
      if (isCertified) {
        btn.removeAttribute('disabled');
        btn.setAttribute('aria-disabled', 'false');
        btn.title = 'Generate certificate PDF for this certified employee.';
      } else {
        btn.setAttribute('disabled', 'disabled');
        btn.setAttribute('aria-disabled', 'true');
        btn.title = 'Pass all five modules to unlock certificate printing';
      }
    });
  }

  function formatMinutes(minutes) {
    if (minutes <= 0) return '~0 minutes';
    const hours = Math.floor(minutes / 60);
    const remainingMinutes = minutes % 60;
    if (!hours) {
      return `~${minutes} minute${minutes === 1 ? '' : 's'}`;
    }
    const hourLabel = `${hours} hr${hours === 1 ? '' : 's'}`;
    const minuteLabel = remainingMinutes ? ` ${remainingMinutes} min` : '';
    return `~${hourLabel}${minuteLabel}`;
  }

  function calculateRemainingMinutes(missingModules = []) {
    return missingModules.reduce((total, moduleId) => total + (moduleTimeEstimates[moduleId] || 0), 0);
  }

  function updateTimeEstimates(missingModules) {
    const remainingEstimateEl = document.getElementById('remaining-time-estimate');
    const remainingMinutes = calculateRemainingMinutes(missingModules || []);
    if (remainingEstimateEl) {
      remainingEstimateEl.textContent = `Estimated time remaining: ${formatMinutes(remainingMinutes)}`;
    }
  }

  function renderNavigation() {
    const navList = document.getElementById('navList');
    navList.innerHTML = modules
      .map(module => `<li><button class="nav-link" data-target="module-${module.id}" onclick="navigateToSection('module-${module.id}', this)">${module.id} ‚Äî ${module.title}</button></li>`)
      .join('');
  }

  function renderModules() {
    const container = document.getElementById('moduleContainer');
    container.innerHTML = modules.map(module => moduleTemplate(module)).join('');
  }

  function renderModuleNavigation(moduleId) {
    const moduleNumber = parseInt(moduleId.replace('M', ''), 10);
    const totalModules = modules.length;
    const hasPrevious = moduleNumber > 1;
    const hasNextModule = moduleNumber < totalModules;
    const nextTarget = hasNextModule ? `module-M${moduleNumber + 1}` : 'dashboard';
    const nextLabel = hasNextModule ? `Next: Module ${moduleNumber + 1}` : 'Next: Certification Status';

    const previousButton = hasPrevious
      ? `<button type="button" class="nav-button" onclick="navigateToSection('module-M${moduleNumber - 1}')">Previous: Module ${moduleNumber - 1}</button>`
      : '';

    return `
            <div class="module-nav" aria-label="Module navigation">
              ${previousButton}
              <button type="button" class="nav-button primary" onclick="navigateToSection('${nextTarget}')">${nextLabel}</button>
            </div>`;
  }

  function moduleHeroTemplate(module, headingId) {
    const moduleNumber = module.id.replace('M', '');
    const objectives = (module.objectives || []).map(item => `<li>${item}</li>`).join('');
    return `
      <header class="module-hero">
        <div class="module-hero__text">
          <div class="module-hero__meta">
            <span class="pill">Module ${moduleNumber}</span>
          </div>
          <h2 id="${headingId}" class="module-title" tabindex="-1">${module.title}</h2>
          <p class="module-subtitle">${module.intro}</p>
          <div class="module-objectives-block">
            <p class="eyebrow">What you'll learn</p>
            <ul class="module-objectives">${objectives}</ul>
          </div>
        </div>
      </header>
    `;
  }

  function quizHostTemplate(module) {
    const moduleNumber = module.id.replace('M', '');
    return `
      <div class="quiz quiz-card" aria-label="quiz for ${module.title}">
        <div class="quiz-lockout-banner" id="module${moduleNumber}-lockout-banner" hidden>
          <div class="quiz-lockout-title">‚è≥ Quiz Lockout Active</div>
          <div class="quiz-lockout-countdown">Time remaining: <span id="module${moduleNumber}-lockout-timer">72:00:00</span></div>
        </div>
        <div class="quiz-context">You‚Äôre working on Module ${moduleNumber}</div>
        <h3>Module ${moduleNumber} Quiz</h3>
        <div id="module${moduleNumber}-quiz-host" class="quiz-host"></div>
        <div class="quiz-footer">
          <div class="quiz-actions">
            <button type="button" class="primary" id="module${moduleNumber}-quiz-submit">Submit Quiz</button>
            <button type="button" class="nav-button ghost" id="module${moduleNumber}-quiz-retake" hidden>Retake quiz</button>
          </div>
          <div class="quiz-feedback status-text" id="module${moduleNumber}-quiz-feedback" aria-live="polite">${PASSING_MESSAGE}</div>
        </div>
        ${renderModuleNavigation(module.id)}
      </div>
    `;
  }

  function moduleTemplate(module) {
    if (module.id === 'M1') {
      return moduleOneTemplate(module);
    }
    if (module.id === 'M2') {
      return moduleTwoTemplate(module);
    }
    if (module.id === 'M3') {
      return moduleThreeTemplate(module);
    }
    if (module.id === 'M4') {
      return moduleFourTemplate(module);
    }
    if (module.id === 'M5') {
      return moduleFiveTemplate(module);
    }
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const sections = module.sections.map(section => `
      <div class="section">
        <h3>${section.title}</h3>
        <ul>${section.bullets.map(b => `<li>${b}</li>`).join('')}</ul>
      </div>`).join('');
    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module" id="${module.id}">
          <span class="pill">Module ${module.id.replace('M','')}</span>
          <h2 id="${headingId}" tabindex="-1">${module.title}</h2>
          <p>${module.intro}</p>
          <div class="section">
            <h3>Learning Objectives</h3>
            <ul>${objectives}</ul>
          </div>
          ${sections}
          <div class="section callout">
            <strong>Visual/Diagram Descriptions:</strong>
            <ul>${module.sections.map(s => s.bullets.find(b => b.toLowerCase().includes('diagram') || b.toLowerCase().includes('visual'))).filter(Boolean).map(item => `<li>${item}</li>`).join('') || '<li>See notes above.</li>'}</ul>
          </div>
          ${quizHostTemplate(module)}
      </article>
    </section>
  `;
  }

  function moduleOneTemplate(module) {
    const subjectiveList = module.vocabulary.subjective.map(item => `<li>‚ùå ${item}</li>`).join('');
    const objectiveList = module.vocabulary.objective.map(item => `<li>‚úÖ ${item}</li>`).join('');
    const rules = module.measurementRules.map(rule => `
      <div class="rule-card">
        <h4>${rule.title}</h4>
        <p>${rule.details}</p>
      </div>
    `).join('');
    const hemPoints = module.hemCallout.points.map(point => `<li>${point}</li>`).join('');
    const scenarios = module.complaintScenarios.map(scenario => `
      <div class="scenario-card">
        <p class="eyebrow">Bad Note</p>
        <p class="bad">${scenario.bad}</p>
        <p class="eyebrow">Complaint</p>
        <p>${scenario.result}</p>
        <p class="eyebrow">Corrected Note</p>
        <p class="good">${scenario.fix}</p>
      </div>
    `).join('');
    const practices = module.practicePrompts.map((prompt, idx) => `
      <div class="practice-card">
        <div class="practice-header">
          <p class="eyebrow">Rewrite Prompt ${idx + 1}</p>
          <span class="tag">Practice</span>
        </div>
        <p class="bad">${prompt.bad}</p>
        <label class="sr-only" for="practice-${idx}">Rewrite prompt ${idx + 1}</label>
        <input id="practice-${idx}" type="text" placeholder="${prompt.placeholder}" />
        <p class="hint">Example: ${prompt.example}</p>
      </div>
    `).join('');
    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module module-shell" id="${module.id}">
          ${moduleHeroTemplate(module, headingId)}
          <div class="module-cards">
            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Measurement language reset</h3>
                  <p class="subtitle">Shift every conversation from ‚Äúa bit‚Äù or ‚Äú2 inches‚Äù to final measurements tailors can sew to.</p>
                  <div class="concept-grid">
                    <div class="concept-card">
                      <h3>Subjective vs Objective</h3>
                      <div class="list-row">
                        <div>
                          <p class="eyebrow">Avoid</p>
                          <ul>${subjectiveList}</ul>
                        </div>
                        <div>
                          <p class="eyebrow">Use Instead</p>
                          <ul>${objectiveList}</ul>
                        </div>
                      </div>
                      <p class="tip">Ask the customer to stand naturally, measure the preferred fit, and document the final number.</p>
                    </div>
                    <div class="concept-card highlight">
                      <h3>Standard Measurement Language</h3>
                      <p>Use formats that travel clearly to the tailor:</p>
                      <ul>
                        <li>INSEAM 30 / INSEAM 32</li>
                        <li>OUTSEAM 40</li>
                        <li>WAIST 36</li>
                        <li>‚ÄúShorten sleeves to 23 inches from shoulder seam.‚Äù</li>
                      </ul>
                      <p class="tip">Never record ‚Äúa little‚Äù or ‚Äú+/-‚Äù values‚Äîcapture the final measurement instead.</p>
                    </div>
                  </div>
                  <div class="rule-grid">${rules}</div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Record the final measurement (e.g., ‚ÄúINSEAM 30‚Äù) instead of a change amount.</p>
                  </div>
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Using tag sizes or plus/minus shorthand creates guesswork for tailors.</p>
                  </div>
                  <div class="module-media-container">
                    <div class="module-figure-grid">
                      <figure class="module-figure">
                        <img
                          class="module-image"
                          src="https://www.dublincleaners.com/wp-content/uploads/2025/12/Women-Pant-Size-label.jpg"
                          alt="Women‚Äôs pants size label example."
                          loading="lazy"
                          onerror="this.onerror=null;this.src='https://www.dublincleaners.com/wp-content/uploads/2025/12/Women-Pant-Size-Label.jpg';"
                        />
                        <figcaption class="module-caption">Tag sizes vary ‚Äî measure the garment and capture the confirmed number.</figcaption>
                      </figure>
                      <figure class="module-figure">
                        <img
                          class="module-image"
                          src="https://www.dublincleaners.com/wp-content/uploads/2025/12/Menslabel.jpg"
                          alt="Men‚Äôs pants size label example; tags still require tape verification."
                          loading="lazy"
                          onerror="this.onerror=null;this.src='https://www.dublincleaners.com/wp-content/uploads/2025/12/MensLabel.jpg';"
                        />
                        <figcaption class="module-caption">Men‚Äôs labels also drift after alterations. Always verify with a tape.</figcaption>
                      </figure>
                    </div>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Measuring from pin to inseam (objective demo)</h3>
                  <p class="subtitle">See how to capture the final number‚Äînever tag sizes or +/- shorthand‚Äîright after you mark the hem.</p>
                  <div class="module-media">
                    <div class="media-card">
                      <h4 class="media-title">üé• Measuring from pin to inseam</h4>
                      <video class="media-video" controls preload="metadata" playsinline>
                        <source src="https://apps.dublincleaners.com/images/MeasuringPin.mp4" type="video/mp4" />
                        <source src="https://apps.dublincleaners.com/images/measuringpin.mp4" type="video/mp4" />
                        Your browser does not support the video tag.
                      </video>

                      <div class="media-notes">
                        <p class="media-notes-title">What to watch for:</p>
                        <ul>
                          <li>Always measure the final pinned point to the finished hem/inseam</li>
                          <li>Do not rely on tag measurements</li>
                          <li>Smooth fabric‚Äîdo not stretch</li>
                          <li>Confirm final measurement with the customer</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Hem clarity and objective notes</h3>
                  <div class="callout callout--note">
                    <p class="callout-title">üìù POS Note Example</p>
                    <p>‚ÄúShorten inseam to 30 inches; customer approved.‚Äù</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üìè Measurement</p>
                    <p>‚ÄúFinished hem 36 inches from floor with flats.‚Äù</p>
                  </div>
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Writing ‚Äúhem 2 inches‚Äù hides the true target. Replace with the final length.</p>
                  </div>
                  <div class="script-card">
                    <h3>Confirmation Script</h3>
                    <p>‚ÄúI‚Äôll note <strong>‚Äòshorten inseam to 30 inches‚Äô</strong>. Is that exactly what you want?‚Äù Repeat back the final measurement before saving it.</p>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">üß∑ Pin Safety</p>
                    <p>Measure on a flat surface after marking; never guess from tags.</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">${module.hemCallout.heading}</p>
                    <ul>${hemPoints}</ul>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Prevent complaints with clear rewrites</h3>
                  <p class="subtitle">Translate vague requests into ready-to-sew instructions.</p>
                  <div class="scenario-grid">
                    <h3>Complaint Prevention Examples</h3>
                    ${scenarios}
                  </div>
                  <div class="practice-grid" aria-label="Rewrite practice for clearer notes">
                    <h3>Rewrite Practice (not graded)</h3>
                    <p class="subtitle">Rewrite each vague note as a final, objective instruction. Use the examples as guidance.</p>
                    <div class="practice-list">${practices}</div>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Every rewrite must end with a measurable number the tailor can match.</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>‚ÄúTo make sure we get this right, I‚Äôm writing ‚ÄòShorten inseam to 30 inches.‚Äô Does that match what you want?‚Äù</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card quiz-card">
              ${quizHostTemplate(module)}
              <div class="back-to-top"><button type="button" class="nav-button" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">Back to top</button></div>
            </div>
          </div>
        </article>
      </section>
    `;
  }

  function moduleFourTemplate(module) {
    const correctList = module.objectiveNotes.correct.map(item => `<li>${item}</li>`).join('');
    const incorrectList = module.objectiveNotes.incorrect.map(item => `<li>${item}</li>`).join('');
    const hemWrong = module.hemGuidance.wrong.map(item => `<li>‚ùå ${item}</li>`).join('');
    const hemBetter = module.hemGuidance.better.map(item => `<li>‚úÖ ${item}</li>`).join('');
    const comparisonRows = module.comparisons.map(pair => `
      <div class="comparison-row">
        <div class="bad">${pair.bad}</div>
        <div class="good">${pair.good}</div>
      </div>
    `).join('');
    const formatCards = module.standardFormats.map(format => `
      <div class="format-card">
        <div class="format-label">${format.label}</div>
        <p class="format-example">${format.example}</p>
        <p class="micro-copy">${format.note}</p>
      </div>
    `).join('');
    const fieldUsage = module.fieldUsage.map(item => `<li>${item}</li>`).join('');
    const posMockups = module.posExamples.map(example => `
      <div class="pos-card">
        <div class="pos-card__header">
          <div>
            <p class="eyebrow">Item</p>
            <h4>${example.item}</h4>
          </div>
          <div class="pos-service">${example.service}</div>
        </div>
        <div class="pos-note-grid">
          <div>
            <p class="pill pill-quiet">Before</p>
            <p class="bad">${example.before}</p>
          </div>
          <div>
            <p class="pill">After</p>
            <p class="good">${example.after}</p>
          </div>
        </div>
        <p class="micro-copy">${example.why}</p>
      </div>
    `).join('');
    const scripts = [
      { title: 'Confirmation', line: module.scripts.confirm },
      { title: 'Clarifying vague requests', line: module.scripts.clarify },
      { title: 'Fixing ‚Äúhem‚Äù language', line: module.scripts.hemFix }
    ].map(script => `
      <div class="script-card">
        <p class="eyebrow">${script.title}</p>
        <p>${script.line}</p>
      </div>
    `).join('');
    const corrections = module.corrections.map(item => `<li><span class="bad">${item.bad}</span> ‚Üí <span class="good">${item.good}</span></li>`).join('');
    const checklist = module.noteChecklist.map(item => `<li>${item}</li>`).join('');
    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module module-four module-shell" id="${module.id}">
          ${moduleHeroTemplate(module, headingId)}
          <div class="module-cards">
            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Objective SPOT notes that travel</h3>
                  <p class="subtitle">Replace vague language with final measurements the tailor can trust.</p>
                  <div class="module-four__grid" aria-label="Objective SPOT note examples">
                    <div class="note-card">
                      <p class="eyebrow">Objective Notes in SPOT POS</p>
                      <div class="note-columns">
                        <div>
                          <p class="badge-lite">Correct</p>
                          <ul>${correctList}</ul>
                        </div>
                        <div>
                          <p class="pill pill-quiet">Avoid</p>
                          <ul>${incorrectList}</ul>
                        </div>
                      </div>
                      <p class="tip">${module.objectiveNotes.reminder}</p>
                    </div>
                    <div class="note-card hem-guard">
                      <p class="eyebrow">Avoid Using ‚ÄúHem‚Äù as a Verb</p>
                      <p>${module.hemGuidance.definition}</p>
                      <div class="note-columns">
                        <div>
                          <p class="pill pill-quiet">Wrong</p>
                          <ul>${hemWrong}</ul>
                        </div>
                        <div>
                          <p class="pill pill-quiet">Better</p>
                          <ul>${hemBetter}</ul>
                        </div>
                      </div>
                      <p class="tip">${module.hemGuidance.reminder}</p>
                    </div>
                  </div>
                  <div class="comparison-table" aria-label="Shorten vs hem wording">
                    <h3>‚ÄúShorten to X‚Äù vs ‚ÄúHem to X‚Äù</h3>
                    <div class="comparison-grid">${comparisonRows}</div>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Write the action and final number. ‚ÄúHem‚Äù alone is never enough.</p>
                  </div>
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Copying tag sizes or ‚Äúas is‚Äù instead of measuring and confirming.</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Standard formats & SPOT field usage</h3>
                  <div class="format-grid" aria-label="Standard POS formats">
                    <h3>Using Standard Formats in SPOT</h3>
                    <p class="micro-copy">Lead with the garment area and the final measurement so tailors can act without guessing.</p>
                    <div class="format-cards">${formatCards}</div>
                  </div>
                  <div class="field-usage" aria-label="SPOT field usage guidance">
                    <h3>Use SPOT Fields Consistently</h3>
                    <ul>${fieldUsage}</ul>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--note">
                    <p class="callout-title">üìù POS Note Example</p>
                    <p>‚ÄúJeans: shorten inseam to 30.0 (measured). Customer approved.‚Äù</p>
                  </div>
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Always mirror approvals in the note so the tailor knows the customer agreed.</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>POS mockups & customer scripts</h3>
                  <div class="pos-mockups" aria-label="POS note walkthrough">
                    <h3>POS Screen Note Examples</h3>
                    <p class="micro-copy">These text mockups show how to capture the garment, service, and objective note the tailor will follow.</p>
                    <div class="mockup-grid">${posMockups}</div>
                  </div>
                  <div class="script-grid" aria-label="Customer communication scripts">
                    <h3>Customer Communication Scripts</h3>
                    <p class="subtitle">Mirror the customer‚Äôs expectation verbally, then repeat it in the SPOT note.</p>
                    <div class="script-grid__inner">${scripts}</div>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>${module.scripts.confirm}</p>
                  </div>
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Leaving ‚Äúhem‚Äù as the only instruction; tailors need the finished measurement.</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Corrections & checklist</h3>
                  <div class="correction-list" aria-label="Correcting vague notes">
                    <h3>Correcting Bad Notes</h3>
                    <ul>${corrections}</ul>
                  </div>
                  <div class="checklist-lite" aria-label="Note entry checklist">
                    <h3>Quick SPOT Note Checklist ‚úÖ</h3>
                    <ul>${checklist}</ul>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Pair garment type with the final number: ‚ÄúWool trousers: inseam 30 (measured).‚Äù</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>${module.scripts.clarify}</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card quiz-card">
              ${quizHostTemplate(module)}
              <div class="back-to-top"><button type="button" class="nav-button" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">Back to top</button></div>
            </div>
          </div>
        </article>
      </section>
    `;
  }

  // Module 2 uses custom layout classes (pin-grid, policy-card, orientation-grid) defined in styles.html.
  function moduleTwoTemplate(module) {
    const pinCards = module.pinTypes.map(pin => `
      <div class="pin-card">
        <div class="pin-card__header">
          <span class="pill pill-quiet">Pin Type</span>
          <h3>${pin.name}</h3>
        </div>
        <p class="micro-copy">${pin.description}</p>
        <ul>${pin.useCases.map(use => `<li>${use}</li>`).join('')}</ul>
        <div class="note-line">${pin.caution}</div>
      </div>
    `).join('');

    const checklist = module.safetyChecklist.map(item => `<li>${item}</li>`).join('');
    const scenarios = module.scenarios.map((s, idx) => `
      <div class="scenario-card">
        <p class="eyebrow">Scenario ${idx + 1}</p>
        <p><strong>${s.prompt}</strong></p>
        <p class="answer">Answer: ${s.answer}</p>
      </div>
    `).join('');

    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module module-shell" id="${module.id}">
          ${moduleHeroTemplate(module, headingId)}
          <div class="module-cards">
            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Pin types and when to use them</h3>
                  <p class="subtitle">Choose the right tool, then swap to safety pins before garments travel.</p>
                  <div class="pin-grid" aria-label="Pin type comparison">
                    ${pinCards}
                  </div>
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Sending straight pins to the plant. Replace with closed safety pins before bagging.</p>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="module-media-container">
                    <div class="module-figure-grid">
                      <figure class="module-figure">
                        <img
                          class="module-image"
                          src="https://apps.dublincleaners.com/images/Straightpin2.jpg"
                          alt="Straight pins with colored heads arranged for fitting"
                          onerror="this.onerror=null;this.src='https://apps.dublincleaners.com/images/StraightPin2.jpg';"
                        />
                        <figcaption class="module-caption">Straight pins: temporary and supervised only.</figcaption>
                      </figure>
                      <figure class="module-figure">
                        <img
                          class="module-image"
                          src="https://apps.dublincleaners.com/images/SafetyPin.jpg"
                          alt="Safety pin with closed clasp for secure travel"
                          onerror="this.onerror=null;this.src='https://apps.dublincleaners.com/images/Safetypin.jpg';"
                        />
                        <figcaption class="module-caption">Safety pins: closed clasps required for any garment traveling to the plant.</figcaption>
                      </figure>
                    </div>
                  </div>
                  <div class="callout callout--rule">
                    <p class="callout-title">üß∑ Pin Safety</p>
                    <p>Only closed safety pins leave the store. Horizontal is preferred for travel; vertical is acceptable when stable and documented.</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Plant travel policy</h3>
                  <div class="policy-card" aria-label="Safety pin policy">
                    <div>
                      <p class="eyebrow">Plant Travel Rule</p>
                      <h3>${module.policy.headline}</h3>
                      <ul>${module.policy.rules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                      <p class="note-line">${module.policy.note}</p>
                    </div>
                    <div class="policy-badge">
                      <div class="badge-warning">Safety pins only</div>
                      <p class="micro-copy">Closed clasps prevent injuries and protect machinery.</p>
                    </div>
                  </div>
                  <div class="orientation-grid" aria-label="Pin orientation examples">
                    <div class="orientation-card good">
                      <p class="pill pill-quiet">Correct</p>
                      <h3>${module.orientation.correct.title}</h3>
                      <ul>${module.orientation.correct.bullets.map(item => `<li>${item}</li>`).join('')}</ul>
                      <p class="micro-copy">${module.orientation.correct.description}</p>
                    </div>
                    <div class="orientation-card risk">
                      <p class="pill pill-quiet">Allowed with care</p>
                      <h3>${module.orientation.flexible.title}</h3>
                      <ul>${module.orientation.flexible.bullets.map(item => `<li>${item}</li>`).join('')}</ul>
                      <p class="micro-copy">${module.orientation.flexible.description}</p>
                    </div>
                  </div>
                  <div class="module-media-container">
                    <figure class="module-figure">
                      <img
                        class="module-image"
                        src="https://apps.dublincleaners.com/images/StraightPin.jpg"
                        alt="Example of vertical pinning on a garment"
                        loading="lazy"
                        onerror="this.onerror=null;this.src='https://apps.dublincleaners.com/images/straightpin.jpg';"
                      />
                      <figcaption class="module-caption">
                        Vertical pinning can be acceptable depending on the garment and customer preference ‚Äî always confirm the final measurement.
                      </figcaption>
                    </figure>
                  </div>
                  <div class="policy-callout" aria-label="On-body pinning safety">
                    <div>
                      <p class="eyebrow">On-body pinning</p>
                      <h3>${module.onBodySafety.headline}</h3>
                      <ul>${module.onBodySafety.reminders.map(item => `<li>${item}</li>`).join('')}</ul>
                    </div>
                    <div class="stretch-risk">
                      <p class="badge-lite">Customer Script</p>
                      <p>${module.onBodySafety.script}</p>
                    </div>
                  </div>
                  <div class="callout callout--safety" aria-label="Boundary reminder">
                    <p class="callout-title">Pinning boundaries</p>
                    <ul>
                      <li>Allowed on-body only with consent, hand barrier, slow controlled movements, and clear narration.</li>
                      <li>Never pin or measure in private or near-private regions; escalate to tailor lead/supervisor if the request requires that area.</li>
                      <li>Document that you escalated with neutral language.</li>
                    </ul>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>‚ÄúFor comfort and safety, we can pin here. If this adjustment requires a tailor fitting, we‚Äôll bring in our tailor lead.‚Äù</p>
                  </div>
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Vertical pins can twist if they aren‚Äôt secure. Re-measure and convert to closed safety pins for travel.</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Safety checklist & scenarios</h3>
                  <div class="checklist" aria-label="Pin safety checklist">
                    <div>
                      <p class="eyebrow">Quick Safety</p>
                      <h3>Pin Safety Checklist ‚ö†Ô∏è</h3>
                      <ul>${checklist}</ul>
                    </div>
                    <div class="checklist-note">
                      <p class="badge-lite">Checklist Reminder</p>
                      <p>Use this before every plant-bound garment leaves the counter.</p>
                      <p class="micro-copy">Imagine the hem as a line ‚Äî horizontal pins are most stable for travel. Vertical pins are acceptable when measured and secured for the specific garment or customer request.</p>
                    </div>
                  </div>
                  <div class="scenario-grid" aria-label="Pin safety scenarios">
                    <h3>Pin Safety Scenarios</h3>
                    ${scenarios}
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Count pins, close clasps, confirm orientation, and brief the customer before bagging.</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üß∑ Pin Safety</p>
                    <p>Swap straight pins after fittings‚Äînever let them leave the building.</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card quiz-card">
              ${quizHostTemplate(module)}
              <div class="back-to-top"><button type="button" class="nav-button" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">Back to top</button></div>
            </div>
          </div>
        </article>
      </section>
    `;
  }

  // Module 3 focuses on garment-specific pinning, smoothing fabric, handedness, patches, and customer-pinned verification.
  // New layout classes are defined in styles.html and scoped with the prefix module-three- where applicable.
  function moduleThreeTemplate(module) {
    const garmentCards = module.garmentTypes.map(type => `
      <div class="garment-card">
        <div class="garment-card__header">
          <span class="pill pill-quiet">${type.csrScope}</span>
          <h3>${type.name}</h3>
        </div>
        <ul>
          <li><strong>Where to pin:</strong> ${type.pinning}</li>
          <li><strong>Recommended pins:</strong> ${type.pins}</li>
          <li><strong>Record it as:</strong> ${type.record}</li>
          <li><strong>Stay balanced:</strong> ${type.balance}</li>
        </ul>
      </div>
    `).join('');

    const pantsPolicyPoints = module.pantsPolicy.points.map(item => `<li>${item}</li>`).join('');
    const pantsPolicyVerification = module.pantsPolicy.verification.map(item => `<li>${item}</li>`).join('');
    const legCalloutBullets = module.legLengthCallout.bullets.map(item => `<li>${item}</li>`).join('');
    const legCalloutNotes = module.legLengthCallout.notes.map(note => `<span class="note-chip">${note}</span>`).join('');
    const workflowSteps = module.pantsWorkflow.steps.map((step, idx) => `<li><strong>Step ${idx + 1}:</strong> ${step}</li>`).join('');
    const doList = module.doDont.do.map(item => `<li>${item}</li>`).join('');
    const dontList = module.doDont.dont.map(item => `<li>${item}</li>`).join('');
    const smoothList = module.smoothRules.bullets.map(item => `<li>${item}</li>`).join('');
    const pairingList = module.patchProtocol.pairing.map(item => `<li>${item}</li>`).join('');
    const placementList = module.patchProtocol.placement.map(item => `<li>${item}</li>`).join('');
    const verificationSteps = module.customerPinned.steps.map((step, idx) => `<li><strong>Step ${idx + 1}:</strong> ${step}</li>`).join('');
    const recordingRows = module.recording.map(row => `
      <div class="metric-row">
        <div class="metric-label">${row.item}</div>
        <div class="metric-examples">${row.examples.map(ex => `<p>${ex}</p>`).join('')}</div>
      </div>
    `).join('');
    const handednessCautions = module.handedness.cautions.map(item => `<li>${item}</li>`).join('');
    const drapeBullets = module.drapeNotes.bullets.map(item => `<li>${item}</li>`).join('');
    const drapeExamples = module.drapeNotes.examples.map(example => `<span class="note-chip">${example}</span>`).join('');
    const practiceScenarios = module.practiceScenarios.map(scenario => `
      <div class="scenario-card">
        <p class="eyebrow">Customer says</p>
        <p class="bad">‚Äú${scenario.prompt}‚Äù</p>
        <p class="eyebrow">You do</p>
        <p class="good">${scenario.response}</p>
      </div>
    `).join('');
    const quickChecklist = module.quickChecklist.map(item => `<li>${item}</li>`).join('');
    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module module-shell" id="${module.id}">
          ${moduleHeroTemplate(module, headingId)}
          <div class="module-cards">
            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Garment-specific pinning playbook</h3>
                  <p class="subtitle">CSR-approved garments, pinned with objective notes and balanced measurements.</p>
                  <div class="garment-grid" aria-label="Garment pinning guidance">
                    ${garmentCards}
                  </div>
                  <p class="micro-copy">Pin orientation can be horizontal or vertical based on the fitting goal‚Äîre-measure the finished length and secure with closed safety pins for travel.</p>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Use secure pins to hold hems level‚Äîhorizontal is most stable for travel, but vertical is acceptable when it keeps the measurement clear for the customer or garment.</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>‚ÄúWe‚Äôll mark each leg, measure off-body, and note the exact inseam so both sides match.‚Äù</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Smoothing, balance, and on-body limits</h3>
                  <div class="policy-callout" aria-label="Non-negotiable pants policy">
                    <div>
                      <p class="eyebrow">Non-Negotiable Policy</p>
                      <h3>${module.pantsPolicy.headline}</h3>
                      <ul>${pantsPolicyPoints}</ul>
                    </div>
                    <div>
                      <p class="eyebrow">How to verify without on-body measurement</p>
                      <ul>${pantsPolicyVerification}</ul>
                      <p class="micro-copy">${module.pantsPolicy.note}</p>
                    </div>
                  </div>
                  <div class="callout-card" aria-label="Smooth fabric guidance">
                    <div>
                      <p class="eyebrow">Accuracy Rule</p>
                      <h3>${module.smoothRules.headline}</h3>
                      <ul>${smoothList}</ul>
                    </div>
                    <div class="stretch-risk">
                      <p class="badge-lite">Do not stretch</p>
                      <p>Stretching a pant leg can add 1/2‚Äù‚Äì1‚Äù instantly. Smooth first, then measure.</p>
                    </div>
                  </div>
                  <div class="policy-callout" aria-label="Leg length differences">
                    <div>
                      <p class="eyebrow">Balance note</p>
                      <h3>${module.legLengthCallout.headline}</h3>
                      <ul>${legCalloutBullets}</ul>
                      <p class="micro-copy"><strong>Practice scenario:</strong> ${module.legLengthCallout.scenario}</p>
                    </div>
                    <div class="note-chip-row" aria-label="Note format examples">${legCalloutNotes}</div>
                  </div>
                  <div class="callout-card" aria-label="Vents and splits on skirts and dresses">
                    <div>
                      <p class="eyebrow">Skirts/Dresses</p>
                      <h3>${module.ventsSplits.headline}</h3>
                      <ul>${module.ventsSplits.bullets.map(item => `<li>${item}</li>`).join('')}</ul>
                    </div>
                    <div class="stretch-risk">
                      <p class="badge-lite">Reminder</p>
                      <p>${module.ventsSplits.reminder}</p>
                    </div>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--note">
                    <p class="callout-title">üß∑ Pin Safety</p>
                    <p>Pin only loose fabric away from skin while the customer is present. Measure off-body.</p>
                  </div>
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Measuring inseams on-body or stretching fabric to reach a length.</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Workflow, verification, and patch control</h3>
                  <div class="workflow-card" aria-label="Pants hem workflow">
                    <p class="eyebrow">Repeatable steps</p>
                    <h3>${module.pantsWorkflow.title}</h3>
                    <ol>${workflowSteps}</ol>
                  </div>
                  <div class="do-dont" aria-label="Do and don't for trouser pinning">
                    <div class="card-lite">
                      <p class="eyebrow">Do</p>
                      <ul>${doList}</ul>
                    </div>
                    <div class="card-lite risk">
                      <p class="eyebrow">Don't</p>
                      <ul>${dontList}</ul>
                    </div>
                  </div>
                  <div class="two-column" aria-label="Patch protocol and placement">
                    <div class="card-lite">
                      <p class="eyebrow">Patch protocol</p>
                      <h3>One Patch, One Garment</h3>
                      <ul>${pairingList}</ul>
                    </div>
                    <div class="card-lite">
                      <p class="eyebrow">Placement coaching</p>
                      <h3>Pick the Exact Spot</h3>
                      <ul>${placementList}</ul>
                    </div>
                  </div>
                  <div class="verification" aria-label="Customer pinned garment verification">
                    <div>
                      <p class="eyebrow">Customer-pinned garments</p>
                      <h3>Verify Before You Save</h3>
                      <ul>${verificationSteps}</ul>
                      <p class="micro-copy">${module.customerPinned.reason}</p>
                    </div>
                    <div class="verification-note">
                      <p class="badge-lite">Script</p>
                      <p>‚ÄúYou want this hem at <strong>29 inches</strong> right where you pinned it, correct? I‚Äôll note <em>‚Äòshorten inseam to 29 inches (customer pinned)‚Äô</em>.‚Äù</p>
                    </div>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>${module.handedness.prompt}</p>
                    <ul>
                      <li>${module.handedness.reason}</li>
                      <li>${module.handedness.action}</li>
                    </ul>
                  </div>
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Document each leg separately when lengths differ; never average inseams.</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Recording measurements with drape context</h3>
                  <div class="metric-table" aria-label="Recording final measurements">
                    <h3>Recording Final, Objective Measurements</h3>
                    <p class="micro-copy">Use final numbers, not guesses or plus/minus shorthand.</p>
                    ${recordingRows}
                  </div>
                  <div class="callout-card" aria-label="Drape differences">
                    <div>
                      <p class="eyebrow">Fabric context</p>
                      <h3>${module.drapeNotes.headline}</h3>
                      <ul>${drapeBullets}</ul>
                    </div>
                    <div class="note-chip-row" aria-label="Drape note examples">${drapeExamples}</div>
                  </div>
                  <div class="callout-card" aria-label="Escalation for precision fittings">
                    <div>
                      <p class="eyebrow">Escalation</p>
                      <h3>${module.escalationNote.title}</h3>
                      <p>${module.escalationNote.text}</p>
                    </div>
                    <div class="stretch-risk">
                      <p class="badge-lite">Respect comfort</p>
                      <p>${module.escalationNote.reminder}</p>
                    </div>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Skipping garment type or shoe context; tailors need drape details to match expectations.</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>‚ÄúYou prefer a slightly longer right leg. I‚Äôll record Right inseam 30.0; Left inseam 29.75 so both feel balanced.‚Äù</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Suit jackets: pinning and measuring demo</h3>
                  <div class="module-media">
                    <div class="media-card">
                      <h4 class="media-title">üé• Pinning and measuring a suit jacket</h4>
                      <video class="media-video" controls preload="metadata" playsinline>
                        <source src="https://apps.dublincleaners.com/images/Pinning.mp4" type="video/mp4" />
                        <source src="https://apps.dublincleaners.com/images/pinning.mp4" type="video/mp4" />
                        Your browser does not support the video tag.
                      </video>

                      <div class="media-notes">
                        <p class="media-notes-title">What to watch for:</p>
                        <ul>
                          <li>Confirm customer comfort and posture before pinning on-body</li>
                          <li>Pin to the final fit, then measure and record objective notes for the tailor</li>
                          <li>Clarify sleeve vs. jacket cuff expectations and escalate any complex construction</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Practice & quick checklist</h3>
                  <div class="scenario-grid" aria-label="Practice scenarios for balance and drape">
                    <h3>Practice Scenarios</h3>
                    ${practiceScenarios}
                  </div>
                  <div class="checklist-lite" aria-label="Quick checklist">
                    <h3>Quick Pinning Checklist</h3>
                    <ul>${quickChecklist}</ul>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Verify every customer pin with a tape on the table before saving notes.</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>‚ÄúI‚Äôll double-check these pins on the table so the tailor matches the exact length you approved.‚Äù</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card quiz-card">
              ${quizHostTemplate(module)}
              <div class="back-to-top"><button type="button" class="nav-button" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">Back to top</button></div>
            </div>
          </div>
        </article>
      </section>
    `;
  }

  // Module 5 custom layout focuses on exceptions, escalation triggers, and safe scripting.
  // New classes: module-five__grid, module-five__card, module-five__comparison, module-five__script, module-five__protocol,
  // module-five__note, module-five__boundary, module-five__script-grid (documented in styles.html).
  function moduleFiveTemplate(module) {
    const tailorOnlyCards = module.tailorOnlyCategories.map(category => `
      <div class="module-five__card">
        <p class="pill pill-quiet">Tailor-only</p>
        <h3>${category.title}</h3>
        <ul>${category.items.map(item => `<li>${item}</li>`).join('')}</ul>
      </div>
    `).join('');

    const comparisonCards = `
      <div class="module-five__comparison" aria-label="CSR-approved vs Tailor-only comparison">
        <div class="module-five__card success">
          <p class="pill pill-quiet">CSR-approved</p>
          <h3>CSR-Approved Examples</h3>
          <ul>${module.comparison.csrApproved.map(item => `<li>${item}</li>`).join('')}</ul>
          <p class="micro-copy">Escalate if these include complex fabrics, structure, or embellishment.</p>
        </div>
        <div class="module-five__card warning">
          <p class="pill pill-quiet">Tailor review required</p>
          <h3>Tailor-Only Examples</h3>
          <ul>${module.comparison.tailorOnly.map(item => `<li>${item}</li>`).join('')}</ul>
          <p class="micro-copy">When in doubt, choose safety and escalate.</p>
        </div>
      </div>
    `;

    const protocolSteps = module.customerPinnedProtocol.steps.map((step, idx) => `<li><strong>Step ${idx + 1}:</strong> ${step}</li>`).join('');
    const escalationList = module.escalationTriggers.map(item => `<li>${item}</li>`).join('');
    const scriptCards = module.scripts.map(script => `
      <div class="module-five__script">
        <p class="eyebrow">${script.title}</p>
        <p>‚Äú${script.line}‚Äù</p>
      </div>
    `).join('');
    const documentationList = module.documentationNotes.map(note => `<li>${note}</li>`).join('');
    const boundaryList = module.boundaryStatements.map(item => `<li>${item}</li>`).join('');
    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module module-five module-shell" id="${module.id}">
          ${moduleHeroTemplate(module, headingId)}
          <div class="module-cards">
            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Tailor-only guardrails</h3>
                  <p class="subtitle">Recognize high-risk garments and escalate with confidence.</p>
                  <div class="module-five__card-grid">${tailorOnlyCards}</div>
                  <div class="module-five__comparison" aria-label="CSR-approved vs Tailor-only comparison">
                    <div class="module-five__card success">
                      <p class="pill pill-quiet">CSR-approved</p>
                      <h3>CSR-Approved Examples</h3>
                      <ul>${module.comparison.csrApproved.map(item => `<li>${item}</li>`).join('')}</ul>
                      <p class="micro-copy">Escalate if these include complex fabrics, structure, or embellishment.</p>
                    </div>
                    <div class="module-five__card warning">
                      <p class="pill pill-quiet">Tailor review required</p>
                      <h3>Tailor-Only Examples</h3>
                      <ul>${module.comparison.tailorOnly.map(item => `<li>${item}</li>`).join('')}</ul>
                      <p class="micro-copy">When in doubt, choose safety and escalate.</p>
                    </div>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="module-media-container">
                    <div class="module-figure-grid">
                      <figure class="module-figure">
                        <img
                          class="module-image module-image--large"
                          src="https://apps.dublincleaners.com/images/IntricateLace.jpg"
                          alt="Intricate lace wedding dress example."
                          loading="lazy"
                          referrerpolicy="no-referrer"
                          data-fallback="apps"
                          onerror="
                            if (this.dataset.fallback === 'apps') {
                              this.dataset.fallback = 'wp-upper';
                              this.src = 'https://www.dublincleaners.com/wp-content/uploads/2025/12/IntricateLace.jpg';
                            } else if (this.dataset.fallback === 'wp-upper') {
                              this.dataset.fallback = 'wp-lower';
                              this.src = 'https://www.dublincleaners.com/wp-content/uploads/2025/12/intricatelace.jpg';
                            } else {
                              this.onerror = null;
                            }
                          "
                        />
                        <figcaption class="module-caption">Intricate lace and formal wedding garments are tailor-only‚Äîprevent snags and costly damage by escalating immediately.</figcaption>
                      </figure>
                      <figure class="module-figure">
                        <img
                          class="module-image module-image--large"
                          src="https://apps.dublincleaners.com/images/BeadLace.jpg"
                          alt="Beaded lace wedding gown with intricate embellishments."
                          loading="lazy"
                          referrerpolicy="no-referrer"
                          data-fallback="apps"
                          onerror="
                            if (this.dataset.fallback === 'apps') {
                              this.dataset.fallback = 'wp-upper';
                              this.src = 'https://www.dublincleaners.com/wp-content/uploads/2025/12/BeadLace.jpg';
                            } else if (this.dataset.fallback === 'wp-upper') {
                              this.dataset.fallback = 'wp-lower';
                              this.src = 'https://www.dublincleaners.com/wp-content/uploads/2025/12/beadlace.jpg';
                            } else {
                              this.onerror = null;
                            }
                          "
                        />
                        <figcaption class="module-caption">Beaded lace gowns catch pins and require tailor handling‚Äîescalate to protect the fabric and embellishments.</figcaption>
                      </figure>
                      <figure class="module-figure">
                        <img
                          class="module-image module-image--large"
                          src="https://apps.dublincleaners.com/images/SilkChiffon.jpeg"
                          alt="Delicate silk chiffon fabric draped softly."
                          loading="lazy"
                          referrerpolicy="no-referrer"
                          data-fallback="apps"
                          onerror="
                            if (this.dataset.fallback === 'apps') {
                              this.dataset.fallback = 'wp-upper';
                              this.src = 'https://www.dublincleaners.com/wp-content/uploads/2025/12/SilkChiffon.jpeg';
                            } else if (this.dataset.fallback === 'wp-upper') {
                              this.dataset.fallback = 'wp-lower';
                              this.src = 'https://www.dublincleaners.com/wp-content/uploads/2025/12/silkchiffon.jpeg';
                            } else {
                              this.onerror = null;
                            }
                          "
                        />
                        <figcaption class="module-caption">Silk and chiffon puncture easily‚Äîescalate immediately so the tailor can mark safely without pins in fragile fabric.</figcaption>
                      </figure>
                    </div>
                  </div>
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Attempting to pin beaded, lace, or leather garments at the counter. Stop and involve the tailor.</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Customer-pinned protocol & escalation triggers</h3>
                  <div class="module-five__grid" aria-label="Customer pinned protocol and escalation triggers">
                    <div class="module-five__protocol">
                      <p class="eyebrow">Customer-Pinned Protocol</p>
                      <h3>Guard Complex or Risky Garments</h3>
                      <ul>${protocolSteps}</ul>
                      <div class="module-five__note-line">${module.customerPinnedProtocol.reminder}</div>
                    </div>
                    <div class="module-five__card outline">
                      <p class="eyebrow">Escalation Triggers</p>
                      <h3>Stop and Involve the Tailor When‚Ä¶</h3>
                      <ul>${escalationList}</ul>
                    </div>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Document ‚Äútailor to review before proceeding‚Äù anytime a garment feels risky.</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>‚ÄúBecause this is delicate, our tailor will review and pin it to protect the fabric.‚Äù</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Escalation scripts</h3>
                  <div aria-label="Escalation scripts">
                    <div class="module-five__script-grid">${scriptCards}</div>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--warn">
                    <p class="callout-title">‚ö†Ô∏è Common Mistake</p>
                    <p>Apologizing or sounding unsure. Be confident that escalation protects the garment.</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>‚ÄúI‚Äôm looping our tailor in to keep this piece safe and match exactly what you want.‚Äù</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card">
              <div class="content-grid">
                <div class="content-main">
                  <h3>Documentation & boundaries</h3>
                  <div class="module-five__grid" aria-label="Documentation and boundaries">
                    <div class="module-five__note">
                      <p class="eyebrow">Documenting Exceptions & Escalations</p>
                      <h3>Write Notes Tailors Can Act On</h3>
                      <ul>${documentationList}</ul>
                      <p class="micro-copy">Mirror this language in SPOT so the tailor understands risks and customer preferences.</p>
                    </div>
                    <div class="module-five__boundary">
                      <p class="eyebrow">Boundary Setting</p>
                      <h3>Saying ‚ÄúNo‚Äù Safely</h3>
                      <ul>${boundaryList}</ul>
                    </div>
                  </div>
                  <div class="module-five__reminder callout">
                    <p class="eyebrow">Protection First</p>
                    <p>Safety and garment integrity take priority over speed. Escalate early rather than risk damage.</p>
                  </div>
                </div>
                <aside class="content-side">
                  <div class="callout callout--rule">
                    <p class="callout-title">‚úÖ Key Rule</p>
                    <p>Never promise a risky garment will be altered without tailor review.</p>
                  </div>
                  <div class="callout callout--note">
                    <p class="callout-title">üìù Customer Script</p>
                    <p>‚ÄúOur tailor will confirm the plan before any sewing so we protect your investment.‚Äù</p>
                  </div>
                </aside>
              </div>
            </div>

            <div class="module-card quiz-card">
              ${quizHostTemplate(module)}
              <div class="back-to-top"><button type="button" class="nav-button" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">Back to top</button></div>
            </div>
          </div>
        </article>
      </section>
    `;
  }

  function getModuleNumber(moduleId) {
    return moduleId.replace('M', '');
  }

  function getQuizHostId(moduleId) {
    return `module${getModuleNumber(moduleId)}-quiz-host`;
  }

  function getQuizButtonId(moduleId) {
    return `module${getModuleNumber(moduleId)}-quiz-submit`;
  }

  function getQuizRetakeId(moduleId) {
    return `module${getModuleNumber(moduleId)}-quiz-retake`;
  }

  function getQuizFeedbackId(moduleId) {
    return `module${getModuleNumber(moduleId)}-quiz-feedback`;
  }

  function getFeedbackElement(moduleId) {
    return document.getElementById(getQuizFeedbackId(moduleId)) || document.getElementById(`${moduleId}-result`);
  }

  function getQuestionInputName(moduleId, questionId) {
    return `module${getModuleNumber(moduleId)}-q-${questionId}`;
  }

  function shuffleArray(list) {
    const array = [...list];
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function renderDynamicQuestion(moduleId, idx, question) {
    const questionNumber = idx + 1;
    const options = question.options || [];
    const name = getQuestionInputName(moduleId, question.id);
    const optionHtml = options.map(opt => `
      <label><input type="radio" name="${name}" value="${opt.id}"> ${opt.label}</label>
    `).join('');
    return `<div class="quiz-question"><strong>${questionNumber}. ${question.prompt}</strong><div class="quiz-options">${optionHtml}</div></div>`;
  }

  function renderQuizForModule(moduleId) {
    const host = document.getElementById(getQuizHostId(moduleId));
    if (!host) return;

    const pool = moduleQuestionPools[moduleId] || [];
    if (!pool.length) {
      host.innerHTML = '<p class="status-text">Quiz questions are loading. Please refresh.</p>';
      activeQuizState[moduleId] = { questions: [] };
      return;
    }

    const selectedQuestions = shuffleArray(pool).slice(0, Math.min(QUESTIONS_PER_MODULE, pool.length)).map(question => ({
      ...question,
      options: shuffleArray((question.options || []).map(opt => ({ ...opt })))
    }));

    activeQuizState[moduleId] = { questions: selectedQuestions };
    host.innerHTML = selectedQuestions.map((q, idx) => renderDynamicQuestion(moduleId, idx, q)).join('');

    const feedbackEl = getFeedbackElement(moduleId);
    if (feedbackEl) {
      feedbackEl.textContent = PASSING_MESSAGE;
      feedbackEl.style.color = '';
    }
  }

  function initializeModuleQuizzes() {
    modules.forEach(module => {
      renderQuizForModule(module.id);
      const submitButton = document.getElementById(getQuizButtonId(module.id));
      const retakeButton = document.getElementById(getQuizRetakeId(module.id));
      if (submitButton) {
        submitButton.addEventListener('click', () => submitQuiz(module.id));
      }
      if (retakeButton) {
        retakeButton.addEventListener('click', () => resetQuiz(module.id));
      }
    });
  }

  function getSelectedRadioValue(name) {
    const radios = document.querySelectorAll(`input[name="${name}"]`);
    for (let i = 0; i < radios.length; i++) {
      if (radios[i].checked) return radios[i].value;
    }
    return null;
  }

  function getUnansweredQuestions(moduleId) {
    const state = activeQuizState[moduleId];
    const questions = state?.questions || [];
    const unanswered = [];
    questions.forEach((question, idx) => {
      const selected = getSelectedRadioValue(getQuestionInputName(moduleId, question.id));
      if (!selected) {
        unanswered.push(idx + 1);
      }
    });
    return unanswered;
  }

  function resetQuiz(moduleId) {
    renderQuizForModule(moduleId);
    const feedbackEl = getFeedbackElement(moduleId);
    if (feedbackEl) {
      feedbackEl.textContent = PASSING_MESSAGE;
      feedbackEl.classList.remove('inline-warning');
    }
    const retakeButton = document.getElementById(getQuizRetakeId(moduleId));
    if (retakeButton) {
      retakeButton.setAttribute('hidden', 'hidden');
    }
  }

  function evaluateModuleQuiz(moduleId) {
    const state = activeQuizState[moduleId];
    const questions = state?.questions || [];
    if (!questions.length) {
      return { score: 0, correct: 0, total: QUESTIONS_PER_MODULE, incorrectDetails: [], answers: [] };
    }

    let correct = 0;
    const incorrectDetails = [];
    const answers = [];

    questions.forEach((question, idx) => {
      const selected = getSelectedRadioValue(getQuestionInputName(moduleId, question.id));
      const isCorrect = selected === question.correctOptionId;
      const correctOption = (question.options || []).find(opt => opt.id === question.correctOptionId);
      const selectedOption = (question.options || []).find(opt => opt.id === selected);
      answers.push({
        moduleId,
        questionNumber: idx + 1,
        questionId: question.id,
        questionText: question.prompt,
        selectedOptionId: selected || '',
        selectedOptionLabel: selectedOption?.label || '',
        correctOptionId: question.correctOptionId || '',
        correctOptionLabel: correctOption?.label || '',
        isCorrect
      });

      if (isCorrect) {
        correct += 1;
      } else {
        incorrectDetails.push({
          number: idx + 1,
          prompt: question.prompt,
          tip: question.tip
        });
      }
    });

    const denominator = QUESTIONS_PER_MODULE || questions.length || 1;
    const score = Math.round((correct / denominator) * 100);
    return { score, correct, total: denominator, incorrectDetails, answers };
  }

  function submitQuiz(moduleId) {
    const name = getEmployeeName();
    const location = getEmployeeLocation();
    const isValid = validateEmployeeName();
    if (!isValid) {
      showToast('Enter your employee name before submitting.', 'error');
      document.getElementById('employeeName')?.focus();
      return;
    }

    if (shouldShowLockoutUI(activeLockoutStatus)) {
      showToast('Quiz lockout active. Please wait for the countdown to finish.', 'warning');
      updateLockoutCountdown();
      return;
    }

    const state = activeQuizState[moduleId];
    const questionsLoaded = state?.questions?.length;
    if (!questionsLoaded) {
      updateModuleResultText(moduleId, false, 0, 0, 0, [], 'Quiz questions were not loaded. Please try again.');
      renderQuizForModule(moduleId);
      return;
    }

    const unanswered = getUnansweredQuestions(moduleId);
    if (unanswered.length) {
      const feedbackEl = getFeedbackElement(moduleId);
      if (feedbackEl) {
        feedbackEl.innerHTML = `<p class="inline-warning">Please answer all questions before submitting. Missing: ${unanswered.join(', ')}.</p>`;
      }
      showToast('Please answer all questions before submitting.', 'error');
      return;
    }

    const results = evaluateModuleQuiz(moduleId);
    const passed = results.correct >= PASSING_CORRECT_REQUIRED;
    updateModuleResultText(moduleId, passed, results.score, results.correct, results.total, results.incorrectDetails);

    const retakeButton = document.getElementById(getQuizRetakeId(moduleId));
    if (retakeButton) {
      retakeButton.removeAttribute('hidden');
    }

    const submitButtonId = getQuizButtonId(moduleId);
    setLoading(submitButtonId, true, 'Saving‚Ä¶');

    if (google.script && google.script.run) {
      google.script.run.withSuccessHandler(() => {
        showToast('Module result saved', 'success');
        loadCertificationStatus();
        refreshLockoutStatus();
        setLoading(submitButtonId, false);
        if (moduleId === 'M5') {
          handleFinalOutcomeAfterModuleFive();
        }
        if (autoAdvanceOnPass && passed) {
          const moduleNumber = parseInt(moduleId.replace('M', ''), 10);
          const nextId = moduleNumber < modules.length ? `module-M${moduleNumber + 1}` : 'dashboard';
          navigateToSection(nextId);
        }
      }).withFailureHandler(err => {
        showToast('Error saving result. Please retry.', 'error');
        updateModuleResultText(moduleId, false, results.score, results.correct, results.total, results.incorrectDetails, `Error saving: ${err}`);
        refreshLockoutStatus();
        setLoading(submitButtonId, false);
      }).saveModuleAttempt(moduleId, name, location, results.score, passed, results.correct, QUESTIONS_PER_MODULE, results.answers || []);
    } else {
      setLoading(submitButtonId, false);
    }
  }

  function updateModuleResultText(moduleId, passed, score, correct, total, incorrectDetails = [], errorText) {
    const el = getFeedbackElement(moduleId);
    if (!el) return;

    el.classList.remove('inline-warning');

    if (errorText) {
      el.textContent = errorText;
      el.style.color = '#991b1b';
      return;
    }

    const summary = `${passed ? 'PASS' : 'Review content and retry'} ‚Äî ${correct}/${total} correct (${score}%). Passing requires ${PASSING_CORRECT_REQUIRED} of ${QUESTIONS_PER_MODULE} correct.`;
    const tips = (incorrectDetails || []).map(item => `<li><strong>Q${item.number}</strong>: ${item.tip || 'Review this topic again.'}</li>`).join('');

    if (tips) {
      el.innerHTML = `<p>${summary}</p><ul class="quiz-review">${tips}</ul>`;
    } else {
      el.textContent = summary;
    }

    el.style.color = passed ? '#0f5132' : '#991b1b';

    const legacyEl = document.getElementById(`${moduleId}-result`);
    if (legacyEl && legacyEl !== el) {
      legacyEl.textContent = el.textContent || el.innerText || summary;
      legacyEl.style.color = el.style.color;
    }
  }

  function loadCertificationStatus() {
    const name = getEmployeeName();
    const isValid = validateEmployeeName();
    if (!isValid) {
      document.getElementById('employeeName')?.focus();
      return;
    }
    setLoading('status-refresh-button', true, 'Loading‚Ä¶');
    if (google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(status => {
          renderCertificationStatus(status);
          refreshLockoutStatus();
          setLoading('status-refresh-button', false);
        })
        .withFailureHandler(err => {
          showToast('Could not load certification status. Please try again.', 'error');
          console.error(err);
          setLoading('status-refresh-button', false);
        })
        .getEmployeeCertificationStatus(name);
    } else {
      setLoading('status-refresh-button', false);
    }
  }

  function fetchCertificationStatusByName(name) {
    if (!google.script || !google.script.run) {
      return Promise.resolve(lastCertificationStatus);
    }

    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(status => {
          lastCertificationStatus = status;
          resolve(status);
        })
        .withFailureHandler(err => {
          showToast('Unable to refresh certification status right now.', 'error');
          reject(err);
        })
        .getEmployeeCertificationStatus(name);
    });
  }

  function renderCertificationStatus(status) {
    lastCertificationStatus = status;
    const badge = document.getElementById('certBadge');
    const title = document.getElementById('certStatus');
    const sub = document.getElementById('certSubstatus');
    const progressFill = document.getElementById('progressFill');
    const progressFillAlt = document.getElementById('progress-bar-fill');
    const progressText = document.getElementById('progressText');
    const progressTextAlt = document.getElementById('progress-text');
    const moduleProgress = document.getElementById('moduleProgress');
    const moduleList = document.getElementById('module-status-list');
    const nextRecommendation = document.getElementById('next-module-recommendation');
    if (!status) return;

    const completed = status.completedModules || [];
    const missing = status.missingModules || [];
    const percent = Math.round((completed.length / modules.length) * 100);
    updateCertificateButtonState(status);
    if (progressFill) {
      progressFill.style.width = `${percent}%`;
    }
    if (progressFillAlt) {
      progressFillAlt.style.width = `${percent}%`;
    }
    const remainingMinutes = calculateRemainingMinutes(missing);
    const remainingDisplay = formatMinutes(remainingMinutes);
    if (progressText) {
      progressText.textContent = `${completed.length} / ${modules.length} modules complete ‚Ä¢ Estimated ${remainingDisplay} to finish`;
    }
    if (progressTextAlt) {
      progressTextAlt.textContent = `${completed.length} of ${modules.length} modules passed`;
    }
    updateTimeEstimates(missing);

    if (nextRecommendation) {
      const nextModuleId = getNextRecommendedModule(completed);
      if (nextModuleId) {
        const moduleDetails = modules.find(m => m.id === nextModuleId);
        nextRecommendation.innerHTML = `<p class="eyebrow">Next recommended module</p><p><strong>${moduleDetails?.title || nextModuleId}</strong> ‚Äî Start here to keep momentum.</p>`;
      } else {
        nextRecommendation.textContent = '';
      }
    }

    if (status.isCertified) {
      badge.textContent = 'Certified Alteration Pinner';
      badge.style.background = '#e8f8f2';
      badge.style.color = '#0f5132';
      title.textContent = 'üéì Certified Alteration Pinner';
      sub.textContent = 'All five modules passed. Print your certificate for records.';
    } else {
      badge.textContent = `${completed.length}/5 Modules Passed`;
      badge.style.background = '#fff8e1';
      badge.style.color = '#8a6b00';
      title.textContent = 'Modules remaining: ' + (missing.length ? missing.join(', ') : '‚Äî');
      sub.textContent = 'Pass each module quiz to reach certification. Supervisor sign-off required for live pinning clearance.';
    }

    moduleProgress.innerHTML = modules.map(mod => {
      const isDone = completed.includes(mod.id);
      return `<div class="module-chip ${isDone ? 'pass' : ''}">
        <p class="title">${mod.id} ‚Äî ${mod.title}</p>
        <p class="status">${isDone ? 'Passed' : 'Pending'}</p>
      </div>`;
    }).join('');

    if (moduleList) {
      moduleList.innerHTML = modules.map(mod => {
        const isDone = completed.includes(mod.id);
        return `<li class="module-status-item ${isDone ? 'status-complete' : 'status-missing'}"><span class="module-label">${mod.title}</span><span class="module-badge ${isDone ? 'badge-pass' : 'badge-pending'}">${isDone ? 'Passed' : 'Not Passed Yet'}</span></li>`;
      }).join('');
    }
  }

  function getNextRecommendedModule(completedModules = []) {
    const ordered = modules.map(m => m.id);
    for (let i = 0; i < ordered.length; i++) {
      if (!completedModules.includes(ordered[i])) {
        return ordered[i];
      }
    }
    return null;
  }

  function navigateToSection(sectionId, trigger, skipHashUpdate = false) {
    const sections = document.querySelectorAll('.main-section');
    sections.forEach(section => {
      if (section.id === sectionId || (sectionId.startsWith('module-') && (section.id === 'modules' || section.id === sectionId))) {
        section.hidden = false;
      } else {
        section.hidden = true;
      }
    });

    let focusTarget = null;
    if (sectionId.startsWith('module-')) {
      const targetModule = document.getElementById(sectionId);
      if (targetModule) {
        targetModule.hidden = false;
        document.getElementById('modules')?.removeAttribute('hidden');
        const heading = document.getElementById(`${sectionId}-title`);
        focusTarget = heading;
      }
    } else if (sectionId === 'dashboard') {
      focusTarget = document.getElementById('certStatus');
    }

    if (!skipHashUpdate) {
      const newHash = `#${sectionId}`;
      if (history.replaceState) {
        history.replaceState(null, '', newHash);
      } else {
        window.location.hash = newHash;
      }
    }

    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
      const isActive = item.dataset.target === sectionId;
      item.classList.toggle('active', isActive);
      if (isActive) {
        item.setAttribute('aria-current', 'page');
      } else {
        item.removeAttribute('aria-current');
      }
    });

    updateNavShift(sectionId);

    const moduleNavLinks = document.querySelectorAll('.nav-link');
    moduleNavLinks.forEach(link => {
      const navTarget = link.dataset.target;
      const isModuleActive = navTarget === sectionId;
      link.classList.toggle('active', isModuleActive);
      if (isModuleActive) {
        link.setAttribute('aria-current', 'page');
      } else {
        link.removeAttribute('aria-current');
      }
    });

    const targetEl = document.getElementById(sectionId);
    if (targetEl) {
      targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    if (focusTarget) {
      setTimeout(() => focusTarget?.focus(), 150);
    }

    if (trigger && typeof trigger.blur === 'function') {
      trigger.blur();
    }
  }

  function scrollToStatus() {
    navigateToSection('dashboard');
  }

  function updateNavShift(sectionId) {
    const shouldShiftForNav = sectionId === 'dashboard' || sectionId.startsWith('module-');
    document.body.classList.toggle('modules-nav-active', shouldShiftForNav);
  }

  function handlePrintCertificate() {
    const name = getEmployeeName();
    if (!name) {
      showToast('Enter employee name before generating a certificate.', 'error');
      document.getElementById('employeeName')?.focus();
      return;
    }

    const location = getEmployeeLocation();
    const printButton = document.getElementById('print-certificate-button');
    const originalLabel = printButton ? printButton.textContent : '';

    if (!google.script || !google.script.run) {
      showToast('Certificate creation is only available when running in Google Apps Script.', 'error');
      return;
    }

    const setLoadingState = isLoading => {
      if (!printButton) return;
      if (isLoading) {
        printButton.setAttribute('disabled', 'disabled');
        printButton.textContent = 'Generating‚Ä¶';
      } else {
        printButton.textContent = originalLabel || 'Generate Certificate (PDF)';
        updateCertificateButtonState(lastCertificationStatus);
      }
    };

    fetchCertificationStatusByName(name)
      .then(status => {
        lastCertificationStatus = status;
        updateCertificateButtonState(status);
        if (!status || !status.isCertified) {
          showToast('Pass all five modules before generating a certificate.', 'error');
          return null;
        }

        setLoadingState(true);
        showToast('Generating your certificate from the Dublin Cleaners template‚Ä¶', 'info');

        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .generateCertificatePDF(name, location);
        });
      })
      .then(result => {
        if (!result) return;
        setLoadingState(false);

        if (result?.pdfFileUrl) {
          showToast('Certificate generated and saved to Drive. Opening PDF‚Ä¶', 'success');
          window.open(result.pdfFileUrl, '_blank', 'noopener');
        } else {
          showToast('Certificate generated, but no PDF link was returned.', 'info');
        }

        if (result && result.isCertified === false) {
          showToast('Note: This employee is not fully certified according to records.', 'warning');
        }
      })
      .catch(err => {
        setLoadingState(false);
        const message = err && err.message ? err.message : 'Could not create certificate. Please try again.';
        showToast(message, 'error');
      });
  }

  function setupPrintCertificateButton() {
    const btn = document.getElementById('print-certificate-button');
    if (btn) {
      btn.addEventListener('click', handlePrintCertificate);
    }
  }

  function bindIdentityPersistence() {
    const nameInput = document.getElementById('employeeName');
    const locationInput = document.getElementById('employeeLocation');
    nameInput?.addEventListener('input', () => {
      validateEmployeeName();
      saveEmployeeInputsToLocal();
    });
    locationInput?.addEventListener('input', () => saveEmployeeInputsToLocal());
  }

  function persistIdentity() {
    saveEmployeeInputsToLocal();
  }

  function restoreIdentityFromStorage() {
    loadEmployeeInputsFromLocal();
  }

</script>
