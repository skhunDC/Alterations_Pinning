<script>
  const modules = [
    {
      id: 'M1',
      title: 'Customer Instruction & Measurement Philosophy',
      intro: 'Shift every conversation from “a bit” or “2 inches” to precise, final measurements that tailors can trust.',
      objectives: [
        'Explain subjective vs. objective alteration language.',
        'Avoid +/- shorthand and capture the final measurement instead.',
        'Use phrases like “INSEAM 32” or “Shorten inseam to 30 inches.”',
        'Describe “hem” correctly as the folded, sewn edge—not a verb or a measurement.',
        'Spot and rewrite vague notes into clear instructions that prevent complaints.',
        'Model confirmation scripts so customers agree to the recorded measurement.'
      ],
      vocabulary: {
        subjective: [
          'Shorten a bit',
          'Take in a little',
          'Fix the hem',
          'Make it tighter'
        ],
        objective: [
          'Shorten inseam to 30 inches',
          'Take in waist to 34 inches',
          'Shorten sleeves to 23 inches from shoulder seam',
          'Finished hem should measure 30 inches inseam'
        ]
      },
      measurementRules: [
        {
          title: 'No Plus/Minus Shorthand',
          details: '“-2 inches” or “+1 inch” only describe the change. Tailors need the final number: “Shorten hem to 36 inches from floor.”'
        },
        {
          title: 'Final Measurement Language',
          details: 'Record what the customer wants to end up with. Example: “Take in waist to 36 inches” instead of “Take in 2 inches.”'
        },
        {
          title: 'Standard Format',
          details: 'Use clear formats that travel well: “INSEAM 32,” “OUTSEAM 40,” “WAIST 36.”'
        },
        {
          title: 'Tag sizes are NOT measurements',
          details: 'Never rely on the tag for inseam or waist. BAD: “Inseam 32 (tag says 32).” GOOD: “Measured and confirmed: inseam to 30.5 (customer approved).”'
        }
      ],
      hemCallout: {
        heading: '“Hem” means the finished edge',
        points: [
          'It is a part of the garment, not a measurement.',
          'Wrong: “Hem pants,” “Hem 2 inches.”',
          'Right: “Shorten pants so finished hem is 30 inches inseam.”'
        ]
      },
      complaintScenarios: [
        {
          bad: '“Hem pants.”',
          result: 'Pants end up shorter than the customer expected; tailor guessed the target length.',
          fix: '“Shorten inseam to 30 inches; customer wearing normal shoes.”'
        },
        {
          bad: '“-2 inches from existing hem.”',
          result: 'Two staff members measure differently; finished length is uneven.',
          fix: '“Finished hem 36 inches from the floor; measure with customer standing straight.”'
        },
        {
          bad: '“Take in waist a little.”',
          result: 'Waist too tight; customer cannot button comfortably.',
          fix: '“Take in waist to 34 inches; confirm comfortable when seated.”'
        },
        {
          bad: '“Use tag size 32.”',
          result: 'Tag was wrong from a previous alteration; hem finishes an inch too long.',
          fix: '“Measured and confirmed: shorten inseam to 30.5; customer approved.”'
        }
      ],
      practicePrompts: [
        {
          bad: '“Shorten a bit.”',
          placeholder: 'Rewrite with a final inseam measurement…',
          example: '“Shorten inseam to 29 inches; balanced on both legs.”'
        },
        {
          bad: '“Hem 2 inches.”',
          placeholder: 'State the final length instead of the change…',
          example: '“Finished hem 37 inches from floor with dress shoes.”'
        },
        {
          bad: '“Take in 2 inches.”',
          placeholder: 'Record the target waist size…',
          example: '“Take in waist to 36 inches; customer can sit comfortably.”'
        },
        {
          bad: '“Use tag inseam 32.”',
          placeholder: 'Replace the tag reference with the measured final number…',
          example: '“Measure and confirm: shorten inseam to 30.5 (customer approved).”'
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which is an objective alteration note?', options: [
          { label: 'Hem 2 inches', value: 'a', correct: false },
          { label: 'Shorten inseam to 30 inches', value: 'b', correct: true },
          { label: 'Make it tighter', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which note follows the no plus/minus rule?', options: [
          { label: 'Take in waist 2 inches', value: 'a', correct: false },
          { label: 'Take in waist to 34 inches', value: 'b', correct: true },
          { label: 'Waist -2', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What does “hem” refer to?', options: [
          { label: 'A verb that means shorten', value: 'a', correct: false },
          { label: 'The folded and sewn edge of the garment', value: 'b', correct: true },
          { label: 'Any measurement on pants', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which format best matches the standard measurement language?', options: [
          { label: 'Shorten a bit', value: 'a', correct: false },
          { label: 'INSEAM 32', value: 'b', correct: true },
          { label: 'Hem pants', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Why can’t you rely on the tag size?', options: [
          { label: 'Tags always match the tailor’s tools', value: 'a', correct: false },
          { label: 'Tags can be wrong from prior alterations or manufacturing; measure and record the confirmed final number instead', value: 'b', correct: true },
          { label: 'Tags are only for dry cleaning codes', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What should you confirm aloud before recording the note?', options: [
          { label: 'That the customer wants “a little shorter”', value: 'a', correct: false },
          { label: 'The exact final measurement such as inseam 30 inches', value: 'b', correct: true },
          { label: 'Whether the tailor can guess the length later', value: 'c', correct: false }
        ]}
      ]
    },
    {
      id: 'M2',
      title: 'Pinning Tools & Safety',
      intro: 'Choose the right pins, lock them safely, and orient them horizontally so garments arrive at the plant without risk.',
      objectives: [
        'Identify and describe straight pins vs. safety pins.',
        'State why safety pins are required for garments traveling to the plant.',
        'Demonstrate correct horizontal pin orientation for hems and seams.',
        'Explain why vertical pinning is not acceptable for alteration pinning.',
        'Apply the pin safety checklist to protect customers, staff, and equipment.',
        'Complete a pre-plant checklist to confirm safe, accurate pinning.'
      ],
      pinTypes: [
        {
          name: 'Straight pins',
          description: 'Simple needle with a colored head at one end; open and sharp at the other.',
          useCases: [
            'On-the-spot fitting while the customer is present.',
            'Quick, temporary holds when you are watching and can remove immediately.',
            'Not safe for garments traveling through bags, racks, and plant equipment.'
          ],
          caution: 'Never send straight pins to the plant. Replace them with closed safety pins before the garment leaves the store.'
        },
        {
          name: 'Safety pins',
          description: 'Pin with a clasp that closes and covers the sharp point when locked.',
          useCases: [
            'Required for any garment leaving the store and going to the plant.',
            'Locks closed so pins cannot fall out or snag machinery.',
            'Best for secure travel in garment bags and racks.'
          ],
          caution: 'Always lock the clasp and place pins horizontally at the measurement line.'
        }
      ],
      policy: {
        headline: 'Non-Negotiable: Safety Pins for Plant-Bound Garments',
        rules: [
          'Any garment traveling to the plant must be secured with closed safety pins.',
          'Prevents loose pins from injuring staff, customers, or tailors.',
          'Protects plant equipment and other garments from snags or jams.',
          'Confirms a stable, readable reference line for the tailor.'
        ],
        note: 'Always warn the customer where pins are placed before they leave, even when using safety pins.'
      },
      orientation: {
        correct: {
          title: 'Horizontal Pinning (Correct)',
          bullets: [
            'Pins run parallel to the floor/hem line and create a clear reference for tailors.',
            'Holds fabric securely during handling and transport.',
            'Maintains the requested length if the garment shifts in the bag.'
          ],
          description: 'Imagine the hem as a line. The pin should lie along that line, like a rail on the hem.'
        },
        incorrect: {
          title: 'Vertical Pinning (Incorrect)',
          bullets: [
            'Pins sit like a fence post crossing the hem and can distort the line.',
            'More likely to slip or change the marked length.',
            'Harder for tailors to read consistently and unsafe for travel.'
          ],
          description: 'Vertical pins cross the hem like a nail; they bend fabric and do not survive transit.'
        }
      },
      safetyChecklist: [
        'Keep sharp points away from skin; never pin through skin or too close to the body.',
        'Confirm pins are horizontal and, if safety pins, fully closed.',
        'Inform the customer where pins are placed before they leave.',
        'Count pins so none are left loose in bags or garments.',
        'Replace any straight pins with safety pins before the garment goes to the plant.'
      ],
      scenarios: [
        {
          prompt: 'You pinned pants for hemming and the customer is leaving them for cleaning and alterations. What type of pin should be in the garment before it goes to the plant?',
          answer: 'Closed safety pins placed horizontally at the new hem line.'
        },
        {
          prompt: 'You quickly pinned a hem while the customer stood on the platform using straight pins. Before sending to the plant, what must you do?',
          answer: 'Replace straight pins with closed safety pins and double-check horizontal orientation.'
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which pin must be used for any garment traveling to the plant?', options: [
          { label: 'Straight dressmaker pin', value: 'a', correct: false },
          { label: 'Safety pin that is closed', value: 'b', correct: true },
          { label: 'No pins—just fold the fabric', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Why is vertical pinning not acceptable?', options: [
          { label: 'It looks nicer in photos', value: 'a', correct: false },
          { label: 'It distorts hems and can slip, changing the length', value: 'b', correct: true },
          { label: 'It uses fewer pins', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What orientation should safety pins have on a hem?', options: [
          { label: 'Horizontal, parallel to the floor', value: 'a', correct: true },
          { label: 'Vertical like a nail', value: 'b', correct: false },
          { label: 'Diagonal to save time', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Before sending a garment to the plant you must…', options: [
          { label: 'Confirm pins are closed, horizontal, and counted', value: 'a', correct: true },
          { label: 'Switch to vertical pins to speed up', value: 'b', correct: false },
          { label: 'Skip telling the customer about the pins', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'When can straight pins be used?', options: [
          { label: 'Only while the customer is present and you will replace them before the garment travels', value: 'a', correct: true },
          { label: 'Anytime because they are faster', value: 'b', correct: false },
          { label: 'Never replace them with safety pins', value: 'c', correct: false }
        ]}
      ]
    },
    {
      id: 'M3',
      title: 'Pinning by Garment Type',
      intro: 'Apply garment-specific pinning with smooth fabric, balanced measurements, and verified customer pins.',
      objectives: [
        'Pin pants, skirts, simple dresses, and sleeves in the correct location and orientation.',
        'Smooth fabric before measuring—never stretch.',
        'Ask male customers if they are left- or right-handed to balance inseams and confirm any preferred drape.',
        'Pin each pant leg separately; document leg length differences instead of assuming symmetry.',
        'Pair one patch to one garment and avoid loose patches.',
        'Guide customers to pick a specific patch spot—no “wherever it looks best.”',
        'Verify customer-pinned garments with a tape measure and confirm the final measurement.',
        'Record objective final dimensions for every pinned garment, including pant type when relevant.'
      ],
      garmentTypes: [
        {
          name: 'Pants (hems + simple waist)',
          csrScope: 'CSR approved',
          pinning: 'Pin horizontally at the new hem line on the left leg first, then repeat on the right—never assume they match. Add 1–2 pins near side seams for waist adjusts.',
          pins: '3–5 pins around each hem keeps the line straight.',
          record: '“Shorten inseam to 30 inches.” If legs differ: “Left inseam to 29.5; Right inseam to 30 (confirmed).”',
          balance: 'Smooth both legs first; ask about handedness and leg length differences to avoid imbalance.'
        },
        {
          name: 'Skirts (hems)',
          csrScope: 'CSR approved',
          pinning: 'Pin evenly around the hem; keep bias fabrics flat without pulling.',
          pins: '4–6 pins spaced evenly at seams and front/back centers.',
          record: '“Shorten hem to 38 inches from waist to floor with heels.”',
          balance: 'Check skirt hangs level on platform; smooth before each pin.'
        },
        {
          name: 'Simple dresses (length only)',
          csrScope: 'CSR approved — escalate complex bodice or beading to Module 5.',
          pinning: 'Pin horizontally at the new length; avoid stretching knit or bias fabric.',
          pins: '3–5 pins across front/back; mirror left/right heights.',
          record: '“Finished length 40 inches shoulder to hem.”',
          balance: 'Keep dress straight on hanger or platform; smooth along the hang line.'
        },
        {
          name: 'Simple sleeves (length)',
          csrScope: 'CSR approved',
          pinning: 'Pin at wrist bone parallel to cuff; note lining if present.',
          pins: '2–3 pins around the sleeve circumference.',
          record: '“Shorten sleeves to 23 inches from shoulder seam.”',
          balance: 'Check both sleeves match and hang evenly when arms relaxed.'
        }
      ],
      smoothRules: {
        headline: 'Smooth, Don’t Stretch',
        bullets: [
          'Before measuring, smooth the fabric along the body line or hem so it lies flat.',
          'Never tug to “help” the measuring tape—stretching adds 1/2”–1” and ruins accuracy.',
          'If fabric rebounds when you let go, you stretched it. Reset, smooth, and re-measure.'
        ]
      },
      handedness: {
        prompt: 'Ask male customers: “Are you left- or right-handed? It helps us balance your inseam.”',
        reason: 'Right-handed customers often load weight on the right leg. Knowing this keeps hems balanced across both legs.',
        action: 'Smooth both legs, pin both hems, and double-check the measured inseam on each side. If customer wants a slightly longer side for balance, leave a small allowance only after measuring and confirming with them.',
        cautions: [
          'Do not invent an adjustment amount. Pin, measure, and confirm with the customer before noting anything extra.',
          'If a customer requests a preferred drape on one side, leave a little extra only on that side and record the measured final length.',
          'Example note: “Right-handed; customer prefers slightly longer right leg. Right inseam = 30.0; Left inseam = 29.75 (confirmed at fitting).”'
        ]
      },
      legLengthCallout: {
        headline: 'Leg Length Differences Are Common',
        bullets: [
          'Customers may already know one leg runs longer or shorter—listen for it and ask follow-up questions.',
          'Pin and measure each leg independently instead of assuming symmetry.',
          'Document differences clearly so the tailor can match the customer’s body.'
        ],
        notes: ['Left inseam to 29.5”', 'Right inseam to 30”'],
        scenario: 'Customer says, “My left leg is shorter, please hem accordingly.”'
      },
      pantsWorkflow: {
        title: 'Pants Hem Workflow',
        steps: [
          'Pin the left leg at the requested length.',
          'Measure and capture the final left inseam.',
          'Pin the right leg separately.',
          'Measure and capture the final right inseam.',
          'Confirm both numbers with the customer and record both if they differ.'
        ]
      },
      patchProtocol: {
        pairing: [
          'One patch must be pinned to one garment—no loose patches in a bag.',
          'If three uniforms arrive with three patches, each patch gets pinned to its exact uniform.',
          'Leave a small note or tape arrow showing which pocket/panel the patch belongs to.'
        ],
        placement: [
          'If a customer says “wherever it looks best,” guide them to pick a spot now.',
          'Have the customer pin while wearing or on a flat surface, or assist them and pin that exact location.',
          'Avoid vague notes like “patch on front.” Choose side/height and secure it with a safety pin.'
        ]
      },
      customerPinned: {
        steps: [
          'Bring out a tape measure and measure the pinned length/spot.',
          'Confirm verbally: “You want the inseam to be 29 inches at this pin, correct?”',
          'Replace loose straight pins with closed safety pins if the garment is leaving the store.',
          'Record the final measurement in notes: “Shorten inseam to 29 inches (customer pinned).”'
        ],
        reason: 'Verification prevents miscommunication and documents the exact, objective request.'
      },
      recording: [
        { item: 'Pants', examples: ['Shorten inseam to 30 inches.', 'Take in waist to 34 inches.', 'Left inseam to 29.5; Right inseam to 30 (confirmed).'] },
        { item: 'Pant Type', examples: ['Jeans: shorten inseam to 30.0.', 'Wool trousers: shorten inseam to 30.0 (customer wearing dress shoes).'] },
        { item: 'Skirts/Dresses', examples: ['Shorten hem to 38 inches waist-to-floor in heels.', 'Finished length 40 inches shoulder to hem.'] },
        { item: 'Sleeves', examples: ['Shorten sleeves to 23 inches from shoulder seam.', 'Match both sleeves at the wrist bone.'] },
        { item: 'Patches', examples: ['Patch pinned to right chest above pocket.', 'One patch per garment; location noted.'] }
      ],
      drapeNotes: {
        headline: 'Drape matters: Jeans vs Trousers',
        bullets: [
          'Denim, wool, and dress trousers hang differently. Note the fabric type so tailors account for drape.',
          'Record the shoe type if it affects where the hem rests.'
        ],
        examples: ['Jeans: shorten inseam to 30.0.', 'Wool trousers: shorten inseam to 30.0 (customer wearing dress shoes).']
      },
      practiceScenarios: [
        {
          prompt: 'Customer says, “My left leg is shorter, please hem accordingly.”',
          response: 'Pin and measure each leg separately, confirm both numbers, and note them individually.'
        },
        {
          prompt: 'Customer mentions being right-handed and wanting the right leg to feel slightly heavier.',
          response: 'Pin normally, measure both legs, leave only the slight confirmed allowance on the right, and record the measured values.'
        }
      ],
      quickChecklist: [
        'Smooth then measure; never stretch to reach the tape.',
        'Pin each pant leg separately: pin/measure left, then pin/measure right.',
        'Ask handedness, measure both legs, and only add extra length if the customer confirms it.',
        'Note pant type (jeans vs trousers) and shoe type if it affects drape.',
        'One patch per garment with a chosen spot, not a guess later.',
        'Customer-pinned? Verify with tape and write the final dimension.'
      ],
      quiz: [
        { type: 'mcq', question: 'How should hems be pinned for pants or skirts?', options: [
          { label: 'Vertically with one pin', value: 'a', correct: false },
          { label: 'Horizontally at the new hem with multiple pins to keep it straight', value: 'b', correct: true },
          { label: 'No pins—just fold the fabric', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Why ask male customers if they are left- or right-handed?', options: [
          { label: 'It changes the fabric type', value: 'a', correct: false },
          { label: 'It helps balance inseams because weight often favors one leg', value: 'b', correct: true },
          { label: 'It is required for payment', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'When legs differ, what is the correct workflow?', options: [
          { label: 'Assume both legs match and average the lengths', value: 'a', correct: false },
          { label: 'Pin and measure each leg separately, then record both numbers', value: 'b', correct: true },
          { label: 'Ignore the difference and note only one inseam', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'How do you handle a handedness request for balance?', options: [
          { label: 'Guess an extra amount on the dominant side', value: 'a', correct: false },
          { label: 'Pin normally, measure, confirm any extra length the customer wants, and record the measured result', value: 'b', correct: true },
          { label: 'Add length to both sides evenly', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Pants hem workflow best practice is to…', options: [
          { label: 'Pin one leg only and copy the number', value: 'a', correct: false },
          { label: 'Pin left leg, measure, pin right leg, measure, then confirm both', value: 'b', correct: true },
          { label: 'Skip measuring if the customer brought a tag', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which note documents drape and garment type clearly?', options: [
          { label: 'Hem pants', value: 'a', correct: false },
          { label: 'Wool trousers: shorten inseam to 30.0 (customer wearing dress shoes).', value: 'b', correct: true },
          { label: 'Take up inseam like usual', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Patch handling rule:', options: [
          { label: 'Send patches loose and sort later', value: 'a', correct: false },
          { label: 'Pin each patch to its specific garment and mark the spot', value: 'b', correct: true },
          { label: 'Stack patches together for speed', value: 'c', correct: false }
        ]}
      ]
    },
    { 
      id: 'M4',
      title: 'SPOT POS Notes & Communication',
      intro: 'Document clear, objective alteration notes in SPOT that mirror the customer’s expectations and the tailor’s needs.',
      objectives: [
        'Enter clear, objective alteration notes in SPOT using final measurements.',
        'Avoid using “hem” as a verb or measurement.',
        'Use phrases like “shorten to 36 inches” instead of “hem to 36 inches” or “shorten a bit”.',
        'Mirror the customer’s expectations back to them verbally and in the written note.',
        'Identify and correct vague, incomplete, or risky POS notes.',
        'Use SPOT fields consistently (item description vs. notes) to convey alterations to the tailor.',
        'Include garment type and measured final inseam (not tag size) when drape or balance matters.'
      ],
      objectiveNotes: {
        correct: [
          '✅ Shorten inseam to 30 inches. Customer tried on and approved.',
          '✅ Take in waist to 34 inches. Measure flat at waistband.',
          '✅ Shorten sleeves to 23 inches from shoulder seam; match both sleeves.',
          '✅ Jeans: shorten inseam to 30.0 (measured, not from tag).',
          '✅ Wool trousers: shorten inseam to 30.0 (customer wearing dress shoes).'
        ],
        incorrect: [
          '❌ Hem pants.',
          '❌ Hem 2 inches.',
          '❌ Take in 2 inches.',
          '❌ Shorten a bit.',
          '❌ Inseam 32 (per tag).'
        ],
        reminder: 'SPOT notes should read like the final measurement instruction the tailor will sew to — not a hint or a guess.'
      },
      hemGuidance: {
        definition: '“Hem” refers to the folded and sewn edge of the garment. It is not a measurement or a verb.',
        wrong: ['Hem dress 2 inches.', 'Hem to 36 inches.'],
        better: ['Shorten dress so finished hem is 36 inches from shoulder to hem.', 'Shorten pants so inseam finishes at 30 inches.'],
        reminder: 'Replace “hem to” with “shorten to” plus the final dimension.'
      },
      comparisons: [
        { bad: 'Hem to 36 inches', good: 'Shorten dress so finished hem is 36 inches from shoulder to hem.' },
        { bad: 'Hem pants 2 inches', good: 'Shorten inseam to 30 inches.' },
        { bad: 'Hem sleeves', good: 'Shorten sleeves to 23 inches from shoulder seam.' },
        { bad: 'Use tag length 32', good: 'Measured and confirmed inseam to 30.5 (customer approved).' }
      ],
      standardFormats: [
        { label: 'INSEAM', example: 'INSEAM 30', note: 'Final inseam measurement after hemming. Avoid +/- shorthand.' },
        { label: 'WAIST', example: 'WAIST 34', note: 'State the finished waist size after taking in or letting out.' },
        { label: 'SLEEVE', example: 'SLEEVE 23 from shoulder seam', note: 'Include the reference point so tailors know where to measure.' },
        { label: 'HEM LENGTH', example: 'Finished hem 36 from floor with flats', note: 'Spell out the measurement and shoe type if relevant.' },
        { label: 'PANT TYPE', example: 'Jeans: shorten inseam to 30.0 (measured)', note: 'Include fabric type because denim vs trousers drape differently.' }
      ],
      fieldUsage: [
        'Item/Service lines describe the garment and service (e.g., “Men’s Pants — Dry Clean + Hem”).',
        'Use the Notes field for the exact alteration and final measurement.',
        'Mirror approvals: “Customer tried on and approved length with normal shoes.”',
        'Tag customer-pinned garments: “Shorten inseam to 29 inches (customer pinned, verified).”',
        'Note pant type and measured inseam instead of tag size when recording hems.'
      ],
      posExamples: [
        {
          item: 'Men’s Pants',
          service: 'Dry Clean + Hem',
          before: 'Hem pants.',
          after: 'Shorten inseam to 30 inches. Customer tried on and approved.',
          why: 'Before is vague and missing the target length. After states the finished inseam and approval.'
        },
        {
          item: 'Mens Jeans',
          service: 'Hem only',
          before: 'Use tag length 32.',
          after: 'Jeans: measured and confirmed inseam to 30.5. Customer approved.',
          why: 'Tag length is unreliable; final measured inseam and garment type are recorded.'
        },
        {
          item: 'Knee-length Dress',
          service: 'Press + Hem',
          before: 'Hem to 36 inches.',
          after: 'Shorten dress so finished hem is 36 inches from shoulder to hem. Customer wearing flats.',
          why: 'Replaces “hem to” with a clear action, final value, and context.'
        },
        {
          item: 'Blazer',
          service: 'Sleeve shorten',
          before: 'Shorten sleeves a bit.',
          after: 'Shorten sleeves to 23 inches from shoulder seam. Match both sleeves.',
          why: 'Vague wording becomes a measurable instruction with a reference point.'
        }
      ],
      scripts: {
        confirm: '“To make sure we get this right, I’m going to write: ‘Shorten inseam to 30 inches.’ Does that match what you’re expecting?”',
        clarify: 'Customer: “Just a bit shorter.” CSR: “Perfect. Let me pin the length you like and then I’ll write ‘Shorten inseam to __ inches’ so our tailor knows exactly what you want.”',
        hemFix: '“Because hem is the finished edge, I’ll note the action and final length: ‘Shorten so finished hem is 36 inches from shoulder to hem.’”'
      },
      corrections: [
        { bad: 'Shorten a little', good: 'Shorten inseam to 29 inches.' },
        { bad: 'Fix hem', good: 'Re-hem to 30-inch inseam; clean and press.' },
        { bad: 'Take in', good: 'Take in waist to 34 inches.' },
        { bad: 'Shorten sleeves some', good: 'Shorten sleeves to 23 inches from shoulder seam.' },
        { bad: 'Use tag size for hem', good: 'Measured and confirmed inseam to 30.5; do not reference tag size.' }
      ],
      noteChecklist: [
        'Start with the garment area and final measurement: “INSEAM 30,” “WAIST 34.”',
        'Avoid “hem” as a verb; use “shorten to” plus the finished length.',
        'Capture approvals: “Customer tried on and approved.”',
        'If customer pinned, verify with a tape and note “customer pinned/verified.”',
        'Include pant type when relevant (jeans vs trousers) and avoid tag references; record the measured final value.',
        'Keep SPOT Notes factual and objective; no “a bit” or “as needed.”'
      ],
      quiz: [
        { type: 'mcq', question: 'Which SPOT note is correct?', options: [
          { label: 'Hem pants', value: 'a', correct: false },
          { label: 'Shorten inseam to 30 inches. Customer approved.', value: 'b', correct: true },
          { label: 'Take in 2 inches', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which phrasing avoids using “hem” as a verb?', options: [
          { label: 'Hem to 36 inches', value: 'a', correct: false },
          { label: 'Shorten so finished hem is 36 inches from shoulder to hem', value: 'b', correct: true },
          { label: 'Hem a bit', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which note correctly replaces a tag reference?', options: [
          { label: 'Use tag inseam 32', value: 'a', correct: false },
          { label: 'Measured and confirmed inseam to 30.5; customer approved.', value: 'b', correct: true },
          { label: 'Shorten to whatever fits', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What must every note mirror back to the customer?', options: [
          { label: 'A vague sense of the change', value: 'a', correct: false },
          { label: 'The exact final measurement they approved', value: 'b', correct: true },
          { label: 'Whatever the CSR thinks is best', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which format matches SPOT standards and records pant type?', options: [
          { label: 'Jeans: shorten inseam to 30.0 (measured, customer approved)', value: 'a', correct: true },
          { label: 'Hem jeans a bit shorter', value: 'b', correct: false },
          { label: 'Use tag size since it is close', value: 'c', correct: false }
        ]}
      ]
    },
    {
      id: 'M5',
      title: 'Exceptions & Escalation',
      intro: 'Recognize tailor-only garments, protect complex pieces, and escalate with respectful, confident language.',
      objectives: [
        'Recognize garments and alteration types that are CSR-approved versus tailor-only.',
        'Decide quickly when not to pin and instead escalate to a tailor.',
        'Use clear, respectful scripts to explain escalation to customers.',
        'Apply a Customer-Pinned Protocol for complex or risky garments.',
        'Document exceptions and escalations so the tailor understands context.',
        'Prioritize safety and garment integrity over speed when making decisions.'
      ],
      tailorOnlyCategories: [
        {
          title: 'Complex or High-Risk Garments',
          items: [
            'Wedding dresses and formal gowns with multiple layers.',
            'Garments with heavy beading, sequins, or intricate lace.',
            'Custom suits or high-end designer garments with special construction.'
          ]
        },
        {
          title: 'Delicate or Specialty Fabrics',
          items: [
            'Very delicate silk, chiffon, or tulle where pinning could cause holes.',
            'Leather, suede, or coated fabrics that might mark or puncture.'
          ]
        },
        {
          title: 'Complex Alterations',
          items: [
            'Major resizing such as multiple seams, bodice work, or re-cutting.',
            'Complex jacket tailoring like shoulder work or major re-shaping.',
            'Any alteration that changes the basic structure of the garment.'
          ]
        }
      ],
      comparison: {
        csrApproved: [
          'Basic pant hems with clear final inseam.',
          'Simple waist take-ins on casual pants or skirts.',
          'Straightforward sleeve or dress length changes without embellishment.'
        ],
        tailorOnly: [
          'Heavily beaded gowns or lace overlays.',
          'Leather or suede pieces that could mark with pins.',
          'Major re-shaping that changes how a garment is built.'
        ]
      },
      customerPinnedProtocol: {
        steps: [
          'Acknowledge the customer effort and preferences.',
          'Explain the garment is complex or high-risk and needs tailor review.',
          'Do not sew or adjust until the tailor confirms the pinning.',
          'Document: “Customer-pinned; tailor to review before proceeding. Do not alter until tailor approves.”'
        ],
        reminder: 'CSR role: protect the garment, the customer’s investment, and the company’s reputation.'
      },
      escalationTriggers: [
        'Customer is unsure about what they want and the garment is complex.',
        'Fabric appears fragile or easily damaged by pins.',
        'Requested change is major (size, shape, drape).',
        'CSR feels uncomfortable or not confident about where or how to pin.'
      ],
      scripts: [
        {
          title: 'General Tailor-Only',
          line: 'Because of the detail and fabric on this piece, our tailor needs to handle the pinning to make sure it’s done safely and correctly. I’ll note your request and have them look at it.'
        },
        {
          title: 'High-Risk Fabric',
          line: 'This fabric can mark easily if pinned the wrong way. To protect your garment, I’m going to have our tailor review and pin it personally.'
        },
        {
          title: 'Customer-Pinned Complex Garment',
          line: 'I see you’ve pinned where you’d like it, thank you. Because this is a more delicate or complex piece, our tailor will double-check and confirm everything before sewing so we don’t risk damage.'
        },
        {
          title: 'When CSR Is Unsure',
          line: 'I want to make sure this turns out exactly how you expect. I’m going to have our tailor review this with your notes instead of me pinning it.'
        }
      ],
      documentationNotes: [
        'Tailor-only: beaded bodice; customer wants length to floor with heels; tailor to pin and advise.',
        'Customer pinned train on wedding dress; tailor to review pinned length before sewing.',
        'Leather jacket shoulder reshape requested; escalate to tailor for structural plan before any pinning.'
      ],
      boundaryStatements: [
        'Employees are expected to say “This needs a tailor” instead of guessing on risky garments.',
        'Slowing down and escalating is safer than damaging a high-value garment.'
      ],
      quiz: [
        { type: 'mcq', question: 'Which garment must be escalated to the tailor?', options: [
          { label: 'Simple cotton chinos needing a hem', value: 'a', correct: false },
          { label: 'Wedding dress with beading and multiple layers', value: 'b', correct: true },
          { label: 'Casual skirt needing a basic waist take-in', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Customer pinned a delicate, beaded gown. What should you do first?', options: [
          { label: 'Accept the pins and send to the plant', value: 'a', correct: false },
          { label: 'Escalate to tailor review before altering', value: 'b', correct: true },
          { label: 'Remove all pins and start over without notes', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Feeling unsure about a complex garment is…', options: [
          { label: 'A signal to escalate to the tailor', value: 'a', correct: true },
          { label: 'A reason to keep pinning anyway', value: 'b', correct: false },
          { label: 'A chance to ask the customer to guess', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'What documentation should you add for customer-pinned complex garments?', options: [
          { label: 'Note that a tailor must review before proceeding', value: 'a', correct: true },
          { label: 'Say nothing because pins explain it', value: 'b', correct: false },
          { label: 'Promise to sew exactly as pinned without review', value: 'c', correct: false }
        ]},
        { type: 'mcq', question: 'Which escalation script tone best matches policy?', options: [
          { label: 'Polite, confident explanation that a tailor will review for safety', value: 'a', correct: true },
          { label: 'Telling the customer the garment is too hard to handle', value: 'b', correct: false },
          { label: 'Promising to try pinning quickly anyway', value: 'c', correct: false }
        ]}
      ]
    }
  ];

  const moduleTimeEstimates = {
    M1: 20,
    M2: 15,
    M3: 25,
    M4: 20,
    M5: 20
  };

  const totalProgramMinutes = Object.values(moduleTimeEstimates).reduce((sum, minutes) => sum + minutes, 0);

  let lastCertificationStatus = null;

  document.addEventListener('DOMContentLoaded', () => {
    setTotalEstimateText();
    setRemainingEstimatePlaceholder();
    renderNavigation();
    renderModules();
    bindIdentityPersistence();
    restoreIdentityFromStorage();
    updateCertificateButtonState(lastCertificationStatus);
    setupPrintCertificateButton();
    loadCertificationStatus();
  });

  function setTotalEstimateText() {
    const totalEstimateEl = document.getElementById('total-time-estimate');
    if (totalEstimateEl) {
      totalEstimateEl.textContent = `Estimated time for full certification: ${formatMinutes(totalProgramMinutes)}.`;
    }
  }

  function setRemainingEstimatePlaceholder() {
    const remainingEstimateEl = document.getElementById('remaining-time-estimate');
    if (remainingEstimateEl) {
      remainingEstimateEl.textContent = 'Estimated time remaining: enter your name to calculate.';
    }
  }

  function getEmployeeName() {
    return document.getElementById('employeeName').value.trim();
  }

  function getEmployeeLocation() {
    return document.getElementById('employeeLocation').value.trim();
  }

  function updateCertificateButtonState(status) {
    const isCertified = !!(status && status.isCertified);
    const buttons = [
      document.getElementById('print-certificate-button'),
      document.getElementById('header-certificate-button')
    ];

    buttons.forEach(btn => {
      if (!btn) return;
      if (isCertified) {
        btn.removeAttribute('disabled');
        btn.setAttribute('aria-disabled', 'false');
        btn.title = 'Generate certificate PDF for this certified employee.';
      } else {
        btn.setAttribute('disabled', 'disabled');
        btn.setAttribute('aria-disabled', 'true');
        btn.title = 'Pass all five modules to unlock certificate printing';
      }
    });
  }

  function formatMinutes(minutes) {
    if (minutes <= 0) return '~0 minutes';
    const hours = Math.floor(minutes / 60);
    const remainingMinutes = minutes % 60;
    if (!hours) {
      return `~${minutes} minute${minutes === 1 ? '' : 's'}`;
    }
    const hourLabel = `${hours} hr${hours === 1 ? '' : 's'}`;
    const minuteLabel = remainingMinutes ? ` ${remainingMinutes} min` : '';
    return `~${hourLabel}${minuteLabel}`;
  }

  function calculateRemainingMinutes(missingModules = []) {
    return missingModules.reduce((total, moduleId) => total + (moduleTimeEstimates[moduleId] || 0), 0);
  }

  function updateTimeEstimates(missingModules) {
    const remainingEstimateEl = document.getElementById('remaining-time-estimate');
    const remainingMinutes = calculateRemainingMinutes(missingModules || []);
    if (remainingEstimateEl) {
      remainingEstimateEl.textContent = `Estimated time remaining: ${formatMinutes(remainingMinutes)}`;
    }
  }

  function renderNavigation() {
    const navList = document.getElementById('navList');
    navList.innerHTML = modules.map(module => `<li><button class="nav-link" onclick="navigateToSection('module-${module.id}', this)">${module.id} — ${module.title}</button></li>`).join('');
  }

  function renderModules() {
    const container = document.getElementById('moduleContainer');
    container.innerHTML = modules.map(module => moduleTemplate(module)).join('');
  }

  function renderModuleNavigation(moduleId) {
    const moduleNumber = parseInt(moduleId.replace('M', ''), 10);
    const totalModules = modules.length;
    const hasPrevious = moduleNumber > 1;
    const hasNextModule = moduleNumber < totalModules;
    const nextTarget = hasNextModule ? `module-M${moduleNumber + 1}` : 'dashboard';
    const nextLabel = hasNextModule ? `Next: Module ${moduleNumber + 1}` : 'Next: Certification Status';

    const previousButton = hasPrevious
      ? `<button type="button" class="nav-button" onclick="navigateToSection('module-M${moduleNumber - 1}')">Previous: Module ${moduleNumber - 1}</button>`
      : '';

    return `
            <div class="module-nav" aria-label="Module navigation">
              ${previousButton}
              <button type="button" class="nav-button primary" onclick="navigateToSection('${nextTarget}')">${nextLabel}</button>
            </div>`;
  }

  function moduleTemplate(module) {
    if (module.id === 'M1') {
      return moduleOneTemplate(module);
    }
    if (module.id === 'M2') {
      return moduleTwoTemplate(module);
    }
    if (module.id === 'M3') {
      return moduleThreeTemplate(module);
    }
    if (module.id === 'M4') {
      return moduleFourTemplate(module);
    }
    if (module.id === 'M5') {
      return moduleFiveTemplate(module);
    }
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const sections = module.sections.map(section => `
      <div class="section">
        <h3>${section.title}</h3>
        <ul>${section.bullets.map(b => `<li>${b}</li>`).join('')}</ul>
      </div>`).join('');
    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module" id="${module.id}">
          <span class="pill">Module ${module.id.replace('M','')}</span>
          <h2 id="${headingId}" tabindex="-1">${module.title}</h2>
          <p>${module.intro}</p>
          <div class="section">
            <h3>Learning Objectives</h3>
            <ul>${objectives}</ul>
          </div>
          ${sections}
          <div class="section callout">
            <strong>Visual/Diagram Descriptions:</strong>
            <ul>${module.sections.map(s => s.bullets.find(b => b.toLowerCase().includes('diagram') || b.toLowerCase().includes('visual'))).filter(Boolean).map(item => `<li>${item}</li>`).join('') || '<li>See notes above.</li>'}</ul>
          </div>
          <div class="quiz" aria-label="quiz for ${module.title}">
            <h3>Knowledge Check</h3>
            ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
          ${renderModuleNavigation(module.id)}
        </div>
      </article>
    </section>
  `;
  }

  function moduleOneTemplate(module) {
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const subjectiveList = module.vocabulary.subjective.map(item => `<li>❌ ${item}</li>`).join('');
    const objectiveList = module.vocabulary.objective.map(item => `<li>✅ ${item}</li>`).join('');
    const rules = module.measurementRules.map(rule => `
      <div class="rule-card">
        <h4>${rule.title}</h4>
        <p>${rule.details}</p>
      </div>
    `).join('');
    const hemPoints = module.hemCallout.points.map(point => `<li>${point}</li>`).join('');
    const scenarios = module.complaintScenarios.map(scenario => `
      <div class="scenario-card">
        <p class="eyebrow">Bad Note</p>
        <p class="bad">${scenario.bad}</p>
        <p class="eyebrow">Complaint</p>
        <p>${scenario.result}</p>
        <p class="eyebrow">Corrected Note</p>
        <p class="good">${scenario.fix}</p>
      </div>
    `).join('');
    const practices = module.practicePrompts.map((prompt, idx) => `
      <div class="practice-card">
        <div class="practice-header">
          <p class="eyebrow">Rewrite Prompt ${idx + 1}</p>
          <span class="tag">Practice</span>
        </div>
        <p class="bad">${prompt.bad}</p>
        <label class="sr-only" for="practice-${idx}">Rewrite prompt ${idx + 1}</label>
        <input id="practice-${idx}" type="text" placeholder="${prompt.placeholder}" />
        <p class="hint">Example: ${prompt.example}</p>
      </div>
    `).join('');
    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module" id="${module.id}">
        <span class="pill">Module ${module.id.replace('M','')}</span>
        <h2 id="${headingId}" tabindex="-1">${module.title}</h2>
        <p>${module.intro}</p>

        <div class="section">
          <h3>Learning Objectives</h3>
          <ul>${objectives}</ul>
        </div>

        <div class="section concept-grid">
          <div class="concept-card">
            <h3>Subjective vs Objective</h3>
            <div class="list-row">
              <div>
                <p class="eyebrow">Avoid</p>
                <ul>${subjectiveList}</ul>
              </div>
              <div>
                <p class="eyebrow">Use Instead</p>
                <ul>${objectiveList}</ul>
              </div>
            </div>
            <p class="tip">Ask the customer to stand naturally, measure the preferred fit, and document the final number.</p>
          </div>
          <div class="concept-card highlight">
            <h3>Standard Measurement Language</h3>
            <p>Use formats that travel clearly to the tailor:</p>
            <ul>
              <li>INSEAM 30 / INSEAM 32</li>
              <li>OUTSEAM 40</li>
              <li>WAIST 36</li>
              <li>“Shorten sleeves to 23 inches from shoulder seam.”</li>
            </ul>
            <p class="tip">Never record “a little” or “+/-” values—capture the final measurement instead.</p>
          </div>
        </div>

        <div class="section rule-grid">
          ${rules}
        </div>

        <div class="section hem-callout">
          <div>
            <p class="eyebrow">Hem Reminder</p>
            <h3>${module.hemCallout.heading}</h3>
            <ul>${hemPoints}</ul>
          </div>
          <div class="hem-visual">
            <p class="badge-lite">Garment Part</p>
            <p>The hem is the folded, sewn edge. It needs a target length to make sense.</p>
          </div>
        </div>

        <div class="section scenario-grid">
          <h3>Complaint Prevention Examples</h3>
          ${scenarios}
        </div>

        <div class="section practice-grid" aria-label="Rewrite practice for clearer notes">
          <h3>Rewrite Practice (not graded)</h3>
          <p class="subtitle">Rewrite each vague note as a final, objective instruction. Use the examples as guidance.</p>
          <div class="practice-list">${practices}</div>
        </div>

        <div class="section script-card">
          <h3>Confirmation Script</h3>
          <p>“I’ll note <strong>‘shorten inseam to 30 inches’</strong>. Is that exactly what you want?” Repeat back the final measurement before saving it.</p>
        </div>

        <div class="quiz" aria-label="quiz for ${module.title}">
          <h3>Knowledge Check</h3>
          ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
          ${renderModuleNavigation(module.id)}
        </div>
        </article>
      </section>
    `;
  }

  function moduleFourTemplate(module) {
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const correctList = module.objectiveNotes.correct.map(item => `<li>${item}</li>`).join('');
    const incorrectList = module.objectiveNotes.incorrect.map(item => `<li>${item}</li>`).join('');
    const hemWrong = module.hemGuidance.wrong.map(item => `<li>❌ ${item}</li>`).join('');
    const hemBetter = module.hemGuidance.better.map(item => `<li>✅ ${item}</li>`).join('');
    const comparisonRows = module.comparisons.map(pair => `
      <div class="comparison-row">
        <div class="bad">${pair.bad}</div>
        <div class="good">${pair.good}</div>
      </div>
    `).join('');
    const formatCards = module.standardFormats.map(format => `
      <div class="format-card">
        <div class="format-label">${format.label}</div>
        <p class="format-example">${format.example}</p>
        <p class="micro-copy">${format.note}</p>
      </div>
    `).join('');
    const fieldUsage = module.fieldUsage.map(item => `<li>${item}</li>`).join('');
    const posMockups = module.posExamples.map(example => `
      <div class="pos-card">
        <div class="pos-card__header">
          <div>
            <p class="eyebrow">Item</p>
            <h4>${example.item}</h4>
          </div>
          <div class="pos-service">${example.service}</div>
        </div>
        <div class="pos-note-grid">
          <div>
            <p class="pill pill-quiet">Before</p>
            <p class="bad">${example.before}</p>
          </div>
          <div>
            <p class="pill">After</p>
            <p class="good">${example.after}</p>
          </div>
        </div>
        <p class="micro-copy">${example.why}</p>
      </div>
    `).join('');
    const scripts = [
      { title: 'Confirmation', line: module.scripts.confirm },
      { title: 'Clarifying vague requests', line: module.scripts.clarify },
      { title: 'Fixing “hem” language', line: module.scripts.hemFix }
    ].map(script => `
      <div class="script-card">
        <p class="eyebrow">${script.title}</p>
        <p>${script.line}</p>
      </div>
    `).join('');
    const corrections = module.corrections.map(item => `<li><span class="bad">${item.bad}</span> → <span class="good">${item.good}</span></li>`).join('');
    const checklist = module.noteChecklist.map(item => `<li>${item}</li>`).join('');
    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module module-four" id="${module.id}">
        <span class="pill">Module ${module.id.replace('M','')}</span>
        <h2 id="${headingId}" tabindex="-1">${module.title}</h2>
        <p>${module.intro}</p>

        <div class="section">
          <h3>Learning Objectives</h3>
          <ul>${objectives}</ul>
        </div>

        <div class="section module-four__grid" aria-label="Objective SPOT note examples">
          <div class="note-card">
            <p class="eyebrow">Objective Notes in SPOT POS</p>
            <div class="note-columns">
              <div>
                <p class="badge-lite">Correct</p>
                <ul>${correctList}</ul>
              </div>
              <div>
                <p class="pill pill-quiet">Avoid</p>
                <ul>${incorrectList}</ul>
              </div>
            </div>
            <p class="tip">${module.objectiveNotes.reminder}</p>
          </div>
          <div class="note-card hem-guard">
            <p class="eyebrow">Avoid Using “Hem” as a Verb</p>
            <p>${module.hemGuidance.definition}</p>
            <div class="note-columns">
              <div>
                <p class="pill pill-quiet">Wrong</p>
                <ul>${hemWrong}</ul>
              </div>
              <div>
                <p class="pill pill-quiet">Better</p>
                <ul>${hemBetter}</ul>
              </div>
            </div>
            <p class="tip">${module.hemGuidance.reminder}</p>
          </div>
        </div>

        <div class="section comparison-table" aria-label="Shorten vs hem wording">
          <h3>“Shorten to X” vs “Hem to X”</h3>
          <div class="comparison-grid">${comparisonRows}</div>
        </div>

        <div class="section format-grid" aria-label="Standard POS formats">
          <h3>Using Standard Formats in SPOT</h3>
          <p class="micro-copy">Lead with the garment area and the final measurement so tailors can act without guessing.</p>
          <div class="format-cards">${formatCards}</div>
        </div>

        <div class="section field-usage" aria-label="SPOT field usage guidance">
          <h3>Use SPOT Fields Consistently</h3>
          <ul>${fieldUsage}</ul>
        </div>

        <div class="section pos-mockups" aria-label="POS note walkthrough">
          <h3>POS Screen Note Examples</h3>
          <p class="micro-copy">These text mockups show how to capture the garment, service, and objective note the tailor will follow.</p>
          <div class="mockup-grid">${posMockups}</div>
        </div>

        <div class="section script-grid" aria-label="Customer communication scripts">
          <h3>Customer Communication Scripts</h3>
          <p class="subtitle">Mirror the customer’s expectation verbally, then repeat it in the SPOT note.</p>
          <div class="script-grid__inner">${scripts}</div>
        </div>

        <div class="section correction-list" aria-label="Correcting vague notes">
          <h3>Correcting Bad Notes</h3>
          <ul>${corrections}</ul>
        </div>

        <div class="section checklist-lite" aria-label="Note entry checklist">
          <h3>Quick SPOT Note Checklist</h3>
          <ul>${checklist}</ul>
        </div>

        <div class="quiz" aria-label="quiz for ${module.title}">
          <h3>Knowledge Check</h3>
          ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
          ${renderModuleNavigation(module.id)}
        </div>
        </article>
      </section>
    `;
  }

  // Module 2 uses custom layout classes (pin-grid, policy-card, orientation-grid) defined in styles.html.
  function moduleTwoTemplate(module) {
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const pinCards = module.pinTypes.map(pin => `
      <div class="pin-card">
        <div class="pin-card__header">
          <span class="pill pill-quiet">Pin Type</span>
          <h3>${pin.name}</h3>
        </div>
        <p class="micro-copy">${pin.description}</p>
        <ul>${pin.useCases.map(use => `<li>${use}</li>`).join('')}</ul>
        <div class="note-line">${pin.caution}</div>
      </div>
    `).join('');

    const checklist = module.safetyChecklist.map(item => `<li>${item}</li>`).join('');
    const scenarios = module.scenarios.map((s, idx) => `
      <div class="scenario-card">
        <p class="eyebrow">Scenario ${idx + 1}</p>
        <p><strong>${s.prompt}</strong></p>
        <p class="answer">Answer: ${s.answer}</p>
      </div>
    `).join('');

    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module" id="${module.id}">
        <span class="pill">Module ${module.id.replace('M','')}</span>
        <h2 id="${headingId}" tabindex="-1">${module.title}</h2>
        <p>${module.intro}</p>

        <div class="section">
          <h3>Learning Objectives</h3>
          <ul>${objectives}</ul>
        </div>

        <div class="section pin-grid" aria-label="Pin type comparison">
          ${pinCards}
        </div>

        <div class="section policy-card" aria-label="Safety pin policy">
          <div>
            <p class="eyebrow">Plant Travel Rule</p>
            <h3>${module.policy.headline}</h3>
            <ul>${module.policy.rules.map(rule => `<li>${rule}</li>`).join('')}</ul>
            <p class="note-line">${module.policy.note}</p>
          </div>
          <div class="policy-badge">
            <div class="badge-warning">Safety pins only</div>
            <p class="micro-copy">Closed clasps prevent injuries and protect machinery.</p>
          </div>
        </div>

        <div class="section orientation-grid" aria-label="Pin orientation examples">
          <div class="orientation-card good">
            <p class="pill pill-quiet">Correct</p>
            <h3>${module.orientation.correct.title}</h3>
            <ul>${module.orientation.correct.bullets.map(item => `<li>${item}</li>`).join('')}</ul>
            <p class="micro-copy">${module.orientation.correct.description}</p>
          </div>
          <div class="orientation-card risk">
            <p class="pill pill-quiet">Incorrect</p>
            <h3>${module.orientation.incorrect.title}</h3>
            <ul>${module.orientation.incorrect.bullets.map(item => `<li>${item}</li>`).join('')}</ul>
            <p class="micro-copy">${module.orientation.incorrect.description}</p>
          </div>
        </div>

        <div class="section checklist" aria-label="Pin safety checklist">
          <div>
            <p class="eyebrow">Quick Safety</p>
            <h3>Pin Safety Checklist</h3>
            <ul>${checklist}</ul>
          </div>
          <div class="checklist-note">
            <p class="badge-lite">Checklist Reminder</p>
            <p>Use this before every plant-bound garment leaves the counter.</p>
            <p class="micro-copy">Imagine the hem as a line — pins should sit on that line (horizontal), never crossing it like a fence post (vertical).</p>
          </div>
        </div>

        <div class="section scenario-grid" aria-label="Pin safety scenarios">
          <h3>Pin Safety Scenarios</h3>
          ${scenarios}
        </div>

        <div class="quiz" aria-label="quiz for ${module.title}">
          <h3>Knowledge Check</h3>
          ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
          ${renderModuleNavigation(module.id)}
        </div>
        </article>
      </section>
    `;
  }

  // Module 3 focuses on garment-specific pinning, smoothing fabric, handedness, patches, and customer-pinned verification.
  // New layout classes are defined in styles.html and scoped with the prefix module-three- where applicable.
  function moduleThreeTemplate(module) {
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');

    const garmentCards = module.garmentTypes.map(type => `
      <div class="garment-card">
        <div class="garment-card__header">
          <span class="pill pill-quiet">${type.csrScope}</span>
          <h3>${type.name}</h3>
        </div>
        <ul>
          <li><strong>Where to pin:</strong> ${type.pinning}</li>
          <li><strong>Recommended pins:</strong> ${type.pins}</li>
          <li><strong>Record it as:</strong> ${type.record}</li>
          <li><strong>Stay balanced:</strong> ${type.balance}</li>
        </ul>
      </div>
    `).join('');

    const legCalloutBullets = module.legLengthCallout.bullets.map(item => `<li>${item}</li>`).join('');
    const legCalloutNotes = module.legLengthCallout.notes.map(note => `<span class="note-chip">${note}</span>`).join('');
    const workflowSteps = module.pantsWorkflow.steps.map((step, idx) => `<li><strong>Step ${idx + 1}:</strong> ${step}</li>`).join('');
    const smoothList = module.smoothRules.bullets.map(item => `<li>${item}</li>`).join('');
    const pairingList = module.patchProtocol.pairing.map(item => `<li>${item}</li>`).join('');
    const placementList = module.patchProtocol.placement.map(item => `<li>${item}</li>`).join('');
    const verificationSteps = module.customerPinned.steps.map((step, idx) => `<li><strong>Step ${idx + 1}:</strong> ${step}</li>`).join('');
    const recordingRows = module.recording.map(row => `
      <div class="metric-row">
        <div class="metric-label">${row.item}</div>
        <div class="metric-examples">${row.examples.map(ex => `<p>${ex}</p>`).join('')}</div>
      </div>
    `).join('');
    const handednessCautions = module.handedness.cautions.map(item => `<li>${item}</li>`).join('');
    const drapeBullets = module.drapeNotes.bullets.map(item => `<li>${item}</li>`).join('');
    const drapeExamples = module.drapeNotes.examples.map(example => `<span class="note-chip">${example}</span>`).join('');
    const practiceScenarios = module.practiceScenarios.map(scenario => `
      <div class="scenario-card">
        <p class="eyebrow">Customer says</p>
        <p class="bad">“${scenario.prompt}”</p>
        <p class="eyebrow">You do</p>
        <p class="good">${scenario.response}</p>
      </div>
    `).join('');
    const quickChecklist = module.quickChecklist.map(item => `<li>${item}</li>`).join('');
    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module" id="${module.id}">
        <span class="pill">Module ${module.id.replace('M','')}</span>
        <h2 id="${headingId}" tabindex="-1">${module.title}</h2>
        <p>${module.intro}</p>

        <div class="section">
          <h3>Learning Objectives</h3>
          <ul>${objectives}</ul>
        </div>

        <div class="section garment-grid" aria-label="Garment pinning guidance">
          ${garmentCards}
        </div>

        <div class="section policy-callout" aria-label="Leg length differences">
          <div>
            <p class="eyebrow">Balance note</p>
            <h3>${module.legLengthCallout.headline}</h3>
            <ul>${legCalloutBullets}</ul>
            <p class="micro-copy"><strong>Practice scenario:</strong> ${module.legLengthCallout.scenario}</p>
          </div>
          <div class="note-chip-row" aria-label="Note format examples">${legCalloutNotes}</div>
        </div>

        <div class="section workflow-card" aria-label="Pants hem workflow">
          <p class="eyebrow">Repeatable steps</p>
          <h3>${module.pantsWorkflow.title}</h3>
          <ol>${workflowSteps}</ol>
        </div>

        <div class="section callout-card" aria-label="Smooth fabric guidance">
          <div>
            <p class="eyebrow">Accuracy Rule</p>
            <h3>${module.smoothRules.headline}</h3>
            <ul>${smoothList}</ul>
          </div>
          <div class="stretch-risk">
            <p class="badge-lite">Do not stretch</p>
            <p>Stretching a pant leg can add 1/2”–1” instantly. Smooth first, then measure.</p>
          </div>
        </div>

        <div class="section two-column" aria-label="Handedness and balance">
          <div class="card-lite">
            <p class="eyebrow">Balance tip for men</p>
            <h3>Left- vs Right-Handed Inseam Check</h3>
            <p class="micro-copy">${module.handedness.prompt}</p>
            <ul>
              <li>${module.handedness.reason}</li>
              <li>${module.handedness.action}</li>
            </ul>
            <div class="callout">
              <p class="eyebrow">Handedness confirmations</p>
              <ul>${handednessCautions}</ul>
            </div>
          </div>
          <div class="card-lite">
            <p class="eyebrow">Pin orientation</p>
            <h3>Keep pins horizontal</h3>
            <p>Mirror pins on both sides so hems stay even when the garment hangs or travels.</p>
          </div>
        </div>

        <div class="section two-column" aria-label="Patch protocol and placement">
          <div class="card-lite">
            <p class="eyebrow">Patch protocol</p>
            <h3>One Patch, One Garment</h3>
            <ul>${pairingList}</ul>
          </div>
          <div class="card-lite">
            <p class="eyebrow">Placement coaching</p>
            <h3>Pick the Exact Spot</h3>
            <ul>${placementList}</ul>
          </div>
        </div>

        <div class="section verification" aria-label="Customer pinned garment verification">
          <div>
            <p class="eyebrow">Customer-pinned garments</p>
            <h3>Verify Before You Save</h3>
            <ul>${verificationSteps}</ul>
            <p class="micro-copy">${module.customerPinned.reason}</p>
          </div>
          <div class="verification-note">
            <p class="badge-lite">Script</p>
            <p>“You want this hem at <strong>29 inches</strong> right where you pinned it, correct? I’ll note <em>‘shorten inseam to 29 inches (customer pinned)’</em>.”</p>
          </div>
        </div>

        <div class="section metric-table" aria-label="Recording final measurements">
          <h3>Recording Final, Objective Measurements</h3>
          <p class="micro-copy">Use final numbers, not guesses or plus/minus shorthand.</p>
          ${recordingRows}
        </div>

        <div class="section callout-card" aria-label="Drape differences">
          <div>
            <p class="eyebrow">Fabric context</p>
            <h3>${module.drapeNotes.headline}</h3>
            <ul>${drapeBullets}</ul>
          </div>
          <div class="note-chip-row" aria-label="Drape note examples">${drapeExamples}</div>
        </div>

        <div class="section scenario-grid" aria-label="Practice scenarios for balance and drape">
          <h3>Practice Scenarios</h3>
          ${practiceScenarios}
        </div>

        <div class="section checklist-lite" aria-label="Quick checklist">
          <h3>Quick Pinning Checklist</h3>
          <ul>${quickChecklist}</ul>
        </div>

        <div class="quiz" aria-label="quiz for ${module.title}">
          <h3>Knowledge Check</h3>
          ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
          ${renderModuleNavigation(module.id)}
        </div>
        </article>
      </section>
    `;
  }

  // Module 5 custom layout focuses on exceptions, escalation triggers, and safe scripting.
  // New classes: module-five__grid, module-five__card, module-five__comparison, module-five__script, module-five__protocol,
  // module-five__note, module-five__boundary, module-five__script-grid (documented in styles.html).
  function moduleFiveTemplate(module) {
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const tailorOnlyCards = module.tailorOnlyCategories.map(category => `
      <div class="module-five__card">
        <p class="pill pill-quiet">Tailor-only</p>
        <h3>${category.title}</h3>
        <ul>${category.items.map(item => `<li>${item}</li>`).join('')}</ul>
      </div>
    `).join('');

    const comparisonCards = `
      <div class="module-five__comparison" aria-label="CSR-approved vs Tailor-only comparison">
        <div class="module-five__card success">
          <p class="pill pill-quiet">CSR-approved</p>
          <h3>CSR-Approved Examples</h3>
          <ul>${module.comparison.csrApproved.map(item => `<li>${item}</li>`).join('')}</ul>
          <p class="micro-copy">Escalate if these include complex fabrics, structure, or embellishment.</p>
        </div>
        <div class="module-five__card warning">
          <p class="pill pill-quiet">Tailor review required</p>
          <h3>Tailor-Only Examples</h3>
          <ul>${module.comparison.tailorOnly.map(item => `<li>${item}</li>`).join('')}</ul>
          <p class="micro-copy">When in doubt, choose safety and escalate.</p>
        </div>
      </div>
    `;

    const protocolSteps = module.customerPinnedProtocol.steps.map((step, idx) => `<li><strong>Step ${idx + 1}:</strong> ${step}</li>`).join('');
    const escalationList = module.escalationTriggers.map(item => `<li>${item}</li>`).join('');
    const scriptCards = module.scripts.map(script => `
      <div class="module-five__script">
        <p class="eyebrow">${script.title}</p>
        <p>“${script.line}”</p>
      </div>
    `).join('');
    const documentationList = module.documentationNotes.map(note => `<li>${note}</li>`).join('');
    const boundaryList = module.boundaryStatements.map(item => `<li>${item}</li>`).join('');
    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    const sectionId = `module-${module.id}`;
    const headingId = `${sectionId}-title`;
    return `
      <section id="${sectionId}" class="module-section main-section" aria-labelledby="${headingId}" hidden>
        <article class="module module-five" id="${module.id}">
        <span class="pill">Module ${module.id.replace('M','')}</span>
        <h2 id="${headingId}" tabindex="-1">${module.title}</h2>
        <p>${module.intro}</p>

        <div class="section">
          <h3>Learning Objectives</h3>
          <ul>${objectives}</ul>
        </div>

        <div class="section module-five__grid" aria-label="Tailor-only garments and visual guide">
          <div>
            <h3>Tailor-Only List</h3>
            <p class="micro-copy">These garments must be reviewed and pinned by the tailor—CSRs should not guess or experiment.</p>
            <div class="module-five__card-grid">${tailorOnlyCards}</div>
          </div>
          <div>
            <h3>CSR vs Tailor Visual Guide</h3>
            ${comparisonCards}
          </div>
        </div>

        <div class="section module-five__grid" aria-label="Customer pinned protocol and escalation triggers">
          <div class="module-five__protocol">
            <p class="eyebrow">Customer-Pinned Protocol</p>
            <h3>Guard Complex or Risky Garments</h3>
            <ul>${protocolSteps}</ul>
            <div class="module-five__note-line">${module.customerPinnedProtocol.reminder}</div>
          </div>
          <div class="module-five__card outline">
            <p class="eyebrow">Escalation Triggers</p>
            <h3>Stop and Involve the Tailor When…</h3>
            <ul>${escalationList}</ul>
          </div>
        </div>

        <div class="section" aria-label="Escalation scripts">
          <h3>Escalation Scripts (Customer-Facing)</h3>
          <div class="module-five__script-grid">${scriptCards}</div>
        </div>

        <div class="section module-five__grid" aria-label="Documentation and boundaries">
          <div class="module-five__note">
            <p class="eyebrow">Documenting Exceptions & Escalations</p>
            <h3>Write Notes Tailors Can Act On</h3>
            <ul>${documentationList}</ul>
            <p class="micro-copy">Mirror this language in SPOT so the tailor understands risks and customer preferences.</p>
          </div>
          <div class="module-five__boundary">
            <p class="eyebrow">Boundary Setting</p>
            <h3>Saying “No” Safely</h3>
            <ul>${boundaryList}</ul>
          </div>
        </div>

        <div class="section module-five__reminder callout">
          <p class="eyebrow">Protection First</p>
          <p>Safety and garment integrity take priority over speed. Escalate early rather than risk damage.</p>
        </div>

        <div class="quiz" aria-label="quiz for ${module.title}">
          <h3>Knowledge Check</h3>
          ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
          ${renderModuleNavigation(module.id)}
        </div>
        </article>
      </section>
    `;
  }

  function renderQuestion(moduleId, idx, q) {
    const questionNumber = idx + 1;
    const name = `module${moduleId.replace('M','')}-q${questionNumber}`;
    const options = q.options || [];
    const optionHtml = options.map(opt => {
      const value = opt.value || opt.letter || opt.label;
      return `
      <label><input type="radio" name="${name}" value="${value}"> ${opt.label}</label>
    `; }).join('');
    return `<div class="quiz-question"><strong>${questionNumber}. ${q.question}</strong><div class="quiz-options">${optionHtml}</div></div>`;
  }

  function getSelectedRadioValue(name) {
    const radios = document.querySelectorAll(`input[name="${name}"]`);
    for (let i = 0; i < radios.length; i++) {
      if (radios[i].checked) return radios[i].value;
    }
    return null;
  }

  const MODULE1_ANSWER_KEY = { q1: 'b', q2: 'b', q3: 'b', q4: 'b', q5: 'b' };
  const MODULE2_ANSWER_KEY = { q1: 'b', q2: 'b', q3: 'a', q4: 'a', q5: 'a' };
  const MODULE3_ANSWER_KEY = { q1: 'b', q2: 'b', q3: 'b', q4: 'b', q5: 'b' };
  const MODULE4_ANSWER_KEY = { q1: 'b', q2: 'b', q3: 'a', q4: 'b', q5: 'a' };
  const MODULE5_ANSWER_KEY = { q1: 'b', q2: 'b', q3: 'a', q4: 'a', q5: 'a' };

  function evaluateModuleQuiz(moduleId) {
    const answerKey = {
      M1: MODULE1_ANSWER_KEY,
      M2: MODULE2_ANSWER_KEY,
      M3: MODULE3_ANSWER_KEY,
      M4: MODULE4_ANSWER_KEY,
      M5: MODULE5_ANSWER_KEY
    }[moduleId];
    const moduleNumber = moduleId.replace('M', '');
    const namePrefix = `module${moduleNumber}`;
    let correct = 0;
    const total = Object.keys(answerKey).length;

    Object.entries(answerKey).forEach(([key, value]) => {
      const selected = getSelectedRadioValue(`${namePrefix}-${key}`);
      if (selected === value) {
        correct += 1;
      }
    });

    const score = Math.round((correct / total) * 100);
    return { score, correct, total };
  }

  function submitQuiz(moduleId) {
    const name = getEmployeeName();
    if (!name) {
      alert('Enter your employee name before submitting.');
      return;
    }
    const location = getEmployeeLocation();
    const results = evaluateModuleQuiz(moduleId);
    const passed = results.score >= 80;
    updateModuleResultText(moduleId, passed, results.score, results.correct, results.total);

    if (google.script && google.script.run) {
      google.script.run.withSuccessHandler(() => {
        showToast('Module result saved', 'success');
        loadCertificationStatus();
      }).withFailureHandler(err => {
        showToast('Error saving result. Please retry.', 'error');
        updateModuleResultText(moduleId, false, results.score, results.correct, results.total, `Error saving: ${err}`);
      }).saveModuleResult(moduleId, name, location, results.score, passed);
    }
  }

  function updateModuleResultText(moduleId, passed, score, correct, total, errorText) {
    const el = document.getElementById(`${moduleId}-result`);
    if (!el) return;
    if (errorText) {
      el.textContent = errorText;
      el.style.color = '#991b1b';
      return;
    }
    el.textContent = `${passed ? 'PASS' : 'Review content and retry'} — ${correct}/${total} correct (${score}%).`;
    el.style.color = passed ? '#0f5132' : '#991b1b';
  }

  function loadCertificationStatus() {
    const name = getEmployeeName();
    if (!name) return;
    if (google.script && google.script.run) {
      google.script.run.withSuccessHandler(renderCertificationStatus).getEmployeeCertificationStatus(name);
    }
  }

  function fetchCertificationStatusByName(name) {
    if (!google.script || !google.script.run) {
      return Promise.resolve(lastCertificationStatus);
    }

    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(status => {
          lastCertificationStatus = status;
          resolve(status);
        })
        .withFailureHandler(err => reject(err))
        .getEmployeeCertificationStatus(name);
    });
  }

  function renderCertificationStatus(status) {
    lastCertificationStatus = status;
    const badge = document.getElementById('certBadge');
    const title = document.getElementById('certStatus');
    const sub = document.getElementById('certSubstatus');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const moduleProgress = document.getElementById('moduleProgress');
    const moduleList = document.getElementById('module-status-list');
    if (!status) return;

    const completed = status.completedModules || [];
    const missing = status.missingModules || [];
    const percent = Math.round((completed.length / modules.length) * 100);
    updateCertificateButtonState(status);
    progressFill.style.width = `${percent}%`;
    const remainingMinutes = calculateRemainingMinutes(missing);
    const remainingDisplay = formatMinutes(remainingMinutes);
    if (progressText) {
      progressText.textContent = `${completed.length} / ${modules.length} modules complete • Estimated ${remainingDisplay} to finish`;
    }
    updateTimeEstimates(missing);

    if (status.isCertified) {
      badge.textContent = 'Certified Alteration Pinner';
      badge.style.background = '#e8f8f2';
      badge.style.color = '#0f5132';
      title.textContent = '🎓 Certified Alteration Pinner';
      sub.textContent = 'All five modules passed. Print your certificate for records.';
    } else {
      badge.textContent = `${completed.length}/5 Modules Passed`;
      badge.style.background = '#fff8e1';
      badge.style.color = '#8a6b00';
      title.textContent = 'Modules remaining: ' + (missing.length ? missing.join(', ') : '—');
      sub.textContent = 'Pass each module quiz to reach certification. Supervisor sign-off required for live pinning clearance.';
    }

    moduleProgress.innerHTML = modules.map(mod => {
      const isDone = completed.includes(mod.id);
      return `<div class="module-chip ${isDone ? 'pass' : ''}">
        <p class="title">${mod.id} — ${mod.title}</p>
        <p class="status">${isDone ? 'Passed' : 'Pending'}</p>
      </div>`;
    }).join('');

    if (moduleList) {
      moduleList.innerHTML = modules.map(mod => {
        const isDone = completed.includes(mod.id);
        return `<li class="module-status-item ${isDone ? 'status-complete' : 'status-missing'}">${mod.title} — ${isDone ? 'Completed ✅' : 'Not completed ❌'}</li>`;
      }).join('');
    }
  }

  function navigateToSection(sectionId, trigger) {
    const sections = document.querySelectorAll('.main-section');
    sections.forEach(section => {
      if (section.id === sectionId || (sectionId.startsWith('module-') && (section.id === 'modules' || section.id === sectionId))) {
        section.hidden = false;
      } else {
        section.hidden = true;
      }
    });

    if (sectionId.startsWith('module-')) {
      const targetModule = document.getElementById(sectionId);
      if (targetModule) {
        targetModule.hidden = false;
        document.getElementById('modules')?.removeAttribute('hidden');
        const heading = document.getElementById(`${sectionId}-title`);
        heading?.focus();
      }
    } else if (sectionId === 'dashboard') {
      document.getElementById('certStatus')?.focus();
    }

    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
      const isActive = item.dataset.target === sectionId;
      item.classList.toggle('active', isActive);
      if (isActive) {
        item.setAttribute('aria-current', 'page');
      } else {
        item.removeAttribute('aria-current');
      }
    });

    if (trigger && typeof trigger.blur === 'function') {
      trigger.blur();
    }
  }

  function scrollToStatus() {
    navigateToSection('dashboard');
  }

  function handlePrintCertificate() {
    const name = getEmployeeName();
    if (!name) {
      showToast('Enter employee name before generating a certificate.', 'error');
      document.getElementById('employeeName')?.focus();
      return;
    }

    const location = getEmployeeLocation();
    const printButton = document.getElementById('print-certificate-button');
    const originalLabel = printButton ? printButton.textContent : '';

    if (!google.script || !google.script.run) {
      showToast('Certificate creation is only available when running in Google Apps Script.', 'error');
      return;
    }

    const setLoadingState = isLoading => {
      if (!printButton) return;
      if (isLoading) {
        printButton.setAttribute('disabled', 'disabled');
        printButton.textContent = 'Generating…';
      } else {
        printButton.textContent = originalLabel || 'Generate Certificate (PDF)';
        updateCertificateButtonState(lastCertificationStatus);
      }
    };

    fetchCertificationStatusByName(name)
      .then(status => {
        lastCertificationStatus = status;
        updateCertificateButtonState(status);
        if (!status || !status.isCertified) {
          showToast('Pass all five modules before generating a certificate.', 'error');
          return null;
        }

        setLoadingState(true);
        showToast('Generating your certificate from the Dublin Cleaners template…', 'info');

        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .generateCertificatePDF(name, location);
        });
      })
      .then(result => {
        if (!result) return;
        setLoadingState(false);

        if (result?.pdfFileUrl) {
          showToast('Certificate generated and saved to Drive. Opening PDF…', 'success');
          window.open(result.pdfFileUrl, '_blank', 'noopener');
        } else {
          showToast('Certificate generated, but no PDF link was returned.', 'info');
        }

        if (result && result.isCertified === false) {
          showToast('Note: This employee is not fully certified according to records.', 'warning');
        }
      })
      .catch(err => {
        setLoadingState(false);
        const message = err && err.message ? err.message : 'Could not create certificate. Please try again.';
        showToast(message, 'error');
      });
  }

  function setupPrintCertificateButton() {
    const btn = document.getElementById('print-certificate-button');
    if (btn) {
      btn.addEventListener('click', handlePrintCertificate);
    }
  }

  function bindIdentityPersistence() {
    const nameInput = document.getElementById('employeeName');
    const locationInput = document.getElementById('employeeLocation');
    nameInput?.addEventListener('input', () => persistIdentity());
    locationInput?.addEventListener('input', () => persistIdentity());
  }

  function persistIdentity() {
    try {
      localStorage.setItem('dublinCertEmployeeName', getEmployeeName());
      localStorage.setItem('dublinCertEmployeeLocation', getEmployeeLocation());
    } catch (err) {
      console.log('Local storage unavailable', err);
    }
  }

  function restoreIdentityFromStorage() {
    try {
      const name = localStorage.getItem('dublinCertEmployeeName');
      const location = localStorage.getItem('dublinCertEmployeeLocation');
      if (name) {
        document.getElementById('employeeName').value = name;
      }
      if (location) {
        document.getElementById('employeeLocation').value = location;
      }
      if (name) {
        loadCertificationStatus();
      }
    } catch (err) {
      console.log('Local storage unavailable', err);
    }
  }

  function showToast(message, type = 'info') {
    const toast = document.getElementById('global-toast');
    if (!toast) return;
    toast.textContent = message;
    toast.className = `toast toast--${type}`;
    toast.style.opacity = '1';
    setTimeout(() => {
      toast.style.opacity = '0';
    }, 3200);
  }

</script>
