<script>
  const modules = [
    {
      id: 'M1',
      title: 'Customer Instruction & Measurement Philosophy',
      intro: 'Teach customers and CSRs to speak in objective, final measurements so tailors deliver the exact outcome.',
      objectives: [
        'Differentiate subjective vs. objective notes and always capture final measurements.',
        'Replace +/- shorthand with statements like â€œshorten inseam to 30 inches.â€',
        'Clarify that â€œhemâ€ is a garment part, not a measurement or verb.',
        'Prevent complaints by repeating back exact measurements before logging.'
      ],
      sections: [
        {
          title: 'Overview & Vocabulary',
          bullets: [
            'Objective notes remove guesswork: âœ… â€œShorten inseam to 30 inches.â€',
            'Subjective notes cause rework: âŒ â€œHem 2 inches,â€ â€œShorten a bit.â€',
            'Standard phrasing: â€œINSEAM 32â€ instantly conveys how to measure.'
          ]
        },
        {
          title: 'Examples & Callouts',
          bullets: [
            'Complaint prevention: vague requests like â€œfix the hemâ€ lead to re-dos.',
            'Sample form notes: garment + part + final measurement + balance check.',
            'Repeat-back script: â€œIâ€™ll note â€˜shorten inseam to 30 inches.â€™ Is that right?â€'
          ]
        },
        {
          title: 'Visual Description',
          bullets: [
            'Diagram: side-by-side note cards labeled â€œGood: inseam 30â€ vs â€œBad: -2 hem.â€',
            'Highlight â€œhemâ€ as the folded sewn edge, not a number.'
          ]
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which is an objective alteration note?', options: [
          { label: 'Hem 2 inches', correct: false },
          { label: 'Shorten inseam to 30 inches', correct: true },
          { label: 'Take in slightly', correct: false }
        ]},
        { type: 'tf', question: 'â€œHem 2 inchesâ€ is a clear, objective instruction.', answer: false },
        { type: 'mcq', question: 'Best rewrite for â€œshorten a bitâ€?', options: [
          { label: 'Shorten inseam to 29 inches', correct: true },
          { label: 'Shorten slightly', correct: false },
          { label: 'Leave it to the tailor', correct: false }
        ]},
        { type: 'short', question: 'What measurement style should you record?', answers: ['final objective measurement', 'objective measurement', 'final measurement'] },
        { type: 'mcq', question: 'Why avoid +/- shorthand?', options: [
          { label: 'Tailors enjoy guessing', correct: false },
          { label: 'It hides the final desired length', correct: true },
          { label: 'It is faster for data entry', correct: false }
        ]}
      ]
    },
    {
      id: 'M2',
      title: 'Pinning Tools & Safety',
      intro: 'Choose the right pins and orient them safely to protect people, garments, and machinery.',
      objectives: [
        'Use safety pins for any garment traveling to the plant.',
        'Pin horizontally, parallel to the floor, for accuracy and grip.',
        'Apply pin safety checklist to avoid injury or fabric damage.'
      ],
      sections: [
        {
          title: 'Tools & Rules',
          bullets: [
            'Differentiate straight pins vs. safety pins; plant-bound garments require safety pins.',
            'Orientation rule: pins run horizontally; vertical pins distort hems and slip.',
            'Checklist: count pins, avoid sharp ends sticking out, never pin through skin.'
          ]
        },
        {
          title: 'Visual Description',
          bullets: [
            'Text diagram: horizontal pin aligned with hem edge vs. vertical â€œnailâ€ causing puckers.',
            'Graphic callout: closed safety pin icon beside â€œPlant Travel Approved.â€'
          ]
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which pin is required for plant-bound garments?', options: [
          { label: 'Straight dressmaker pin', correct: false },
          { label: 'Safety pin, closed', correct: true },
          { label: 'No pin, just fold', correct: false }
        ]},
        { type: 'tf', question: 'Vertical pinning is preferred because it is faster.', answer: false },
        { type: 'mcq', question: 'Best orientation when pinning a hem?', options: [
          { label: 'Horizontal, parallel to floor', correct: true },
          { label: 'Vertical like a nail', correct: false },
          { label: 'Diagonal for style', correct: false }
        ]},
        { type: 'mcq', question: 'What should you check before sending to the plant?', options: [
          { label: 'Pins are closed and horizontal', correct: true },
          { label: 'Pins are vertical to save time', correct: false },
          { label: 'No pins used at all', correct: false }
        ]},
        { type: 'short', question: 'Name one step from the pin safety checklist.', answers: ['check pin count', 'avoid sharp ends', 'avoid sharp ends sticking out', 'do not pin through skin'] }
      ]
    },
    {
      id: 'M3',
      title: 'Pinning by Garment Type',
      intro: 'Apply garment-specific pinning with smooth fabric, balanced measurements, and verified customer pins.',
      objectives: [
        'Smooth fabric before measuringâ€”never stretch.',
        'Ask handedness to balance menâ€™s inseams.',
        'Verify customer-pinned garments with a tape measure and record objective numbers.',
        'Enforce one patch per garment and pin placement clarity.'
      ],
      sections: [
        {
          title: 'Garment Guidance',
          bullets: [
            'Pants: smooth both legs, measure inseam, pin horizontally at hem and knee if needed.',
            'Skirts/Dresses: check hang, pin hem evenly, avoid pulling bias fabrics.',
            'Jackets: pin sleeve length at wrist bone; note lining if present.'
          ]
        },
        {
          title: 'Customer Fit & Patches',
          bullets: [
            'Ask â€œAre you left- or right-handed? This helps us balance your inseam.â€',
            'If customer pins at home: bring tape measure, verify final length, repin with safety pins.',
            'Patch protocol: pin each patch to its garment; never bulk-send loose patches.'
          ]
        },
        {
          title: 'Visual Description',
          bullets: [
            'Side-by-side: smoothed pant leg with horizontal pins vs. stretched fabric with diagonal pins.',
            'Patch placement card taped to garment with arrow to pinned patch location.'
          ]
        }
      ],
      quiz: [
        { type: 'mcq', question: 'What must you do with a customer-pinned garment?', options: [
          { label: 'Trust the pinning and skip measuring', correct: false },
          { label: 'Verify with a tape measure and note final length', correct: true },
          { label: 'Remove all pins and guess', correct: false }
        ]},
        { type: 'mcq', question: 'How do you balance inseams for men?', options: [
          { label: 'Ask handedness and measure both sides', correct: true },
          { label: 'Pin only the right leg', correct: false },
          { label: 'Use vertical pins on the long leg', correct: false }
        ]},
        { type: 'tf', question: 'Stretching fabric while measuring improves accuracy.', answer: false },
        { type: 'mcq', question: 'Patch handling rule:', options: [
          { label: 'Send patches loose; tailor will sort', correct: false },
          { label: 'Pin each patch to its correct garment', correct: true },
          { label: 'Tape all patches together', correct: false }
        ]},
        { type: 'short', question: 'Where should pins sit on hems?', answers: ['horizontally', 'horizontal', 'parallel to the floor'] }
      ]
    },
    {
      id: 'M4',
      title: 'SPOT POS Notes & Communication',
      intro: 'Document clear alteration notes in SPOT and confirm them with customers.',
      objectives: [
        'Log final measurements, not vague verbs.',
        'Avoid misusing â€œhemâ€ as a measurement term.',
        'Use confirmation scripts to align expectations.'
      ],
      sections: [
        {
          title: 'SPOT Input Examples',
          bullets: [
            'âœ… â€œShorten inseam to 30 inches.â€',
            'âœ… â€œTake in waist to 34 inches.â€',
            'âŒ â€œHem pants.â€  âŒ â€œTake in 2 inches.â€'
          ]
        },
        {
          title: 'Communication Scripts',
          bullets: [
            'â€œTo make sure we get this right, Iâ€™m writing â€˜shorten inseam to 30 inches.â€™ Does that match what you expect?â€',
            'â€œBecause hem is the finished edge, Iâ€™ll note the final length instead.â€',
            'Text mockup: SPOT note field showing garment part, final measurement, and safety pin confirmation.'
          ]
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which SPOT note is correct?', options: [
          { label: 'Hem pants', correct: false },
          { label: 'Shorten inseam to 30 inches, safety pinned', correct: true },
          { label: 'Take in 2 inches', correct: false }
        ]},
        { type: 'tf', question: 'â€œHem to 36 inchesâ€ is acceptable SPOT language.', answer: false },
        { type: 'mcq', question: 'Best rewrite for â€œtake in a bitâ€?', options: [
          { label: 'Take in waist to 34 inches', correct: true },
          { label: 'Take in slightly', correct: false },
          { label: 'Adjust if needed', correct: false }
        ]},
        { type: 'short', question: 'What must every note include?', answers: ['final measurement', 'objective measurement', 'final measurement in inches'] },
        { type: 'mcq', question: 'Why avoid using â€œhemâ€ as a verb?', options: [
          { label: 'It confuses the final measurement', correct: true },
          { label: 'Customers dislike the word', correct: false },
          { label: 'It takes too long to type', correct: false }
        ]}
      ]
    },
    {
      id: 'M5',
      title: 'Exceptions & Escalation',
      intro: 'Recognize tailor-only garments and escalate with respectful, confident language.',
      objectives: [
        'Spot garments CSRs should not pin (delicate, complex, high-risk items).',
        'Use escalation scripts that reassure customers.',
        'Keep patches and special items paired to the correct garment.'
      ],
      sections: [
        {
          title: 'Tailor-Only List',
          bullets: [
            'Extremely delicate fabrics or intricate beading.',
            'Complex gowns or wedding dresses.',
            'Expensive specialty items with high risk.'
          ]
        },
        {
          title: 'Escalation Scripts',
          bullets: [
            'â€œThis type of garment is handled directly by our tailor to ensure the best result. Iâ€™ll note your request and have them review it.â€',
            'â€œBecause of the beading/lace, our tailor will determine the safest way to pin and sew this area.â€',
            'Visual description: two-column card showing CSR-safe garments vs. tailor-only garments.'
          ]
        },
        {
          title: 'Customer-Pinned Protocol',
          bullets: [
            'Do not alter customer pinning without consultation when item is high-risk.',
            'If unsure, escalate to tailor and log the request clearly.',
            'One patch per garment; escalate if multiple complex patches are requested.'
          ]
        }
      ],
      quiz: [
        { type: 'mcq', question: 'Which garment should you NOT pin as a CSR?', options: [
          { label: 'Standard cotton chinos', correct: false },
          { label: 'Intricate beaded gown', correct: true },
          { label: 'Uniform pants', correct: false }
        ]},
        { type: 'mcq', question: 'Best escalation phrase:', options: [
          { label: 'We canâ€™t do this.', correct: false },
          { label: 'This needs a tailor fitting; letâ€™s book a time to get it right.', correct: true },
          { label: 'Maybe we try it anyway.', correct: false }
        ]},
        { type: 'tf', question: 'It is okay to pin an intricate beaded gown if you feel confident.', answer: false },
        { type: 'short', question: 'How should patches be handled?', answers: ['pin each patch to its garment', 'one patch per garment', 'pin patch to garment'] },
        { type: 'mcq', question: 'When in doubt about scope, you shouldâ€¦', options: [
          { label: 'Proceed quickly', correct: false },
          { label: 'Escalate to a tailor and document clearly', correct: true },
          { label: 'Ignore the concern', correct: false }
        ]}
      ]
    }
  ];

  document.addEventListener('DOMContentLoaded', () => {
    renderNavigation();
    renderModules();
    loadCertificationStatus();
  });

  function getEmployeeName() {
    return document.getElementById('employeeName').value.trim();
  }

  function getEmployeeLocation() {
    return document.getElementById('employeeLocation').value.trim();
  }

  function renderNavigation() {
    const navList = document.getElementById('navList');
    navList.innerHTML = modules.map(module => `<li><button onclick="scrollToModule('${module.id}')">${module.id} â€” ${module.title}</button></li>`).join('');
  }

  function renderModules() {
    const container = document.getElementById('moduleContainer');
    container.innerHTML = modules.map(module => moduleTemplate(module)).join('');
  }

  function moduleTemplate(module) {
    const objectives = module.objectives.map(item => `<li>${item}</li>`).join('');
    const sections = module.sections.map(section => `
      <div class="section">
        <h3>${section.title}</h3>
        <ul>${section.bullets.map(b => `<li>${b}</li>`).join('')}</ul>
      </div>`).join('');
    const quiz = module.quiz.map((q, idx) => renderQuestion(module.id, idx, q)).join('');

    return `
      <article class="module" id="${module.id}">
        <span class="pill">Module ${module.id.replace('M','')}</span>
        <h2>${module.title}</h2>
        <p>${module.intro}</p>
        <div class="section">
          <h3>Learning Objectives</h3>
          <ul>${objectives}</ul>
        </div>
        ${sections}
        <div class="section callout">
          <strong>Visual/Diagram Descriptions:</strong>
          <ul>${module.sections.map(s => s.bullets.find(b => b.toLowerCase().includes('diagram') || b.toLowerCase().includes('visual'))).filter(Boolean).map(item => `<li>${item}</li>`).join('') || '<li>See notes above.</li>'}</ul>
        </div>
        <div class="quiz" aria-label="quiz for ${module.title}">
          <h3>Knowledge Check</h3>
          ${quiz}
          <div class="quiz-footer">
            <button class="primary" onclick="submitQuiz('${module.id}')">Submit Quiz</button>
            <div class="status-text" id="${module.id}-result">Score a minimum of 80% to pass.</div>
          </div>
        </div>
      </article>
    `;
  }

  function renderQuestion(moduleId, idx, q) {
    const name = `${moduleId}-q${idx}`;
    if (q.type === 'short') {
      return `<div class="quiz-question"><strong>${q.question}</strong><input type="text" name="${name}" placeholder="Type your answer" /></div>`;
    }
    const options = q.options || [{ label: 'True', correct: q.answer === true }, { label: 'False', correct: q.answer === false }];
    const optionHtml = options.map((opt, oi) => `
      <label><input type="radio" name="${name}" value="${oi}"> ${opt.label}</label>
    `).join('');
    return `<div class="quiz-question"><strong>${q.question}</strong><div class="quiz-options">${optionHtml}</div></div>`;
  }

  function submitQuiz(moduleId) {
    const module = modules.find(m => m.id === moduleId);
    const name = getEmployeeName();
    if (!name) {
      alert('Enter your employee name before submitting.');
      return;
    }
    const location = getEmployeeLocation();
    let correct = 0;

    module.quiz.forEach((q, idx) => {
      const fieldName = `${moduleId}-q${idx}`;
      if (q.type === 'short') {
        const value = (document.querySelector(`input[name="${fieldName}"]`)?.value || '').trim().toLowerCase();
        if (q.answers.some(ans => value === ans.toLowerCase())) {
          correct += 1;
        }
      } else {
        const selected = document.querySelector(`input[name="${fieldName}"]:checked`);
        if (selected) {
          const option = (q.options || [{ label: 'True', correct: q.answer === true }, { label: 'False', correct: q.answer === false }])[Number(selected.value)];
          if (option && option.correct) {
            correct += 1;
          }
        }
      }
    });

    const score = Math.round((correct / module.quiz.length) * 100);
    const passed = score >= 80;
    updateModuleResultText(moduleId, passed, score, correct, module.quiz.length);

    if (google.script && google.script.run) {
      google.script.run.withSuccessHandler(() => {
        loadCertificationStatus();
      }).withFailureHandler(err => {
        updateModuleResultText(moduleId, false, score, correct, module.quiz.length, `Error saving: ${err}`);
      }).saveModuleResult(moduleId, name, location, score, passed);
    }
  }

  function updateModuleResultText(moduleId, passed, score, correct, total, errorText) {
    const el = document.getElementById(`${moduleId}-result`);
    if (!el) return;
    if (errorText) {
      el.textContent = errorText;
      el.style.color = '#991b1b';
      return;
    }
    el.textContent = `${passed ? 'PASS' : 'Review content and retry'} â€” ${correct}/${total} correct (${score}%).`;
    el.style.color = passed ? '#0f5132' : '#991b1b';
  }

  function loadCertificationStatus() {
    const name = getEmployeeName();
    if (!name) return;
    if (google.script && google.script.run) {
      google.script.run.withSuccessHandler(renderCertificationStatus).getEmployeeCertificationStatus(name);
    }
  }

  function renderCertificationStatus(status) {
    const badge = document.getElementById('certBadge');
    const title = document.getElementById('certStatus');
    const sub = document.getElementById('certSubstatus');
    const progressFill = document.getElementById('progressFill');
    const moduleProgress = document.getElementById('moduleProgress');
    if (!status) return;

    const completed = status.completedModules || [];
    const missing = status.missingModules || [];
    const percent = Math.round((completed.length / modules.length) * 100);
    progressFill.style.width = `${percent}%`;

    if (status.isCertified) {
      badge.textContent = 'Certified Alteration Pinner';
      badge.style.background = '#e8f8f2';
      badge.style.color = '#0f5132';
      title.textContent = 'ðŸŽ“ Certified Alteration Pinner';
      sub.textContent = 'All five modules passed. Print your certificate for records.';
    } else {
      badge.textContent = `${completed.length}/5 Modules Passed`;
      badge.style.background = '#fff8e1';
      badge.style.color = '#8a6b00';
      title.textContent = 'Modules remaining: ' + (missing.length ? missing.join(', ') : 'â€”');
      sub.textContent = 'Pass each module quiz to reach certification. Supervisor sign-off required for live pinning clearance.';
    }

    moduleProgress.innerHTML = modules.map(mod => {
      const isDone = completed.includes(mod.id);
      return `<div class="module-chip ${isDone ? 'pass' : ''}">
        <p class="title">${mod.id} â€” ${mod.title}</p>
        <p class="status">${isDone ? 'Passed' : 'Pending'}</p>
      </div>`;
    }).join('');
  }

  function scrollToModule(id) {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: 'smooth' });
  }

  function scrollToStatus() {
    const el = document.getElementById('statusPanel');
    if (el) el.scrollIntoView({ behavior: 'smooth' });
  }

  function openPrintCertificate() {
    const name = getEmployeeName();
    const location = getEmployeeLocation();
    const url = `print.html?name=${encodeURIComponent(name || '')}&location=${encodeURIComponent(location || '')}`;
    window.open(url, '_blank');
  }
</script>
